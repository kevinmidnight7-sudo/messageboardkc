<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Events Discord Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      background: transparent !important;
      margin: 0; padding: 0;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
    }
    body {
      display: flex; align-items: center; justify-content: center; min-height: 100vh;
    }
    .discord-leaderboard {
      width: 1160px; max-width: 98vw;
      border-radius: 22px;
      background: rgba(24,29,39,0.98);
      box-shadow: 0 2px 26px #0c102522, 0 2px 14px #7ab9fa22;
      padding: 36px 18px 32px 18px;
      display: flex; flex-direction: row;
      gap: 20px;
      justify-content: space-between;
    }
    .lb-col {
      flex: 1 1 0; min-width: 0;
      display: flex; flex-direction: column; align-items: stretch;
      gap: 13px;
    }
    .lb-header {
      font-weight: 700;
      font-size: 1.13em;
      color: #fff;
      letter-spacing: 0.03em;
      margin-bottom: 10px;
      display: flex; align-items: center; gap: 9px;
      text-shadow: 0 1.5px 8px #7eebfa25;
    }
    .lb-header .header-ic {
      font-size: 1.28em;
      margin-right: 5px;
      filter: drop-shadow(0 2px 7px #41fae433);
    }
    .lb-scroll-area {
      max-height: 247px;
      overflow-y: auto;
      padding-right: 5px;
      position: relative;
    }
    .lb-scroll-area::-webkit-scrollbar {
      width: 8px;
      background: transparent;
    }
    .lb-scroll-area::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #40e0ff60 0%, #2b304f88 100%);
      border-radius: 7px;
    }
    .lb-row {
      display: flex; align-items: center;
      background: linear-gradient(90deg,#232a3a 88%,#1e2633 100%);
      padding: 9px 13px 9px 9px;
      border-radius: 12px;
      margin-bottom: 0.5em;
      box-shadow: 0 1.5px 10px #333d4a09;
      min-height: 44px;
      transition: background .17s;
      position: relative;
    }
    .lb-row.top1 { background: linear-gradient(90deg,#40337a 92%,#2ea9b7 120%);}
    .lb-row.top2 { background: linear-gradient(90deg,#33497a 90%,#4e7ad1 120%);}
    .lb-row.top3 { background: linear-gradient(90deg,#275e78 90%,#39a19b 120%);}
    .lb-avatar {
      width: 34px; height: 34px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
      background: linear-gradient(135deg,#384374,#2ea9b7 70%);
      box-shadow: 0 1px 4px #9ccffd50;
      display: flex; align-items: center; justify-content: center;
      color: #fff; font-size: 1.23em; font-weight: 700;
      text-transform: uppercase;
      user-select: none;
      border: 2px solid #212c40;
      flex-shrink: 0;
    }
    .lb-icon {
      font-size: 1.14em; margin-right: 5px;
      margin-left: 0;
    }
    .lb-user {
      color: #d0f6ff; font-weight: 600; font-size: 1.07em; flex: 1 1 0;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      letter-spacing: 0.01em;
      display: flex; align-items: center;
      cursor: pointer;
      position: relative;
    }
    .lb-user .tooltip {
        visibility: hidden;
        width: 120px;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px 0;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -60px;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .lb-user:hover .tooltip {
        visibility: visible;
        opacity: 1;
    }
    .lb-count, .lb-badgecount {
      font-weight: 800; font-size: 1.03em; color: #faf0bd;
      background: #2ea9b7; padding: 3px 15px; border-radius: 12px;
      margin-left: 10px;
      box-shadow: 0 1px 4px #00ffd98f;
    }
    .lb-badgecount { background: #fde34c; color: #392f17; }
    .lb-row:last-child { margin-bottom: 0; }
    
    /* ===== USER POPUP STYLES (from messages.html) ===== */
    #userPopup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      font-family: 'Poppins', sans-serif;
      animation: fadeInBg 0.3s ease;
    }
    @keyframes fadeInBg { from { opacity: 0; } to { opacity: 1; } }

    .user-popup-card {
      width: 360px;
      max-width: 95vw;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: zoomIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
      position: relative;
      background: #f1f3f5;
    }
    @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .popup-banner {
      height: 120px;
      background-color: #ced4da;
      background-size: cover;
      background-position: center;
    }

    .popup-header {
      padding: 0 16px;
      position: relative;
      height: 48px;
    }

    .popup-avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
      position: absolute;
      top: -48px;
      left: 16px;
      border: 6px solid;
      background-color: #f1f3f5;
    }

    .popup-body {
      padding: 12px 16px 16px;
      margin-top: 48px;
    }

    .popup-username {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      text-align: left;
      margin-bottom: 16px;
    }

    .popup-section {
      background: rgba(255,255,255,0.5);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .popup-section:last-child {
      margin-bottom: 0;
    }

    .popup-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0 0 8px 0;
      text-align: left;
    }

    .popup-about-me {
      font-size: 0.95rem;
      color: #374151;
      line-height: 1.5;
      word-break: break-word;
      text-align: left;
      white-space: pre-wrap;
    }

    .popup-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .popup-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
      background: #6b7280;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
     .popup-badge img, .popup-badge .emoji-icon {
      width: 20px;
      height: 20px;
      font-size: 1.2rem;
    }

    .user-streak {
      font-size: 1rem;
      font-weight: 600;
      color: #d9480f;
    }

    .popup-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 5;
    }
    .popup-close-btn:hover {
      background: rgba(0,0,0,0.5);
    }
    
    @media (max-width: 900px) {
      .discord-leaderboard { flex-direction: column; width: 99vw; padding: 24px 6px;}
      .lb-scroll-area {max-height: 168px;}
    }
  </style>
</head>
<body>
  <div class="discord-leaderboard">
    <!-- Registered Members -->
    <div class="lb-col" id="members-col">
      <div class="lb-header"><span class="header-ic">üë•</span>Members</div>
      <div class="lb-scroll-area" id="lb-members"></div>
    </div>
    <!-- Highest Streaks -->
    <div class="lb-col" id="streaks-col">
      <div class="lb-header"><span class="header-ic">üî•</span>Streaks</div>
      <div class="lb-scroll-area" id="lb-streaks"></div>
    </div>
    <!-- Most Badges -->
    <div class="lb-col" id="badges-col">
      <div class="lb-header"><span class="header-ic">üèÖ</span>Badges</div>
      <div class="lb-scroll-area" id="lb-badges"></div>
    </div>
  </div>

  <!-- USER PROFILE POPUP (from messages.html) -->
  <div id="userPopup">
    <div class="user-popup-card" id="userPopupCard">
        <div class="popup-banner" id="popupBanner"></div>
        <div class="popup-header">
            <img id="popupAvatar" src="" class="popup-avatar">
            <button id="closeUserPopup" class="popup-close-btn">&times;</button>
        </div>
        <div class="popup-body">
            <div id="popupUserName" class="popup-username"></div>
            <div class="popup-section">
                <h4 class="popup-section-title">ABOUT ME</h4>
                <div id="popupAboutMe" class="popup-about-me"></div>
            </div>
            <div class="popup-section">
                <h4 class="popup-section-title">BADGES</h4>
                <div id="popupBadges" class="popup-badges"></div>
            </div>
             <div class="popup-section">
                <h4 class="popup-section-title">STREAK</h4>
                 <div id="popupStreak" class="user-streak"></div>
            </div>
        </div>
    </div>
  </div>

  <script>
    // Firebase setup
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const db = firebase.database();

    // Avatar: from users/{uid}/avatar
    function getAvatarUrl(user) {
      return user.avatar || 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
    }
    
    // --- POPUP LOGIC ---
    const userPopup = document.getElementById('userPopup');
    const closeUserPopup = document.getElementById('closeUserPopup');
    
    function showUserPopup(uid) {
        loadUserProfile(uid);
        userPopup.style.display = 'flex';
    }

    closeUserPopup.onclick = () => {
        userPopup.style.display = 'none';
    };
    
    userPopup.onclick = (e) => {
        if (e.target === userPopup) {
            userPopup.style.display = 'none';
        }
    };

    function loadUserProfile(uid) {
      const popupCard = document.getElementById('userPopupCard');
      const bannerEl = document.getElementById('popupBanner');
      const avatarEl = document.getElementById('popupAvatar');
      const usernameEl = document.getElementById('popupUserName');
      const aboutEl = document.getElementById('popupAboutMe');
      const badgesContainer = document.getElementById('popupBadges');
      const streakEl = document.getElementById('popupStreak');

      // Reset to loading state
      popupCard.style.background = '#f1f3f5';
      bannerEl.style.backgroundImage = 'none';
      bannerEl.style.backgroundColor = '#ced4da';
      avatarEl.src = 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
      usernameEl.textContent = 'Loading...';
      aboutEl.textContent = 'Loading...';
      badgesContainer.innerHTML = 'Loading...';
      streakEl.style.display = 'none';

      // Fetch all user data
      db.ref(`users/${uid}`).once('value').then(snap => {
          const userData = snap.val() || {};
          
          usernameEl.textContent = userData.displayName || 'Anonymous User';
          avatarEl.src = userData.avatar || 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
          aboutEl.textContent = userData.aboutMe || 'No "About Me" has been set.';

          if (userData.loginStreak > 0) {
              streakEl.textContent = `üî• ${userData.loginStreak} Day Streak`;
              streakEl.style.display = 'block';
          } else {
              streakEl.style.display = 'none';
          }

          const custom = userData.profileCustomization || {};
          const defaultBg = '#f1f3f5';
          const cardBg = custom.gradient || defaultBg;
          
          popupCard.style.background = cardBg;
          avatarEl.style.borderColor = cardBg;
          usernameEl.style.color = custom.nameColor || '#111827';

          if (custom.banner) {
              bannerEl.style.backgroundImage = `url('${custom.banner}')`;
              bannerEl.style.backgroundColor = 'transparent';
          } else {
              bannerEl.style.backgroundImage = 'none';
              bannerEl.style.backgroundColor = '#ced4da';
          }

          // Fetch badge data
          Promise.all([
              db.ref(`badges/${uid}`).once('value'),
              db.ref(`users/${uid}/customBadges`).once('value')
          ]).then(([bsnap, csnap]) => {
              badgesContainer.innerHTML = '';
              let hasAnyBadge = false;
              
              const badgeSpecs = {
                  verified: { label: 'Verified', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/verified.png', bg: '#2dd4bf' },
                  offence: { label: 'Best Offence', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/red.png', bg: '#ff6b6b' },
                  defence: { label: 'Best Defence', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png', bg: '#74c0fc' },
                  overall: { label: 'Overall Winner', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png', bg: '#f9c74f' }
              };

              const addBadge = (spec, text) => {
                hasAnyBadge = true;
                const div = document.createElement('div');
                div.className = 'popup-badge';
                div.style.background = spec.bg;
                div.innerHTML = `<img src="${spec.icon}"><span>${text}</span>`;
                badgesContainer.appendChild(div);
              }

              if (userData.verified) {
                  addBadge(badgeSpecs.verified, 'Verified');
              }

              const baseBadges = bsnap.val() || {};
              ['offence', 'defence', 'overall'].forEach(key => {
                  if (baseBadges[key] > 0) {
                      addBadge(badgeSpecs[key], `${badgeSpecs[key].label} x${baseBadges[key]}`);
                  }
              });

              const customBadges = csnap.val() || {};
              Object.values(customBadges).forEach(badge => {
                  hasAnyBadge = true;
                  const div = document.createElement('div');
                  div.className = 'popup-badge';
                  div.style.background = badge.grad1 || '#6b7280';
                  div.style.color = badge.textColor || 'white';
                  div.innerHTML = `<span class="emoji-icon">${badge.icon}</span><span>${badge.name}</span>`;
                  badgesContainer.appendChild(div);
              });

              if (!hasAnyBadge) {
                  badgesContainer.textContent = 'No badges to display.';
              }
          });
      }).catch(error => {
          console.error("Error loading user profile:", error);
          usernameEl.textContent = 'Error loading profile';
      });
    }

    // --- LEADERBOARD LOGIC ---
    
    function attachClickListeners() {
        document.querySelectorAll('.lb-user').forEach(el => {
            el.onclick = () => {
                const uid = el.dataset.uid;
                if (uid) {
                    showUserPopup(uid);
                }
            };
        });
    }

    // Members (alphabetical)
    const lbMembers = document.getElementById('lb-members');
    db.ref('users').once('value').then(snapshot => {
      let arr = [];
      snapshot.forEach(child => {
        const data = child.val();
        arr.push({
          uid: child.key,
          name: data.displayName || data.email || child.key,
          avatar: getAvatarUrl(data)
        });
      });
      arr.sort((a, b) => a.name.localeCompare(b.name));
      lbMembers.innerHTML = arr.map((u, i) => `
        <div class="lb-row top${i<3?i+1:''}">
          <img class="lb-avatar" src="${u.avatar}" alt="avatar" />
          <span class="lb-user" data-uid="${u.uid}">${u.name}<span class="tooltip">View Profile</span></span>
        </div>
      `).join('') || `<div class="lb-row">No members yet</div>`;
      attachClickListeners();
    });

    // Streaks (from users/{uid}/loginStreak)
    const lbStreaks = document.getElementById('lb-streaks');
    db.ref('users').once('value').then(snapshot => {
      let arr = [];
      snapshot.forEach(child => {
        const v = child.val();
        let streakNum = typeof v.loginStreak === "number" ? v.loginStreak : (parseInt(v.loginStreak)||0);
        arr.push({
          uid: child.key,
          name: v.displayName || v.email || child.key,
          streak: streakNum,
          avatar: getAvatarUrl(v)
        });
      });
      arr.sort((a, b) => b.streak - a.streak || a.name.localeCompare(b.name));
      lbStreaks.innerHTML = arr.map((u, i) => `
        <div class="lb-row top${i<3?i+1:''}">
          <img class="lb-avatar" src="${u.avatar}" alt="avatar" />
          <span class="lb-user" data-uid="${u.uid}"><span class="lb-icon">üî•</span>${u.name}<span class="tooltip">View Profile</span></span>
          <span class="lb-count">${u.streak}</span>
        </div>
      `).join('') || `<div class="lb-row">No streaks yet</div>`;
      attachClickListeners();
    });

    // Badges (total for each user, show avatars)
    const lbBadges = document.getElementById('lb-badges');
    Promise.all([
      db.ref('users').once('value'),
      db.ref('badges').once('value')
    ]).then(([userSnap, badgeSnap]) => {
      const users = [];
      userSnap.forEach(child => {
        const v = child.val();
        users.push({
          uid: child.key,
          name: v.displayName || v.email || child.key,
          avatar: getAvatarUrl(v)
        });
      });
      let badgeTotals = users.map(user => {
        const badgeObj = badgeSnap.child(user.uid).val() || {};
        let sum = 0;
        for (let k in badgeObj) sum += parseInt(badgeObj[k]) || 0;
        return {
          ...user,
          count: sum
        };
      });
      badgeTotals.sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));
      lbBadges.innerHTML = badgeTotals.map((u, i) => `
        <div class="lb-row top${i<3?i+1:''}">
          <img class="lb-avatar" src="${u.avatar}" alt="avatar" />
          <span class="lb-user" data-uid="${u.uid}"><span class="lb-icon">üèÖ</span>${u.name}<span class="tooltip">View Profile</span></span>
          <span class="lb-badgecount">${u.count}</span>
        </div>
      `).join('') || `<div class="lb-row">No badges yet</div>`;
      attachClickListeners();
    });
  </script>
</body>
</html>
