<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Events Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      height:100%; width:100%; margin:0; padding:0;
      font-family:'Poppins',sans-serif; color:#fff;
      background:url('https://kevinmidnight7-sudo.github.io/messageboardkc/silver.png') center/cover fixed;
      display:flex; align-items:center; justify-content:center;
    }
    .auth-card {
      position:relative;
      background:rgba(0,0,0,0.78);
      border-radius:18px;
      box-shadow:0 8px 40px rgba(0,0,0,0.65);
      padding:2.5rem 2rem;
      width:100%; max-width:380px;
      display:flex; flex-direction:column; align-items:center; gap:1rem;
    }
    .logo-img { margin-bottom:1rem; max-width:90px; }
    h2 {
      font-size:2rem; margin:0; font-weight:600; text-align:center;
    }
    .icon-bar {
      display:none;            /* hidden by default */
      margin-bottom:1rem;
      display:flex; gap:.5rem;
    }
    .icon-btn {
      font-size:1.5rem; cursor:pointer; opacity:.8;
      transition:opacity .2s; user-select:none;
    }
    .icon-btn:hover { opacity:1; }

    .error-msg {
      min-height:1.2em; font-size:.97rem; text-align:center; color:#f87171;
    }
    .form-section {
      width:100%; display:flex; flex-direction:column; gap:.8rem;
    }
    input {
      padding:.7rem .9rem; border-radius:7px; border:none;
      background:#212121; color:#fff; font-size:1rem; outline:none;
      transition:background .2s;
    }
    input:focus { background:#18181b; }

    .btn-orange {
      background:linear-gradient(90deg,#FF1C1C,#E1AB33);
      color:#fff; font-weight:700; font-size:1.1rem; border:none;
      border-radius:7px; padding:.68rem; cursor:pointer;
      transition:background .2s;
    }
    .btn-orange:hover { background:#E1AB33; }
    .btn-red {
      background:linear-gradient(90deg,#FF1C1C,#C81D25);
      color:#fff; font-weight:700; font-size:1.1rem; border:none;
      border-radius:7px; padding:.68rem; cursor:pointer;
      transition:background .2s;
    }
    .btn-red:hover { background:#E11D48; }

    .switch-link {
      color:#3B82F6; text-decoration:underline; cursor:pointer;
      font-size:.96rem; text-align:center;
    }
    .welcome { font-size:1.3rem; font-weight:600; text-align:center; }
    .user-counter { font-size:1.09rem; text-align:center; }

    .badges {
      width:100%; margin-top:1rem;
      padding:1rem; border:1px solid rgba(255,255,255,0.5);
      border-radius:8px; display:flex; flex-direction:column; gap:1rem;
    }
    .badges h3 {
      font-size:1.4rem; margin:0; text-align:center;
      text-shadow:0 0 8px #fff;
    }
    #badgeList {
      display:grid; grid-template-columns:repeat(2,1fr); gap:.75rem;
    }
    .badge {
      position:relative;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:.8rem; border-radius:12px;
      color:#fff; font-size:1rem; text-align:center;
      box-shadow:0 0 12px rgba(255,255,255,0.4);
      height:100px;
    }
    .badge img { width:32px; height:32px; margin-bottom:.5rem; }
    .badge.locked {
      background:#444; opacity:.5;
    }
    .badge.locked::after {
      content:'üîí'; position:absolute; top:8px; right:8px; font-size:1.2rem;
    }
    .badge.verified {
      background:linear-gradient(90deg,#10B981,#34D399);
      cursor:pointer;
    }
    .badge.unverified {
      background:#6B7280; cursor:pointer;
    }
    .multiplier {
      margin-top:.5rem;
      border-radius:4px; padding:0 .5rem; color:#fff;
      font-weight:700; background:#b87333;
      font-size:.9rem;
    }
    .join-badge {
      grid-column:1 / -1;
      display:flex; flex-direction:column; align-items:center; gap:.3rem;
      padding:.6rem 1rem; border-radius:8px;
      background:rgba(255,255,255,0.1);
      text-align:center; font-size:.9rem;
    }
    .supporter {
      padding:.3rem .8rem; border-radius:6px;
      color:#fff; font-weight:600; font-size:.92rem;
      text-shadow:0 0 6px rgba(255,255,255,0.7);
    }
    .supporter.gold {
      background:linear-gradient(90deg,#FFD700,#FFC107);
      box-shadow:0 0 8px rgba(255,215,0,0.6);
    }
    .supporter.blue {
      background:linear-gradient(90deg,#3B82F6,#60A5FA);
      box-shadow:0 0 8px rgba(59,130,246,0.6);
    }
    .supporter.purple {
      background:linear-gradient(90deg,#8B5CF6,#C084FC);
      box-shadow:0 0 8px rgba(139,92,246,0.6);
    }
    .version {
      text-align:center; font-size:1rem; opacity:.8;
    }

    .sidebar {
      position:fixed; top:0; right:0; height:100%; width:260px;
      background:rgba(0,0,0,0.95);
      transform:translateX(100%); transition:transform .3s;
      display:flex; flex-direction:column; padding:1.5rem; gap:1rem;
      z-index:1000;
    }
    .sidebar.open { transform:translateX(0); }
    .sidebar h3 {
      margin:0; color:#fff; text-align:center; font-size:1.2rem;
    }
    .sidebar select, .sidebar input {
      width:100%; padding:.5rem; border-radius:6px; border:none;
      background:#212121; color:#fff; margin-bottom:1rem;
    }
    .sidebar .btn-orange,
    .sidebar .btn-red { width:100%; }
    @media(max-width:600px){
      .auth-card { width:90vw; padding:1.5rem; }
      .sidebar   { width:80vw; }
      #badgeList { grid-template-columns:repeat(1,1fr); }
    }
  </style>
</head>
<body>

  <div class="auth-card">
    <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png"
         class="logo-img" alt="KC Events Logo"/>
    <h2 id="pageTitle">KC Events Login</h2>

    <!-- only shown once user is authenticated -->
    <div class="icon-bar">
      <div id="accountOptionsBtn" class="icon-btn">‚öôÔ∏è</div>
      <div id="adminPortalBtn"    class="icon-btn">üõ†Ô∏è</div>
    </div>

    <div id="error" class="error-msg"></div>

    <div class="form-section" id="registerForm">
      <input id="regName" placeholder="Display Name"/>
      <input id="regEmail" type="email" placeholder="Email"/>
      <input id="regPass" type="password" placeholder="Password"/>
      <button id="registerBtn" class="btn-orange">Register</button>
      <div class="switch-link" id="toLogin">Already have an account?¬†Log¬†In</div>
    </div>

    <div class="form-section" id="loginForm" style="display:none">
      <input id="loginEmail" type="email" placeholder="Email"/>
      <input id="loginPass" type="password" placeholder="Password"/>
      <button id="loginBtn" class="btn-orange">Log¬†In</button>
      <div class="switch-link" id="toRegister">No account?¬†Register</div>
    </div>

    <div id="loggedInUI" style="display:none; width:100%; flex-direction:column; align-items:center">
      <div class="welcome" id="welcomeUser"></div>
      <div class="user-counter" id="userCounter"></div>
      <div class="badges">
        <h3>Badges üèÖ</h3>
        <div id="badgeList"></div>
        <div class="version">KC Events V1</div>
      </div>
    </div>
  </div>

  <div id="accountSidebar" class="sidebar">
    <h3>Account Options</h3>
    <button id="signOutBtn"  class="btn-red">Sign¬†Out</button>
    <button id="resetPassBtn" class="btn-red">Reset¬†Password</button>
    <button id="deleteAcctBtn" class="btn-red">Delete¬†Account</button>
  </div>

  <div id="adminSidebar" class="sidebar">
    <h3>Admin Portal</h3>
    <div id="adminLoginForm">
      <input id="adminPass" type="password" placeholder="Admin¬†Password"/>
      <button id="adminLoginBtn" class="btn-orange">Enter</button>
    </div>
    <div id="adminControls" style="display:none">
      <select id="userSelect"></select>
      <button data-badge="offence" class="btn-orange">Best¬†Offence</button>
      <button data-badge="defence" class="btn-orange">Best¬†Defence</button>
      <button data-badge="overall" class="btn-orange">Overall¬†Winner</button>
    </div>
  </div>

  <script>
    // Firebase setup
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth(), db = firebase.database();

    const actionCodeSettings = {
      url: window.location.origin + "/?mode=verifyEmail",
      handleCodeInApp: true
    };

    // UI refs
    const pageTitle      = document.getElementById("pageTitle"),
          errorMsg       = document.getElementById("error"),
          regName        = document.getElementById("regName"),
          regEmail       = document.getElementById("regEmail"),
          regPass        = document.getElementById("regPass"),
          registerBtn    = document.getElementById("registerBtn"),
          loginEmail     = document.getElementById("loginEmail"),
          loginPass      = document.getElementById("loginPass"),
          loginBtn       = document.getElementById("loginBtn"),
          toLogin        = document.getElementById("toLogin"),
          toRegister     = document.getElementById("toRegister"),
          registerForm   = document.getElementById("registerForm"),
          loginForm      = document.getElementById("loginForm"),
          loggedInUI     = document.getElementById("loggedInUI"),
          welcomeUser    = document.getElementById("welcomeUser"),
          userCounter    = document.getElementById("userCounter"),
          badgeList      = document.getElementById("badgeList"),
          accountBtn     = document.getElementById("accountOptionsBtn"),
          adminBtn       = document.getElementById("adminPortalBtn"),
          accountSidebar = document.getElementById("accountSidebar"),
          adminSidebar   = document.getElementById("adminSidebar"),
          adminLoginBtn  = document.getElementById("adminLoginBtn"),
          adminPassInput = document.getElementById("adminPass"),
          adminLoginForm = document.getElementById("adminLoginForm"),
          adminControls  = document.getElementById("adminControls"),
          userSelect     = document.getElementById("userSelect"),
          signOutBtn     = document.getElementById("signOutBtn"),
          resetPassBtn   = document.getElementById("resetPassBtn"),
          deleteAcctBtn  = document.getElementById("deleteAcctBtn");

    function kcAlert(txt) {
      errorMsg.textContent = txt;
    }

    // Toggle forms
    toLogin.onclick    = ()=>{ registerForm.style.display="none"; loginForm.style.display="flex";  kcAlert(""); };
    toRegister.onclick = ()=>{ loginForm.style.display="none";  registerForm.style.display="flex"; kcAlert(""); };

    // Sidebars open/close
    accountBtn.onclick = ()=> accountSidebar.classList.add("open");
    adminBtn.onclick   = ()=> adminSidebar.classList.add("open");
    document.addEventListener("click", e=>{
      if (!accountSidebar.contains(e.target) && e.target!==accountBtn)
        accountSidebar.classList.remove("open");
      if (!adminSidebar.contains(e.target) && e.target!==adminBtn)
        adminSidebar.classList.remove("open");
    });

    // Register
    registerBtn.onclick = ()=>{
      const name  = regName.value.trim(),
            email = regEmail.value.trim(),
            pass  = regPass.value;
      if(!name||!email||!pass) return kcAlert("Fill all fields.");
      auth.createUserWithEmailAndPassword(email,pass)
        .then(u=>u.user.updateProfile({displayName:name}).then(()=>u.user))
        .then(user=> db.ref(`users/${user.uid}`)
                        .set({displayName:name,email,joined:firebase.database.ServerValue.TIMESTAMP})
                        .then(()=>user))
        .then(user=> user.sendEmailVerification(actionCodeSettings))
        .then(()=> kcAlert("Verification email sent!"))
        .catch(e=> kcAlert(e.message));
    };

    // Login
    loginBtn.onclick = ()=>{
      const email=loginEmail.value.trim(), pass=loginPass.value;
      if(!email||!pass) return kcAlert("Enter email and password!");
      auth.signInWithEmailAndPassword(email,pass)
        .then(res=>{
          if(!res.user.emailVerified){
            auth.signOut();
            throw new Error("Please verify your email before logging in.");
          }
        })
        .catch(e=> kcAlert(e.message));
    };

    // Account options
    signOutBtn.onclick = ()=> auth.signOut().then(()=> kcAlert("Signed out"));
    resetPassBtn.onclick = ()=>{
      const u=auth.currentUser; if(!u) return kcAlert("Not signed in");
      auth.sendPasswordResetEmail(u.email,{url:window.location.origin+"/?mode=resetPassword",handleCodeInApp:true})
        .then(()=> kcAlert("Password reset email sent"))
        .catch(e=> kcAlert(e.message));
    };
    deleteAcctBtn.onclick = ()=>{
      const u=auth.currentUser; if(!u) return;
      if(!confirm("Delete account?")) return;
      u.delete()
       .then(()=> kcAlert("Account deleted"))
       .catch(err=>{
         if(err.code==="auth/requires-recent-login")
           kcAlert("Please sign out and back in before deleting.");
         else kcAlert(err.message);
       });
    };

    // Admin portal
    adminLoginBtn.onclick = ()=>{
      if(adminPassInput.value==="events2025KC"){
        kcAlert("Admin authenticated");
        adminLoginForm.style.display="none";
        adminControls.style.display="flex";
        db.ref("users").once("value").then(snap=>{
          userSelect.innerHTML="";
          snap.forEach(c=>{
            const opt=document.createElement("option");
            opt.value=c.key; opt.textContent=c.val().displayName;
            userSelect.appendChild(opt);
          });
        });
      } else kcAlert("Wrong admin password");
    };
    adminControls.querySelectorAll("button[data-badge]").forEach(btn=>{
      btn.onclick = ()=>{
        const badgeKey=btn.getAttribute("data-badge"), uid=userSelect.value;
        if(!uid) return kcAlert("Select a user");
        db.ref(`badges/${uid}/${badgeKey}`).get().then(snap=>{
          const n=snap.val()||0;
          return db.ref(`badges/${uid}/${badgeKey}`).set(n+1);
        }).then(()=>{
          kcAlert("Badge assigned");
          if(auth.currentUser && auth.currentUser.uid===uid)
            loadBadges(uid,auth.currentUser.emailVerified);
        }).catch(e=> kcAlert(e.message));
      };
    });

    // Load badges + join-tier
    function loadBadges(uid, verified){
      badgeList.innerHTML="";
      const vb=document.createElement("div");
      vb.className="badge "+(verified?"verified":"unverified");
      vb.textContent = verified?"‚úì VERIFIED":"‚úó NOT VERIFIED";
      vb.onclick=()=>{
        if(!verified && auth.currentUser){
          auth.currentUser.sendEmailVerification(actionCodeSettings)
            .then(()=>kcAlert("Verification email resent!"))
            .catch(e=>kcAlert(e.message));
        }
      };
      badgeList.appendChild(vb);

      const specs={
        offence:{label:"Best Offence",    icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/red.png",    grad:"linear-gradient(90deg,#E11D48,#F43F5E)"},
        defence:{label:"Best Defence",    icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png",   grad:"linear-gradient(90deg,#3B82F6,#60A5FA)"},
        overall:{label:"Overall Winner", icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png",grad:"linear-gradient(90deg,#D97706,#FBBF24)"}
      };
      db.ref(`badges/${uid}`).once("value").then(snap=>{
        const data=snap.val()||{};
        Object.keys(specs).forEach(k=>{
          const cnt=data[k]||0, bd=document.createElement("div");
          bd.className="badge";
          if(cnt>0){
            bd.style.background=specs[k].grad;
            const img=document.createElement("img"); img.src=specs[k].icon;
            bd.appendChild(img);
            bd.append(specs[k].label);
            if(cnt>1){
              const m=document.createElement("span");
              m.className="multiplier"; m.textContent=`x${cnt}`;
              if(cnt<5) m.style.background="#b87333";
              else if(cnt<10) m.style.background="#C0C0C0";
              else m.style.background="#FFD700";
              bd.appendChild(m);
            }
          } else {
            bd.classList.add("locked");
            bd.append(specs[k].label);
          }
          badgeList.appendChild(bd);
        });
        db.ref(`users/${uid}`).once("value").then(usnap=>{
          const ts=usnap.val().joined,
                date=new Date(ts).toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});
          db.ref("users").orderByChild("joined").endAt(ts).once("value")
            .then(r=> {
              const rank=r.numChildren();
              let text="", cls="";
              if(rank<=20)      { text="Early Supporter"; cls="gold"; }
              else if(rank<=50) { text="Early Supporter"; cls="blue"; }
              else if(rank>=100){ text="KC Verified";      cls="purple"; }
              const jb=document.createElement("div");
              jb.className="join-badge";
              jb.innerHTML = `<div>Join Date: ${date}</div>` +
                             (text?`<div class="supporter ${cls}">${text}</div>`:"");
              badgeList.appendChild(jb);
            });
        });
      });
    }

    // Auth state
    auth.onAuthStateChanged(u=>{
      if(u){
        registerForm.style.display="none";
        loginForm.style.display   ="none";
        loggedInUI.style.display  ="flex";
        document.querySelector(".icon-bar").style.display="flex";
        pageTitle.textContent     ="KC Events";
        welcomeUser.textContent   =`üëã Welcome, ${u.displayName}`;
        db.ref("users").once("value").then(s=>{
          userCounter.textContent=`There are now ${s.numChildren()} users registered to KC Events!`;
        });
        loadBadges(u.uid,u.emailVerified);
      } else {
        pageTitle.textContent     ="KC Events Login";
        loggedInUI.style.display  ="none";
        registerForm.style.display="flex";
        loginForm.style.display   ="none";
        document.querySelector(".icon-bar").style.display="none";
      }
    });
  </script>
</body>
</html>
