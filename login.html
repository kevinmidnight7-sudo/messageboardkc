<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Events</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html, body {
      height:100%; margin:0; padding:0;
      font-family:'Poppins',sans-serif; color:#fff;
      background:url('https://kevinmidnight7-sudo.github.io/messageboardkc/silver.png') center/cover fixed;
      display:flex; align-items:center; justify-content:center;
    }
    .auth-card {
      background:rgba(0,0,0,0.78);
      border-radius:18px;
      box-shadow:0 8px 40px rgba(0,0,0,0.65);
      padding:2.5rem 2rem;
      width:100%; max-width:380px;
      display:flex; flex-direction:column; align-items:center; gap:1rem;
      box-sizing:border-box;
      transition:max-width .3s;
    }
    .logo-img { max-width:90px; }
    h2 { font-size:2rem; margin:0; text-align:center; }
    .error-msg { min-height:1.2em; color:#f87171; text-align:center; }

    /* LOGGED-OUT FORMS */
    #authForms { width:100%; display:flex; flex-direction:column; gap:1rem; }
    .form-section { display:flex; flex-direction:column; gap:.8rem; }
    .form-section input {
      padding:.7rem .9rem; border:none; border-radius:7px;
      background:#212121; color:#fff; font-size:1rem; outline:none;
      transition:background .2s;
    }
    .form-section input:focus { background:#18181b; }
    .btn-orange, .btn-red {
      padding:.68rem; border:none; border-radius:7px;
      font-size:1.1rem; font-weight:700; cursor:pointer;
      color:#fff; transition:background .2s;
    }
    .btn-orange { background:linear-gradient(90deg,#FF1C1C,#E1AB33); }
    .btn-orange:hover { background:#E1AB33; }
    .btn-red { background:linear-gradient(90deg,#FF1C1C,#C81D25); }
    .btn-red:hover { background:#E11D48; }
    .switch-link {
      text-align:center; color:#3B82F6; cursor:pointer; text-decoration:underline;
      font-size:.96rem;
    }

    /* LOGGED-IN TWO-COLUMN */
    #loggedInUI {
      display:none; width:100%; max-width:720px;
      box-sizing:border-box;
      flex-direction:row; align-items:stretch; gap:1rem;
    }
    #loggedInUI.show { display:flex !important; }

    .top-container {
      flex:1; max-width:48%;
      display:flex; flex-direction:column;
      align-items:center; justify-content:space-between;
      padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.2);
    }
    .welcome { font-size:1.3rem; font-weight:600; text-align:center; }
    .user-counter { font-size:1.09rem; text-align:center; }
    .icon-bar { display:flex; gap:.5rem; }
    .icon-btn {
      font-size:1.5rem; cursor:pointer; opacity:.8;
      transition:opacity .2s; user-select:none;
    }
    .icon-btn:hover { opacity:1; }

    .badges-container {
      flex:1; max-width:48%;
      display:flex; flex-direction:column; gap:1rem;
    }
    .badges {
      width:100%; padding:1rem; border:1px solid rgba(255,255,255,0.5);
      border-radius:8px; display:flex; flex-direction:column; gap:1rem;
    }
    .badges h3 {
      text-align:center; margin:0; font-size:1.4rem; text-shadow:0 0 8px #fff;
    }
    #badgeList {
      display:grid; grid-template-columns:repeat(2,1fr); gap:.75rem;
    }
    .badge {
      height:100px; border-radius:12px; padding:.8rem;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:#fff; text-align:center; box-shadow:0 0 12px rgba(255,255,255,0.4);
      position:relative;
    }
    .badge img { width:32px; height:32px; margin-bottom:.5rem; }
    .badge.locked { background:#444; opacity:.5; }
    .badge.locked::after {
      content:'üîí'; position:absolute; top:8px; right:8px; font-size:1.2rem;
    }
    .badge.verified { background:linear-gradient(90deg,#10B981,#34D399); cursor:pointer; }
    .badge.unverified { background:#6B7280; cursor:pointer; }
    .multiplier {
      margin-top:.5rem; padding:0 .5rem; border-radius:4px;
      font-weight:700; font-size:.9rem; color:#fff; background:#b87333;
    }
    .join-badge {
      grid-column:1/-1; text-align:center;
      padding:.6rem 1rem; border-radius:8px; background:rgba(255,255,255,0.1);
    }
    .supporter {
      margin-top:.3rem; padding:.3rem .8rem; border-radius:6px;
      font-weight:600; font-size:.92rem; color:#fff; text-shadow:0 0 6px rgba(255,255,255,0.7);
    }
    .supporter.gold   { background:linear-gradient(90deg,#FFD700,#FFC107); }
    .supporter.blue   { background:linear-gradient(90deg,#3B82F6,#60A5FA); }
    .supporter.purple { background:linear-gradient(90deg,#8B5CF6,#C084FC); }
    .version { text-align:center; opacity:.8; }

    /* Sidebar */
    .sidebar {
      position:fixed; top:0; right:0; height:100%; width:260px;
      background:rgba(0,0,0,0.95); transform:translateX(100%);
      transition:transform .3s; display:flex; flex-direction:column; gap:1rem;
      padding:1.5rem; box-sizing:border-box; z-index:1000;
    }
    .sidebar.open { transform:translateX(0); }
    .sidebar h3 { margin:0; text-align:center; font-size:1.2rem; }
    .sidebar input, .sidebar select {
      width:100%; padding:.5rem; border:none; border-radius:6px;
      background:#212121; color:#fff; margin-bottom:1rem;
    }
    .sidebar .btn-orange { background:linear-gradient(90deg,#FF1C1C,#E1AB33); }
    .sidebar .btn-red    { background:linear-gradient(90deg,#FF1C1C,#C81D25); }
    @media(max-width:600px){
      .auth-card { max-width:90vw; padding:1.5rem; }
      #loggedInUI { flex-direction:column !important; max-width:90vw; }
      .top-container, .badges-container {
        max-width:100%; border-bottom:none; padding:.5rem 0;
      }
      #badgeList { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="auth-card">
    <!-- logo + dynamic title -->
    <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png" class="logo-img" alt="Logo"/>
    <h2 id="pageTitle">KC Events Login</h2>
    <div id="error" class="error-msg"></div>

    <!-- logged-out -->
    <div id="authForms">
      <div class="form-section" id="registerForm">
        <input id="regName" placeholder="Display Name"/>
        <input id="regEmail" type="email" placeholder="Email"/>
        <input id="regPass" type="password" placeholder="Password"/>
        <button id="registerBtn" class="btn-orange">Register</button>
        <div class="switch-link" id="toLogin">Already have an account? Log In</div>
      </div>
      <div class="form-section" id="loginForm" style="display:none">
        <input id="loginEmail" type="email" placeholder="Email"/>
        <input id="loginPass" type="password" placeholder="Password"/>
        <button id="loginBtn" class="btn-orange">Log In</button>
        <div class="switch-link" id="toRegister">No account? Register</div>
      </div>
    </div>

    <!-- logged-in -->
    <div id="loggedInUI">
      <!-- left panel -->
      <div class="top-container">
        <h2>Profile:</h2>
        <div class="welcome" id="welcomeUser"></div>
        <div class="user-counter" id="userCounter"></div>
        <div class="icon-bar">
          <div id="accountOptionsBtn" class="icon-btn">‚öôÔ∏è</div>
          <div id="adminPortalBtn"    class="icon-btn">üõ†Ô∏è</div>
        </div>
      </div>
      <!-- right panel -->
      <div class="badges-container">
        <div class="badges">
          <h3>Badges üèÖ</h3>
          <div id="badgeList"></div>
          <div class="version">KC Events V1</div>
        </div>
      </div>
    </div>
  </div>

  <!-- sidebars -->
  <div id="accountSidebar" class="sidebar">
    <h3>Account Options</h3>
    <button id="signOutBtn" class="btn-red">Sign Out</button>
    <button id="resetPassBtn" class="btn-red">Reset Password</button>
    <button id="deleteAcctBtn" class="btn-red">Delete Account</button>
  </div>
  <div id="adminSidebar" class="sidebar">
    <h3>Admin Portal</h3>
    <div id="adminLoginForm">
      <input id="adminPass" type="password" placeholder="Admin Password"/>
      <button id="adminLoginBtn" class="btn-orange">Enter</button>
    </div>
    <div id="adminControls" style="display:none">
      <select id="userSelect"></select>
      <button data-badge="offence" class="btn-orange">Best Offence</button>
      <button data-badge="defence" class="btn-orange">Best Defence</button>
      <button data-badge="overall" class="btn-orange">Overall Winner</button>
    </div>
  </div>

  <script>
    // Firebase setup (your original config)
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth(), db = firebase.database();
    const actionCodeSettings = {
      url: window.location.origin + "/?mode=verifyEmail",
      handleCodeInApp: true
    };

    // UI refs
    const pageTitle    = document.getElementById("pageTitle"),
          errorMsg     = document.getElementById("error"),
          authForms    = document.getElementById("authForms"),
          registerForm = document.getElementById("registerForm"),
          loginForm    = document.getElementById("loginForm"),
          regName      = document.getElementById("regName"),
          regEmail     = document.getElementById("regEmail"),
          regPass      = document.getElementById("regPass"),
          registerBtn  = document.getElementById("registerBtn"),
          loginEmail   = document.getElementById("loginEmail"),
          loginPass    = document.getElementById("loginPass"),
          loginBtn     = document.getElementById("loginBtn"),
          toLogin      = document.getElementById("toLogin"),
          toRegister   = document.getElementById("toRegister"),
          loggedInUI   = document.getElementById("loggedInUI"),
          welcomeUser  = document.getElementById("welcomeUser"),
          userCounter  = document.getElementById("userCounter"),
          badgeList    = document.getElementById("badgeList"),
          accountBtn   = document.getElementById("accountOptionsBtn"),
          adminBtn     = document.getElementById("adminPortalBtn"),
          accountSidebar = document.getElementById("accountSidebar"),
          adminSidebar   = document.getElementById("adminSidebar"),
          signOutBtn   = document.getElementById("signOutBtn"),
          resetPassBtn = document.getElementById("resetPassBtn"),
          deleteAcctBtn= document.getElementById("deleteAcctBtn"),
          adminLoginBtn= document.getElementById("adminLoginBtn"),
          adminPassInput= document.getElementById("adminPass"),
          adminLoginForm= document.getElementById("adminLoginForm"),
          adminControls = document.getElementById("adminControls"),
          userSelect    = document.getElementById("userSelect");

    function kcAlert(txt){ errorMsg.textContent = txt; }

    // Toggle forms
    toLogin .onclick = ()=>{ registerForm.style.display="none"; loginForm.style.display="flex"; kcAlert(""); };
    toRegister.onclick = ()=>{ loginForm.style.display="none"; registerForm.style.display="flex"; kcAlert(""); };

    // Sidebars
    accountBtn.onclick = ()=> accountSidebar.classList.add("open");
    adminBtn.onclick   = ()=> adminSidebar.classList.add("open");
    document.addEventListener("click", e=>{
      if(!accountSidebar.contains(e.target)&&e.target!==accountBtn) accountSidebar.classList.remove("open");
      if(!adminSidebar.contains(e.target)&&e.target!==adminBtn)   adminSidebar.classList.remove("open");
    });

    // Register
    registerBtn.onclick = ()=>{
      const name=regName.value.trim(), email=regEmail.value.trim(), pass=regPass.value;
      if(!name||!email||!pass) return kcAlert("Fill all fields.");
      auth.createUserWithEmailAndPassword(email,pass)
        .then(u=>u.user.updateProfile({displayName:name}).then(()=>u.user))
        .then(u=>db.ref(`users/${u.uid}`).set({displayName:name,email,joined:firebase.database.ServerValue.TIMESTAMP}).then(()=>u))
        .then(u=>u.sendEmailVerification(actionCodeSettings))
        .then(()=>kcAlert("Verification email sent!"))
        .catch(e=>kcAlert(e.message));
    };

    // Login
    loginBtn.onclick = ()=>{
      const email=loginEmail.value.trim(), pass=loginPass.value;
      if(!email||!pass) return kcAlert("Enter email and password!");
      auth.signInWithEmailAndPassword(email,pass)
        .then(res=>{
          if(!res.user.emailVerified){
            auth.signOut();
            throw new Error("Please verify your email before logging in.");
          }
        })
        .catch(e=>kcAlert(e.message));
    };

    // Account actions
    signOutBtn.onclick = ()=>auth.signOut().then(()=>kcAlert("Signed out"));
    resetPassBtn.onclick = ()=>{
      const u=auth.currentUser; if(!u) return kcAlert("Not signed in");
      auth.sendPasswordResetEmail(u.email,{url:window.location.origin+"/?mode=resetPassword",handleCodeInApp:true})
        .then(()=>kcAlert("Password reset email sent"))
        .catch(e=>kcAlert(e.message));
    };
    deleteAcctBtn.onclick = ()=>{
      const u=auth.currentUser; if(!u) return;
      if(!confirm("Delete account?")) return;
      u.delete()
       .then(()=>kcAlert("Account deleted"))
       .catch(err=>{
         if(err.code==="auth/requires-recent-login")
           kcAlert("Please sign out and back in before deleting.");
         else kcAlert(err.message);
       });
    };

    // Admin
    adminLoginBtn.onclick = ()=>{
      if(adminPassInput.value==="events2025KC"){
        kcAlert("Admin authenticated");
        adminLoginForm.style.display="none";
        adminControls.style.display="flex";
        db.ref("users").once("value").then(snap=>{
          userSelect.innerHTML="";
          snap.forEach(c=>{ let o=document.createElement("option"); o.value=c.key; o.textContent=c.val().displayName; userSelect.appendChild(o); });
        });
      } else kcAlert("Wrong admin password");
    };
    adminControls.querySelectorAll("button[data-badge]").forEach(btn=>{
      btn.onclick=()=>{
        const badgeKey=btn.dataset.badge, uid=userSelect.value;
        if(!uid) return kcAlert("Select a user");
        db.ref(`badges/${uid}/${badgeKey}`).get().then(snap=>{
          return db.ref(`badges/${uid}/${badgeKey}`).set((snap.val()||0)+1);
        }).then(()=>{
          kcAlert("Badge assigned");
          if(auth.currentUser.uid===uid) loadBadges(uid,auth.currentUser.emailVerified);
        }).catch(e=>kcAlert(e.message));
      };
    });

    // Load badges/join
    function loadBadges(uid, verified){
      badgeList.innerHTML="";
      let vb=document.createElement("div");
      vb.className="badge "+(verified?"verified":"unverified");
      vb.textContent=verified?"‚úì VERIFIED":"‚úó NOT VERIFIED";
      vb.onclick=()=>{ if(!verified) auth.currentUser.sendEmailVerification(actionCodeSettings).then(()=>kcAlert("Verification email resent!")); };
      badgeList.appendChild(vb);
      const specs={
        offence:{label:"Best Offence",icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/red.png",grad:"linear-gradient(90deg,#E11D48,#F43F5E)"},
        defence:{label:"Best Defence",icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png",grad:"linear-gradient(90deg,#3B82F6,#60A5FA)"},
        overall:{label:"Overall Winner",icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png",grad:"linear-gradient(90deg,#D97706,#FBBF24)"}
      };
      db.ref(`badges/${uid}`).once("value").then(snap=>{
        Object.entries(specs).forEach(([k,s])=>{
          const cnt=(snap.val()||{})[k]||0, bd=document.createElement("div");
          bd.className="badge";
          if(cnt>0){
            bd.style.background=s.grad;
            let img=document.createElement("img"); img.src=s.icon; bd.appendChild(img);
            bd.append(s.label);
            if(cnt>1){ let m=document.createElement("span"); m.className="multiplier"; m.textContent="x"+cnt; bd.appendChild(m); }
          } else { bd.classList.add("locked"); bd.append(s.label); }
          badgeList.appendChild(bd);
        });
        db.ref(`users/${uid}`).once("value").then(uSnap=>{
          const date=new Date(uSnap.val().joined).toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});
          db.ref("users").orderByChild("joined").endAt(uSnap.val().joined).once("value")
            .then(r=>{ let rank=r.numChildren(), txt="",cls="";
              if(rank<=50){txt="Early Supporter";cls=rank<=20?"gold":"blue";}
              else if(rank>=100){txt="KC Verified";cls="purple";}
              let jb=document.createElement("div"); jb.className="join-badge";
              jb.innerHTML=`<div>Join Date: ${date}</div>${txt?`<div class="supporter ${cls}">${txt}</div>`:""}`;
              badgeList.appendChild(jb);
            });
        });
      });
    }

    // Auth state
    auth.onAuthStateChanged(u=>{
      if(u){
        authForms.style.display="none";
        loggedInUI.classList.add("show");
        document.querySelector(".auth-card").style.maxWidth="720px";
        pageTitle.textContent="KC Events";
        welcomeUser.textContent=`üëã Welcome, ${u.displayName}`;
        db.ref("users").once("value").then(s=>userCounter.textContent=`There are now ${s.numChildren()} users registered!`);
        loadBadges(u.uid,u.emailVerified);
      } else {
        authForms.style.display="flex";
        loggedInUI.classList.remove("show");
        document.querySelector(".auth-card").style.maxWidth="380px";
        pageTitle.textContent="KC Events Login";
      }
    });
  </script>
</body>
</html>

