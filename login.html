<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Events Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    html,body {
      height: 100%; width: 100%; margin: 0; padding: 0;
      font-family: 'Poppins', sans-serif; color: #fff;
      min-height: 100vh; min-width: 100vw;
    }
    body {
      background: url('https://kevinmidnight7-sudo.github.io/messageboardkc/silver.png') no-repeat center center fixed;
      background-size: cover;
      display: flex; align-items: center; justify-content: center;
    }
    .auth-card {
      background: rgba(0,0,0,0.78); border-radius: 18px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.65);
      padding: 2.2rem 2rem; min-width: 350px; max-width: 380px;
      display: flex; flex-direction: column; align-items: center;
      gap: 1.2rem; position: relative;
    }
    .logo-img { margin-bottom: 1.1rem; max-width: 90px; }
    .auth-card h2 {
      font-size: 2rem; margin: 0 0 1rem; font-weight: 600;
      letter-spacing: -1px; text-align: center;
    }
    .form-section { width: 100%; display: flex; flex-direction: column; gap: .8rem; }
    .auth-card input {
      padding: .7rem .9rem; border-radius: 7px; border: none;
      background: #212121; color: #fff; font-size: 1rem; outline: none;
      transition: background 0.2s;
    }
    .auth-card input:focus { background: #18181b; }
    .auth-card button {
      padding: .68rem 0; border: none; border-radius: 7px;
      background: linear-gradient(90deg,#FF1C1C,#E1AB33);
      color: #fff; font-weight: 700; font-size: 1.1rem; cursor: pointer;
      margin-top: .35rem; transition: background 0.18s,color 0.18s;
      box-shadow: 0 1px 8px rgba(255,28,28,0.12);
    }
    .auth-card button:hover, .auth-card button:focus {
      background: #E1AB33 !important; color: #191919 !important;
    }
    .signout-btn {
      background: linear-gradient(90deg,#FF1C1C,#C81D25) !important;
      margin-top: 1rem !important; width: 100%; padding: .62rem 0;
    }
    .action-btn {
      background: #444; margin-top: .5rem; width: 100%;
      padding: .6rem; border: none; border-radius: 7px;
      color: #fff; cursor: pointer; font-size: 1rem;
    }
    .action-btn:hover { background: #555; }
    .switch-link {
      color: #E1AB33; cursor: pointer; text-decoration: underline;
      font-size: .96rem; text-align: center; transition: color .18s;
    }
    .switch-link:hover { color: #ffe199; }
    .welcome {
      font-size: 1.3rem; font-weight: 600; display: flex;
      align-items: center; gap: .5rem; justify-content: center;
      margin: 0 0 1rem; text-align: center;
    }
    .user-counter {
      font-size: 1.09rem; text-align: center; font-weight: 500;
      margin-bottom: 1.5rem; text-shadow: 0 1px 10px #17171799;
    }
    .version {
      background: linear-gradient(90deg,#FFD700,#E1AB33);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      font-size: 1.08rem; margin-top: 1rem; opacity: .96;
    }
    .error-msg {
      color: #f87171; text-align: center; font-size: .97rem;
      margin-bottom: .4rem;
    }
    @media (max-width:600px){
      .auth-card { width:97vw; padding:1.4rem .4rem; }
      .logo-img { max-width:66px; }
    }
  </style>
</head>
<body>
  <div class="auth-card">
    <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png" class="logo-img" alt="KC Events Logo"/>
    <h2>KC Events Login</h2>
    <div id="error" class="error-msg"></div>

    <div class="form-section" id="registerForm">
      <input id="regName" placeholder="Display Name"/>
      <input id="regEmail" type="email" placeholder="Email"/>
      <input id="regPass" type="password" placeholder="Password"/>
      <button id="registerBtn">Register</button>
      <div class="switch-link" id="toLogin">Already have an account? Logâ€¯In</div>
    </div>

    <div class="form-section" id="loginForm" style="display:none;">
      <input id="loginEmail" type="email" placeholder="Email"/>
      <input id="loginPass" type="password" placeholder="Password"/>
      <button id="loginBtn">Logâ€¯In</button>
      <div class="switch-link" id="toRegister">No account? Register</div>
    </div>

    <div id="loggedInUI" style="display:none; width:100%; flex-direction:column; align-items:center;">
      <div class="welcome" id="welcomeUser"></div>
      <div class="user-counter" id="userCounter"></div>
      <button class="signout-btn" id="signOutBtn">Signâ€¯Out</button>
      <button class="action-btn" id="resetPassBtn">Reset Password</button>
      <button class="action-btn" id="deleteAcctBtn">Delete Account</button>
      <div class="version">KC Events V1</div>
    </div>
  </div>

  <script>
    // Firebase init
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth(), db = firebase.database();

    // actionCodeSettings
    const actionCodeSettings = {
      url: window.location.origin + '/?mode=verifyEmail',
      handleCodeInApp: true
    };

    // UI refs
    const errorMsg      = document.getElementById('error'),
          registerBtn   = document.getElementById('registerBtn'),
          loginBtn      = document.getElementById('loginBtn'),
          toLogin       = document.getElementById('toLogin'),
          toRegister    = document.getElementById('toRegister'),
          signOutBtn    = document.getElementById('signOutBtn'),
          resetPassBtn  = document.getElementById('resetPassBtn'),
          deleteAcctBtn = document.getElementById('deleteAcctBtn'),
          regName       = document.getElementById('regName'),
          regEmail      = document.getElementById('regEmail'),
          regPass       = document.getElementById('regPass'),
          loginEmail    = document.getElementById('loginEmail'),
          loginPass     = document.getElementById('loginPass'),
          registerForm  = document.getElementById('registerForm'),
          loginForm     = document.getElementById('loginForm'),
          loggedInUI    = document.getElementById('loggedInUI'),
          welcomeUser   = document.getElementById('welcomeUser'),
          userCounter   = document.getElementById('userCounter');

    // kcAlert helper
    function kcAlert(txt) {
      errorMsg.style.color = '#f87171';
      errorMsg.textContent = txt;
    }

    // toggle forms
    toLogin.onclick    = ()=>{ registerForm.style.display='none'; loginForm.style.display='flex';  errorMsg.textContent=''; };
    toRegister.onclick = ()=>{ loginForm.style.display='none';  registerForm.style.display='flex'; errorMsg.textContent=''; };

    // register with resendâ€‘verification logic
    registerBtn.onclick = () => {
      const name  = regName.value.trim(),
            email = regEmail.value.trim(),
            pass  = regPass.value;
      if (!name || !email || !pass) return kcAlert('Fill all fields.');
      auth.createUserWithEmailAndPassword(email, pass)
        .then(uCred =>
          uCred.user.updateProfile({ displayName: name }).then(()=>uCred.user)
        )
        .then(user =>
          db.ref(`users/${user.uid}`)
            .set({ displayName: name, email })
            .then(()=>user)
        )
        .then(user =>
          user.sendEmailVerification(actionCodeSettings)
        )
        .then(()=> kcAlert('Verification email sent! Check your inbox.'))
        .catch(err => {
          if (err.code === 'auth/email-already-in-use') {
            auth.fetchSignInMethodsForEmail(email)
              .then(methods => {
                if (methods.includes('password')) {
                  return auth.signInWithEmailAndPassword(email, pass)
                    .then(uCred => {
                      if (!uCred.user.emailVerified) {
                        return uCred.user.sendEmailVerification(actionCodeSettings)
                          .then(()=>kcAlert('Account exists but not verified. Verification resent.'));
                      }
                      throw new Error('Email already registered & verified. Please log in.');
                    })
                    .then(()=>auth.signOut());
                }
                throw new Error('Email already in use.');
              })
              .catch(e=>kcAlert(e.message));
          } else {
            kcAlert(err.message);
          }
        });
    };

    // login (block unverified)
    loginBtn.onclick = () => {
      const email = loginEmail.value.trim(),
            pass  = loginPass.value;
      if (!email || !pass) return kcAlert('Enter email and password!');
      auth.signInWithEmailAndPassword(email, pass)
        .then(res => {
          if (!res.user.emailVerified) {
            return auth.signOut().then(()=>{ throw new Error('Please verify your email before logging in.'); });
          }
        })
        .catch(e => kcAlert(e.message));
    };

    // sign out
    signOutBtn.onclick = () => auth.signOut();

    // reset password
    resetPassBtn.onclick = () => {
      const user = auth.currentUser;
      if (!user) return;
      auth.sendPasswordResetEmail(user.email, {
        url: window.location.origin + '/?mode=resetPassword',
        handleCodeInApp: true
      })
      .then(()=> alert('Password reset email sent.'))
      .catch(e=> alert('Error: '+e.message));
    };

    // delete account
    deleteAcctBtn.onclick = () => {
      if (!confirm('Delete account?')) return;
      const user = auth.currentUser;
      user.delete()
        .then(()=> alert('Account deleted.'))
        .catch(err=>{
          if (err.code==='auth/requires-recent-login') {
            alert('Please sign out and sign in again before deleting.');
          } else {
            alert('Error: '+err.message);
          }
        });
    };

    // auth state changes
    auth.onAuthStateChanged(user => {
      if (user && user.emailVerified) {
        registerForm.style.display='none';
        loginForm.style.display='none';
        loggedInUI.style.display='flex';
        errorMsg.textContent='';
        welcomeUser.innerHTML = `ðŸ‘‹ Welcome, <span style="color:#E1AB33">${user.displayName||'User'}</span>`;
        db.ref('users').once('value').then(snap=>{
          userCounter.textContent = `There are now ${snap.numChildren()} users registered to KC Events!`;
        });
      } else {
        loggedInUI.style.display='none';
        registerForm.style.display='flex';
        loginForm.style.display='none';
      }
    });
  </script>
</body>
</html>
