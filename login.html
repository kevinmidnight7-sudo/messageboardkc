
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Events</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
  /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Updated Button Styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.sidebar .sidebar-btn {
  font-size: 1.12rem;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  width: 100%;
  background: linear-gradient(90deg, #1ee57c 0%, #50b2fa 100%);
  color: #fff;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
  cursor: pointer;
  transition: background .18s, box-shadow .18s;
}
.sidebar .sidebar-btn:hover {
  background: linear-gradient(90deg, #19df7e 0%, #30a9f8 100%);
}

.sidebar .sidebar-btn-red {
  font-size: 1.12rem;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  padding: 12px;
  margin-top: 6px;
  width: 100%;
  background: linear-gradient(90deg, #f44336 0%, #e53935 100%);
  color: #fff;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
  cursor: pointer;
  transition: background .18s, box-shadow .18s;
}
.sidebar .sidebar-btn-red:hover {
  background: linear-gradient(90deg, #e53935 0%, #d32f2f 100%);
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Profile Info (Join Date + Version) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.profile-info {
  text-align: center;
  margin: 12px 0;
}
.join-badge {
  margin-bottom: 6px;
  font-size: 1rem;
  color: #544;
}
.version {
  font-size: .85rem;
  color: #b7c3d0;
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Sidebar Header Alignment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.sidebar-header h2 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 700;
}

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Global & Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    html, body {
      height:100%; margin:0; padding:0;
      font-family:'Poppins',sans-serif; color:#222;
      background:url('https://kevinmidnight7-sudo.github.io/messageboardkc/silver.png') center/cover fixed;
      display:flex; align-items:flex-start; justify-content:center;
      min-height:100vh;
    }
    #main-wrapper {
      width:100vw; min-height:100vh;
      display:flex; flex-direction:column; align-items:center;
    }
    .kc-logo {
      width:70px; margin:32px auto 0; display:block;
    }
    .kc-title {
      font-size:2.3rem; font-weight:700; text-align:center;
      margin:0 0 32px; color:#fff; letter-spacing:.02em;
      text-shadow:0 2px 16px #2227,0 1px 2px #8885;
    }
    .flex-row {
      display:flex; gap:2.5vw; align-items:flex-start; justify-content:center;
      margin-bottom:32px;
    }
    .card {
      background:linear-gradient(135deg,#fff 65%,#e9ecf4 100%);
      border-radius:32px; box-shadow:0 6px 40px #0001;
      padding:36px; min-width:350px; max-width:390px; min-height:520px;
      display:flex; flex-direction:column; position:relative; margin-bottom:32px;
    }
    @media(max-width:960px){
      .flex-row{flex-direction:column;align-items:center;gap:32px;}
      .card{width:100%;max-width:96vw;min-width:0;}
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Profile Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .profile-title{font-size:1.3rem;font-weight:600;margin:0 0 16px;}
    .profile-welcome{
      font-size:1.08rem;font-weight:600;color:#17a589;
      display:flex;align-items:center;gap:.38em;margin-bottom:.9rem;
      word-break:break-word;
    }
    .profile-counter{color:#669;font-size:1rem;margin-bottom:1.3rem;}
    .profile-icon-bar{display:flex;gap:16px;margin-top:16px;justify-content:center;}
    .profile-icon-btn{
      background:#fff;border-radius:50%;box-shadow:0 2px 10px #3332;
      border:none;width:55px;height:55px;font-size:2rem;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:box-shadow .18s,transform .15s;
      outline:none;
    }
    .profile-icon-btn:active,
    .profile-icon-btn:focus{box-shadow:0 2px 14px #0055ffaa;transform:scale(.96);}
    #avatarImg{
      display:none;width:64px;height:64px;
      border-radius:50%;margin:0 auto 12px auto;
      box-shadow:0 2px 10px #3332;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Badges Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .badges-header{
      font-size:1.55rem;font-weight:700;color:#e6b300;
      margin:0 0 8px;text-align:center;
      text-shadow:0 2px 20px #fff5,0 1px 2px #fb0a;
    }
    .badges-sub{
      font-style:italic;color:#536082;margin-bottom:26px;
      text-align:center;font-size:1.1rem;
    }
    .badges-grid{
      display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:26px;
    }
    .badge-item{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      border-radius:22px;height:112px;background:#f4f4f4;
      box-shadow:0 2px 10px #ccd2ee33;cursor:pointer;
      position:relative;transition:box-shadow .18s,transform .13s;
      border:none;font-size:1.03rem;
    }
    .badge-item.locked{
      filter:grayscale(.8) brightness(1.05);background:#e5e6ea;color:#aaa;opacity:.8;
    }
    .badge-item .lock-icon{
      position:absolute;top:12px;right:18px;
      font-size:1.4rem;color:#999;opacity:.9;
    }
    .badge-item .badge-mult{
      position:absolute;top:12px;right:18px;
      background:#fff;color:#333;border-radius:1.2em;
      min-width:2em;min-height:1.8em;font-weight:700;font-size:1.1em;
      box-shadow:0 1px 8px #9992;display:flex;align-items:center;justify-content:center;
      padding:0 .55em;z-index:10;border:2px solid #fff;
    }
    .badge-item img{width:36px;height:36px;margin-bottom:5px;}
    .badge-item .badge-label{
      font-weight:600;font-size:1.07rem;letter-spacing:.01em;
      margin-top:2px;text-align:center;
    }
    /* (hover states omitted for brevity) */

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ KC Alert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .kc-alert{
      position:fixed;top:32px;left:50%;transform:translateX(-50%);
      background:#fff;color:#232f38;font-weight:600;font-size:1.13rem;
      padding:13px 32px;border-radius:15px;box-shadow:0 2px 20px #2263;
      z-index:2000;min-width:160px;max-width:96vw;
      opacity:1;transition:opacity .16s;display:flex;align-items:center;gap:10px;
    }
    .kc-alert.hide{opacity:0;pointer-events:none;}

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Sidebars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .sidebar{
      position:fixed;top:0;right:0;height:100%;width:340px;max-width:94vw;
      background:linear-gradient(135deg,#fff 65%,#e7eaf3 100%);
      box-shadow:-4px 0 24px #0003;transform:translateX(110%);
      transition:transform .28s cubic-bezier(.72,0,.26,1.03);
      z-index:2100;padding:32px 18px 24px 30px;box-sizing:border-box;
      display:flex;flex-direction:column;gap:16px;
    }
    .sidebar.open{transform:translateX(0);}
    .sidebar h2{font-size:1.25rem;font-weight:700;margin:0 0 12px;}
    .sidebar label{display:block;font-size:1.07rem;margin:0 0 4px 2px;}
    .sidebar input,.sidebar select{
      width:100%;margin:0 0 12px;font-size:1.05rem;
      border-radius:8px;border:1px solid #dde3ee;background:#f5f7fc;
      padding:8px 10px;outline:none;transition:border .16s;color:#253047;
    }
    .sidebar input:focus{border:1.5px solid #3899ff;}
    .sidebar .sidebar-btn{
      font-size:1.12rem;font-weight:600;border:none;border-radius:8px;
      padding:10px 0;margin-bottom:8px;width:100%;
      background:linear-gradient(90deg,#13ce7c 0%,#44b0ef 100%);
      color:#fff;cursor:pointer;transition:background .13s,box-shadow .13s;
      box-shadow:0 2px 10px #6db8fb22;
    }
    .sidebar .sidebar-btn:hover,.sidebar .sidebar-btn:focus{
      background:linear-gradient(90deg,#08d763 0%,#4183f8 100%);
      box-shadow:0 3px 16px #338be955;
    }
    .sidebar .sidebar-btn-red{
      background:#f44336;box-shadow:0 3px 16px #e54e4e55;color:#fff;margin-top:6px;
    }
    .sidebar .sidebar-btn-red:hover{background:#d32f2f;}
    .sidebar .close-btn{
      position:absolute;top:22px;right:26px;
      background:#f44336;color:#fff;border:none;
      padding:7px 26px;border-radius:9px;font-weight:600;
      cursor:pointer;box-shadow:0 2px 10px #dc535555;
      transition:background .13s;
    }
    .sidebar .close-btn:hover{background:#d32f2f;}
    .sidebar .delete-warning{
      color:#e53935;font-weight:600;text-align:center;margin:16px 0 8px;
      font-size:1.1rem;
    }

    .admin-users-list{
      background:#f6f7fb;border-radius:9px;box-shadow:0 1px 8px #dde3ee88;
      margin:0 0 16px;padding:6px 2px 6px 12px;max-height:240px;overflow-y:auto;
      font-size:.99rem;
    }
    .admin-users-list ul{margin:0;padding:0;list-style:none;}
    .admin-users-list li{
      padding:6px 0;border-bottom:1px solid #eee;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .admin-badge-list{display:flex;gap:7px;}
    .admin-badge-count{
      background:#eee;color:#234;font-weight:700;font-size:1em;
      border-radius:9px;padding:2px 8px;margin-left:3px;
      box-shadow:0 1px 3px #2222;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Forms & Confirm ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    #authForms{display:flex;flex-direction:column;gap:1.3rem;align-items:center;min-width:320px;margin-top:18px;}
    .form-section{display:flex;flex-direction:column;gap:.85rem;}
    .form-section input{
      padding:.75rem .9rem;border:none;border-radius:7px;
      background:#f6f7fc;color:#222;font-size:1.04rem;
      outline:none;transition:background .18s;border:1.2px solid #e6ebf2;
    }
    .form-section input:focus{background:#ebeff6;border-color:#53c4fa;}
    .form-section .form-btn{
      padding:.68rem;border:none;border-radius:7px;
      font-size:1.08rem;font-weight:700;color:#fff;
      cursor:pointer;transition:background .18s;
      background:linear-gradient(90deg,#1ee57c,#50b2fa);
    }
    .form-section .form-btn:hover{background:linear-gradient(90deg,#19df7e,#30a9f8);}
    .switch-link{font-size:.97rem;color:#318be9;cursor:pointer;text-decoration:underline;text-align:center;}

    .confirm-overlay{
      position:fixed;top:0;left:0;width:100vw;height:100vh;
      background:rgba(45,65,80,.5);display:flex;align-items:center;justify-content:center;
      z-index:5000;
    }
    .confirm-box{
      background:#fff;color:#1c2228;font-size:1.14rem;
      padding:28px 42px 18px;border-radius:18px;box-shadow:0 3px 26px #2336;
      text-align:center;min-width:290px;
    }
    .confirm-box .confirm-btn{
      margin:10px 8px 0;border:none;padding:10px 26px;border-radius:8px;
      font-size:1.09rem;font-weight:600;cursor:pointer;
      background:linear-gradient(90deg,#1ee57c,#50b2fa);color:#fff;
      transition:background .14s;
    }
    .confirm-box .confirm-btn:hover{background:linear-gradient(90deg,#19df7e,#30a9f8);}
    .confirm-box .confirm-btn.cancel{background:#eee;color:#234;box-shadow:none;}
    
    /* ========== Apple-Like Avatar Carousel ========== */
.apple-modal {
  position:fixed; top:0; left:0; width:100vw; height:100vh;
  background:rgba(30,38,45,.45);
  display:flex; align-items:center; justify-content:center;
  z-index:2000; opacity:0; pointer-events:none; transition:opacity .26s;
}
.apple-modal.open { opacity:1; pointer-events:auto; }

.carousel-content {
  background:rgba(255,255,255,0.91);
  border-radius:28px;
  padding:28px 32px 30px 32px;
  box-shadow:0 12px 50px #0002, 0 1.5px 16px #0088ff22;
  position:relative;
  min-width:330px;
  min-height:230px;
  max-width:98vw;
}

.carousel-content h3 {
  font-size:1.35rem;
  font-weight:700;
  margin:0 0 24px 0;
  letter-spacing:.01em;
  color:#151d25;
}

.carousel-arrows {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  width:100%;
  margin-top:8px;
}

.arrow-btn {
  background:linear-gradient(120deg,#e9efff 0%,#cbe8ff 100%);
  border:none;
  border-radius:50%;
  width:44px; height:44px;
  font-size:1.8rem; color:#3899ff;
  box-shadow:0 2px 10px #a0c7ff22;
  cursor:pointer; transition:background .18s,box-shadow .18s,transform .11s;
  outline:none;
  z-index:2;
  user-select:none;
}
.arrow-btn:active { transform:scale(.92); background:#e7f4ff; }

.avatar-carousel {
  display:flex;
  overflow-x:auto;
  gap:18px;
  padding:14px 10px;
  scroll-snap-type: x mandatory;
  scrollbar-width:thin;
  background:rgba(235,240,245,0.45);
  border-radius:20px;
  min-width:240px;
  max-width:calc(85vw - 120px);
}
.avatar-carousel::-webkit-scrollbar {
  height:9px; background:rgba(220,220,250,0.08);
}
.avatar-carousel::-webkit-scrollbar-thumb {
  background:rgba(140,180,255,0.28); border-radius:12px;
}
.avatar-carousel .avatar-item {
  scroll-snap-align:center;
  flex:0 0 92px;
  width:92px; height:92px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  border-radius:50%;
  background:rgba(255,255,255,0.66);
  box-shadow:0 3px 18px #a0c8fa19,0 1.5px 8px #3fa8e022;
  position:relative;
  transition:transform .19s cubic-bezier(.5,1.7,.7,1.01), box-shadow .15s;
}
.avatar-carousel .avatar-item img {
  width:76px; height:76px; object-fit:cover; border-radius:50%;
  box-shadow:0 2px 10px #b0cdfc12;
  transition:box-shadow .18s, border .16s;
  border:3px solid transparent;
  background:#f6f9fc;
}
.avatar-carousel .avatar-item:hover,
.avatar-carousel .avatar-item.selected {
  transform:scale(1.14);
  box-shadow:0 8px 32px #b3deff99,0 1.5px 18px #8dc8ff45;
  z-index:1;
}
.avatar-carousel .avatar-item.selected img {
  border-color:#3899ff;
  box-shadow:0 2px 18px #7cdbfa44;
}
.close-btn {
  position: absolute;
  top: 18px;
  right: 22px;
  background: #f8fafd;
  color: #232f38;
  border: none;
  padding: 8px 18px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.04rem;
  cursor: pointer;
  box-shadow: 0 2px 8px #dbeafe44;
  transition: background 0.14s, color 0.14s, box-shadow 0.14s;
  outline: none;
  z-index: 2;
}
.close-btn:hover, .close-btn:focus {
  background: #f44336;
  color: #fff;
  box-shadow: 0 4px 16px #f4433644;
}

  </style>
</head>
<body>
  <div id="main-wrapper">
    <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png" class="kc-logo" alt="KC Events Logo"/>
    <div class="kc-title">KC Events</div>
    <div class="flex-row" id="mainContent">
      <!-- PROFILE CARD -->
      <div class="card" id="profileCard">
        <!-- LOGGED OUT -->
        <div id="authForms">
          <div class="form-section" id="registerForm">
            <input id="regName" placeholder="Display Name"/>
            <input id="regEmail" type="email" placeholder="Email"/>
            <input id="regPass" type="password" placeholder="Password"/>
            <button id="registerBtn" class="form-btn">Register</button>
            <div class="switch-link" id="toLogin">Already have an account? Log In</div>
          </div>
          <div class="form-section" id="loginForm" style="display:none">
            <input id="loginEmail" type="email" placeholder="Email"/>
            <input id="loginPass" type="password" placeholder="Password"/>
            <button id="loginBtn" class="form-btn">Log In</button>
            <div class="switch-link" id="toRegister">No account? Register</div>
          </div>
        </div>
        <!-- LOGGED IN -->
        <div id="profileUI" style="display:none">
          <img id="avatarImg" src="" alt="Your Avatar"/>
          <div class="profile-title">Profile:</div>
          <div class="profile-welcome" id="welcomeUser"></div>
          <div class="profile-counter" id="userCounter"></div>
          <div class="profile-info">
            <div id="joinBadge" class="join-badge"></div>
            <div class="version">KC Events V1</div>
          </div>
          <div class="profile-icon-bar">
            <button id="avatarBtn" class="profile-icon-btn" title="Choose Avatar">üñºÔ∏è</button>
            <button id="accountOptionsBtn" class="profile-icon-btn" title="Account Options">‚öôÔ∏è</button>
            <button id="adminPortalBtn" class="profile-icon-btn" title="Admin Portal">üõ†Ô∏è</button>
          </div>
        </div>
      </div>

      <!-- BADGES CARD -->
      <div class="card" id="badgesCard" style="min-width:320px;">
        <div class="badges-header">Badges <span style="font-size:1.08em;">üèÖ</span></div>
        <div class="badges-sub">Your Progress</div>
        <div class="badges-grid" id="badgeList"></div>
      </div>
    </div>
  </div>

  <!-- Avatar Picker Modal -->
  <div id="avatarModal" class="apple-modal">
  <div class="carousel-content">
    <button class="close-btn" id="closeAvatarModal">Close</button>
    <h3>Select Your Avatar</h3>
    <div class="carousel-arrows">
      <button id="carouselLeft" class="arrow-btn" tabindex="-1">&lt;</button>
      <div class="avatar-carousel" id="avatarCarousel">
        <!-- JS will fill in avatars here -->
      </div>
      <button id="carouselRight" class="arrow-btn" tabindex="-1">&gt;</button>
    </div>
  </div>
</div>


  <!-- KC Alert -->
  <div id="kcAlert" class="kc-alert" style="display:none"></div>

  <!-- Account Sidebar -->
  <div id="accountSidebar" class="sidebar">
    <div class="sidebar-header">
      <h2>Account Options</h2>
      <button class="close-btn" id="closeAccountSidebar">Close</button>
    </div>
    <button id="signOutBtn"    class="sidebar-btn">Sign Out</button>
    <button id="resetPassBtn"  class="sidebar-btn">Reset Password</button>
    <button id="deleteAcctBtn" class="sidebar-btn-red">Delete Account</button>
  </div>

  <!-- Admin Sidebar -->
  <div id="adminSidebar" class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Portal</h2>
      <button class="close-btn" id="closeAdminSidebar">Close</button>
    </div>
    <div id="adminAuthSection">
      <label>Admin Password</label>
      <input id="adminPass" type="password" placeholder="Password"/>
      <button id="adminLoginBtn" class="sidebar-btn">Enter</button>
    </div>
    <div id="adminContent" style="display:none">
      <label>Edit Badges For User:</label>
      <select id="userSelect"></select>
      <div style="display:flex;gap:7px;margin:12px 0;">
        <button data-badge="offence" class="sidebar-btn" id="addOffence">+ Offence</button>
        <button data-badge="defence" class="sidebar-btn" id="addDefence">+ Defence</button>
        <button data-badge="overall" class="sidebar-btn" id="addOverall">+ Overall</button>
      </div>
      <div style="display:flex;gap:7px;margin-bottom:12px;">
        <button data-badge="offence" class="sidebar-btn-red" id="remOffence">- Offence</button>
        <button data-badge="defence" class="sidebar-btn-red" id="remDefence">- Defence</button>
        <button data-badge="overall" class="sidebar-btn-red" id="remOverall">- Overall</button>
      </div>
      <button id="saveAdmin" class="sidebar-btn">Save Changes</button>
      <label style="margin-top:16px;">All Users & Badges:</label>
      <div class="admin-users-list" id="adminUsersList"><ul></ul></div>
    </div>
  </div>

  <!-- Delete Confirm Dialog -->
  <div id="confirmOverlay" class="confirm-overlay" style="display:none;">
    <div class="confirm-box">
      <div id="confirmMsg">Are you sure you want to delete your account?</div>
      <button class="confirm-btn" id="confirmYesBtn">Yes</button>
      <button class="confirm-btn cancel" id="confirmNoBtn">No</button>
    </div>
  </div>

  <script>
 // ========== FIREBASE INIT ==========
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.appspot.com",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth(), db = firebase.database();
    const actionCodeSettings = { url: window.location.origin + "/?mode=verifyEmail", handleCodeInApp:true };

    // ========== UI REFS ==========
    const authForms    = document.getElementById("authForms"),
          registerForm = document.getElementById("registerForm"),
          loginForm    = document.getElementById("loginForm"),
          regName      = document.getElementById("regName"),
          regEmail     = document.getElementById("regEmail"),
          regPass      = document.getElementById("regPass"),
          registerBtn  = document.getElementById("registerBtn"),
          loginEmail   = document.getElementById("loginEmail"),
          loginPass    = document.getElementById("loginPass"),
          loginBtn     = document.getElementById("loginBtn"),
          toLogin      = document.getElementById("toLogin"),
          toRegister   = document.getElementById("toRegister"),
          profileUI    = document.getElementById("profileUI"),
          welcomeUser  = document.getElementById("welcomeUser"),
          userCounter  = document.getElementById("userCounter"),
          badgeList    = document.getElementById("badgeList"),
          joinBadge    = document.getElementById("joinBadge"),
          badgesCard   = document.getElementById("badgesCard"),
          avatarBtn    = document.getElementById("avatarBtn"),
          avatarImg    = document.getElementById("avatarImg"),
          accountBtn   = document.getElementById("accountOptionsBtn"),
          adminBtn     = document.getElementById("adminPortalBtn"),
          accountSidebar   = document.getElementById("accountSidebar"),
          adminSidebar     = document.getElementById("adminSidebar"),
          closeAccountSidebar = document.getElementById("closeAccountSidebar"),
          closeAdminSidebar   = document.getElementById("closeAdminSidebar"),
          kcAlertDiv   = document.getElementById("kcAlert"),
          avatarModal  = document.getElementById("avatarModal"),
          closeAvatarModal = document.getElementById("closeAvatarModal"),
          avatarGrid   = document.getElementById("avatarGrid");

    // ========== KC ALERT ==========
    let alertTimeout;
    function kcAlert(txt, timeout=2350){
      kcAlertDiv.textContent=txt;
      kcAlertDiv.style.display="flex";
      kcAlertDiv.classList.remove("hide");
      if(alertTimeout) clearTimeout(alertTimeout);
      alertTimeout = setTimeout(()=>kcAlertDiv.classList.add("hide"), timeout);
    }

    // ========== SIDEBAR CONTROLS ==========
    accountBtn.onclick = ()=>accountSidebar.classList.add("open");
    closeAccountSidebar.onclick = ()=>accountSidebar.classList.remove("open");
    adminBtn.onclick = ()=>adminSidebar.classList.add("open");
    closeAdminSidebar.onclick = ()=>adminSidebar.classList.remove("open");
    document.addEventListener("mousedown", e=>{
      if(!accountSidebar.contains(e.target)&&e.target!==accountBtn) accountSidebar.classList.remove("open");
      if(!adminSidebar.contains(e.target)&&e.target!==adminBtn) adminSidebar.classList.remove("open");
    });

    // ========== TOGGLE FORMS ==========
    toLogin.onclick = ()=>{
      registerForm.style.display="none";
      loginForm.style.display="flex";
      kcAlertDiv.style.display="none";
    };
    toRegister.onclick = ()=>{
      loginForm.style.display="none";
      registerForm.style.display="flex";
      kcAlertDiv.style.display="none";
    };

    // ========== AUTH LOGIC ==========
    registerBtn.onclick = ()=>{
      const name=regName.value.trim(), email=regEmail.value.trim(), pass=regPass.value;
      if(!name||!email||!pass) return kcAlert("Fill all fields.");
      auth.createUserWithEmailAndPassword(email,pass)
        .then(u=>u.user.updateProfile({displayName:name}).then(()=>u.user))
        .then(u=>db.ref(`users/${u.uid}`).set({displayName:name,email,joined:firebase.database.ServerValue.TIMESTAMP}).then(()=>u))
        .then(u=>u.sendEmailVerification(actionCodeSettings))
        .then(()=>kcAlert("Verification email sent!"))
        .catch(e=>kcAlert(e.message));
    };
    loginBtn.onclick = ()=>{
      const email=loginEmail.value.trim(), pass=loginPass.value;
      if(!email||!pass) return kcAlert("Enter email and password!");
      auth.signInWithEmailAndPassword(email,pass)
        .then(res=>{
          if(!res.user.emailVerified){
            auth.signOut();
            throw new Error("Please verify your email before logging in.");
          }
        })
        .catch(e=>kcAlert(e.message));
    };

    // ========== ACCOUNT ACTIONS ==========
    document.getElementById("signOutBtn").onclick = ()=>auth.signOut().then(()=>kcAlert("Signed out"));
    document.getElementById("resetPassBtn").onclick = ()=>{
      const u=auth.currentUser; if(!u) return kcAlert("Not signed in");
      auth.sendPasswordResetEmail(u.email,{url:window.location.origin+"/?mode=resetPassword",handleCodeInApp:true})
        .then(()=>kcAlert("Password reset email sent"))
        .catch(e=>kcAlert(e.message));
    };
    document.getElementById("deleteAcctBtn").onclick = ()=>{
      document.getElementById("confirmMsg").textContent="Are you sure you want to delete your account?";
      document.getElementById("confirmOverlay").style.display="flex";
      document.getElementById("confirmYesBtn").onclick = ()=>{
        const u=auth.currentUser; if(!u) return;
        u.delete()
         .then(()=>{
           document.getElementById("confirmOverlay").style.display="none";
           kcAlert("Account deleted");
         })
         .catch(err=>{
           document.getElementById("confirmOverlay").style.display="none";
           if(err.code==="auth/requires-recent-login")
             kcAlert("Please sign out and back in before deleting.");
           else kcAlert(err.message);
         });
      };
      document.getElementById("confirmNoBtn").onclick = ()=>{
        document.getElementById("confirmOverlay").style.display="none";
      };
    };

    // ========== ADMIN PORTAL ==========
    let adminAuthenticated=false;
    document.getElementById("adminLoginBtn").onclick = ()=>{
      if(document.getElementById("adminPass").value==="events2025KC"){
        adminAuthenticated=true;
        document.getElementById("adminAuthSection").style.display="none";
        document.getElementById("adminContent").style.display="block";
        kcAlert("Admin authenticated");
        loadAllUsersToAdmin();
        refreshUserSelect();
      } else kcAlert("Wrong admin password");
    };
    function ensureAdmin(){return adminAuthenticated;}
    function refreshUserSelect(){
      db.ref("users").once("value").then(snap=>{
        const sel=document.getElementById("userSelect");
        sel.innerHTML="";
        snap.forEach(u=>{
          const o=document.createElement("option");
          o.value=u.key; o.textContent=u.val().displayName;
          sel.appendChild(o);
        });
      });
    }
    function loadAllUsersToAdmin(){
      Promise.all([db.ref("users").once("value"), db.ref("badges").once("value")])
        .then(([us,bad])=>{
          let html="<ul>";
          us.forEach(u=>{
            const b=bad.child(u.key).val()||{};
            html+=`<li><b>${u.val().displayName}</b>
              <span class="admin-badge-list">
                <span>üèÜ<span class="admin-badge-count">${b.overall||0}</span></span>
                <span>üî•<span class="admin-badge-count">${b.offence||0}</span></span>
                <span>üõ°Ô∏è<span class="admin-badge-count">${b.defence||0}</span></span>
              </span></li>`;
          });
          html+="</ul>";
          document.getElementById("adminUsersList").innerHTML=html;
        });
    }
    ["Offence","Defence","Overall"].forEach(type=>{
      document.getElementById("add"+type).onclick = ()=>{
        if(!ensureAdmin()) return;
        badgeChanges[type.toLowerCase()]++;
        kcAlert(`+1 ${type} staged (Save to apply)`);
      };
      document.getElementById("rem"+type).onclick = ()=>{
        if(!ensureAdmin()) return;
        badgeChanges[type.toLowerCase()]--;
        kcAlert(`-1 ${type} staged (Save to apply)`);
      };
    });
    let badgeChanges={offence:0,defence:0,overall:0};
    document.getElementById("saveAdmin").onclick = ()=>{
      if(!ensureAdmin()) return;
      const uid=document.getElementById("userSelect").value;
      db.ref("badges/"+uid).get().then(snap=>{
        const cur=snap.val()||{};
        const upd={};
        ["offence","defence","overall"].forEach(k=>{
          upd[k]=Math.max(0,(cur[k]||0)+badgeChanges[k]);
        });
        db.ref("badges/"+uid).set(upd).then(()=>{
          badgeChanges={offence:0,defence:0,overall:0};
          kcAlert("Badges updated");
          loadAllUsersToAdmin();
          if(auth.currentUser&&auth.currentUser.uid===uid)
            loadBadges(uid,auth.currentUser.emailVerified);
        });
      });
    };
    

    // ========== AUTH STATE & INIT AVATAR ==========
    auth.onAuthStateChanged(u=>{
      if(u){
        authForms.style.display="none";
        profileUI.style.display="block";
        badgesCard.style.display="flex";
        document.querySelector(".kc-title").textContent="KC Events";
        welcomeUser.innerHTML=`üëã <span style="color:#1992d4;">Welcome, ${u.displayName||u.email}</span>`;
        db.ref("users").once("value").then(s=>userCounter.textContent=`There are now ${s.numChildren()} users registered!`);
        db.ref(`users/${u.uid}/avatar`).once("value").then(snap=>{
          const url=snap.val()||"avatars/default.png";
          avatarImg.src=url; avatarImg.style.display="block";
        });
        loadBadges(u.uid,u.emailVerified);
      } else {
        authForms.style.display="flex";
        profileUI.style.display="none";
        badgesCard.style.display="none";
        avatarImg.style.display="none";
        document.querySelector(".kc-title").textContent="KC Events";
      }
    });
    
    // ----- AVATAR CAROUSEL LOGIC -----
const avatarImgs = [
  "1.png","2.png","3.png","4.png","5.png","6.png","7.png","13.png","9.png","10.png","11.png","12.png"
].map(n => `https://kevinmidnight7-sudo.github.io/messageboardkc/${n}`);

const avatarCarousel = document.getElementById("avatarCarousel");

// Populate avatars horizontally (once)
function renderAvatars(selectedUrl) {
  avatarCarousel.innerHTML = "";
  avatarImgs.forEach(url => {
    const div = document.createElement("div");
    div.className = "avatar-item";
    div.innerHTML = `<img src="${url}" alt="Avatar">`;
    if (url === selectedUrl) div.classList.add('selected');
    div.onclick = function() {
      document.querySelectorAll('.avatar-carousel .avatar-item').forEach(el=>el.classList.remove('selected'));
      div.classList.add('selected');
      const user = auth.currentUser;
      if(user) {
        db.ref(`users/${user.uid}/avatar`).set(url)
          .then(()=>{
            avatarImg.src = url;
            avatarImg.style.display = "block";
            kcAlert("Avatar updated!");
            setTimeout(()=>avatarModal.classList.remove("open"),450);
          });
      } else kcAlert("Please log in to set an avatar.");
    };
    avatarCarousel.appendChild(div);
  });
}

// Show selected avatar if exists on modal open
avatarBtn.onclick = ()=> {
  if (!auth.currentUser) return kcAlert("Please log in first.");
  db.ref(`users/${auth.currentUser.uid}/avatar`).once("value").then(snap=>{
    renderAvatars(snap.val());
    avatarModal.classList.add("open");
    setTimeout(()=>{
      // Scroll to selected avatar in carousel
      let selected = document.querySelector('.avatar-carousel .avatar-item.selected');
      if(selected) selected.scrollIntoView({inline:"center",behavior:"smooth"});
    },50);
  });
};
closeAvatarModal.onclick = ()=>avatarModal.classList.remove("open");
avatarModal.addEventListener("mousedown",e=>{
  if(!e.target.closest(".carousel-content"))
    avatarModal.classList.remove("open");
});
// Carousel arrows
document.getElementById('carouselLeft').onclick = ()=>{
  avatarCarousel.scrollBy({left:-110,behavior:'smooth'});
};
document.getElementById('carouselRight').onclick = ()=>{
  avatarCarousel.scrollBy({left:110,behavior:'smooth'});
};
// Optional: handle swipe on mobile for extra smoothness
let startX=0, scrollLeft=0, isDown=false;
avatarCarousel.addEventListener('pointerdown', e=>{
  isDown=true; startX=e.pageX; scrollLeft=avatarCarousel.scrollLeft;
});
avatarCarousel.addEventListener('pointerup', ()=>isDown=false);
avatarCarousel.addEventListener('pointerleave', ()=>isDown=false);
avatarCarousel.addEventListener('pointermove', e=>{
  if(!isDown) return;
  e.preventDefault();
  const walk = (e.pageX-startX)*1.2;
  avatarCarousel.scrollLeft = scrollLeft - walk;
});


    // ========== BADGES LOGIC ==========
    function loadBadges(uid,verified){
      badgeList.innerHTML=""; joinBadge.innerHTML="";
      const verifiedBox=document.createElement("div");
      verifiedBox.className="badge-item verified"; verifiedBox.tabIndex=0;
      if(verified){
        verifiedBox.innerHTML=`
          <span style="font-size:2.2em;color:#fff;margin-bottom:3px;">‚úîÔ∏è</span>
          <span class="badge-label">VERIFIED</span>`;
        verifiedBox.style.background="linear-gradient(90deg,#10b981 70%,#22e67b 120%)";
        verifiedBox.onmouseover=()=>{verifiedBox.style.boxShadow="0 0 18px #18e178cc,0 4px 14px #18e17844";verifiedBox.style.transform="translateY(-3px) scale(1.045)";};
        verifiedBox.onmouseleave=()=>{verifiedBox.style.boxShadow="";verifiedBox.style.transform="";};
      } else {
        verifiedBox.classList.add("locked");
        verifiedBox.innerHTML=`
          <span style="font-size:2.2em;color:#aaa;margin-bottom:3px;">‚ùå</span>
          <span class="badge-label">Not Verified</span>
          <span class="lock-icon">üîí</span>`;
        verifiedBox.style.background="linear-gradient(90deg,#cfd8dc 65%,#eceff1 120%)";
        verifiedBox.onmouseover=()=>{verifiedBox.style.boxShadow="0 0 12px #bbb8,0 1px 6px #aaa4";};
        verifiedBox.onmouseleave=()=>{verifiedBox.style.boxShadow="";};
        verifiedBox.onclick=()=>{
          auth.currentUser.sendEmailVerification(actionCodeSettings)
            .then(()=>kcAlert("Verification email resent!"))
            .catch(e=>kcAlert(e.message));
        };
      }
      badgeList.appendChild(verifiedBox);

      const specs={
        offence:{label:"Best Offence", icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/red.png", cls:"offence", grad:"linear-gradient(90deg,#fa5252 80%,#fbba34 120%)"},
        defence:{label:"Best Defence",icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png",cls:"defence",grad:"linear-gradient(90deg,#3b82f6 80%,#60a5fa 120%)"},
        overall:{label:"Overall Winner",icon:"https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png",cls:"overall",grad:"linear-gradient(90deg,#e1ab33 70%,#ffe184 120%)"}
      };
      db.ref(`badges/${uid}`).once("value").then(snap=>{
        Object.entries(specs).forEach(([k,s])=>{
          const cnt=(snap.val()||{})[k]||0;
          const el=document.createElement("div");
          el.className=`badge-item ${s.cls}${cnt?"":" locked"}`; el.tabIndex=0;
          el.innerHTML=`<img src="${s.icon}" alt="${s.label}"/><span class="badge-label">${s.label}</span>`;
          if(cnt){
            el.innerHTML+=`<span class="badge-mult">x${cnt}</span>`;
            el.style.background=s.grad;
            const glow=k==="offence"? "#ef4744cc": k==="defence"? "#4489f6cc": "#e8be31cc";
            el.onmouseover=()=>{el.style.boxShadow=`0 0 18px ${glow},0 4px 14px ${glow}77`;el.style.transform="translateY(-3px) scale(1.045)";};
            el.onmouseleave=()=>{el.style.boxShadow="";el.style.transform="";};
          } else {
            el.innerHTML+=`<span class="lock-icon">üîí</span>`;
            el.onmouseover=()=>{el.style.boxShadow="0 0 12px #aaa8,0 1px 6px #aaa4";};
            el.onmouseleave=()=>{el.style.boxShadow="";};
          }
          badgeList.appendChild(el);
        });

        db.ref(`users/${uid}`).once("value").then(uSnap=>{
          const joined=uSnap.val()?.joined;
          const dateStr=joined? new Date(joined).toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"}):"Unknown";
          db.ref("users").orderByChild("joined").endAt(joined).once("value").then(r=>{
            const rank=r.numChildren();
            let txt="",cls="";
            if(rank<=30){txt="Early Supporter";cls="early";}
            else if(rank<=60){txt="Supporter";cls="supporter";}
            else{txt="New Generation";cls="newgen";}
          
          });
        });
      });
    }  </script>
</body>
</html>
