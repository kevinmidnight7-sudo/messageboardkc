<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Voting</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* Animated Gradient Keyframes */
    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      /* Bonus: Full-page glass effect background */
      background:transparent;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
    }
    /* Bonus: Full-page glass effect overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: -1;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      pointer-events: none;
    }

    .grid-container {
      display: flex;
      gap: 2.5rem;
      margin-top: 2.5rem;
      margin-bottom: 1.7rem;
      z-index: 1;
    }
    /* 1. Enhanced Glassmorphism on Panels & Cards */
    .panel, .leaderboard {
      width: 560px;
      min-width: 480px;
      border-radius: 24px;
      padding: 2rem 1.3rem 1.5rem 1.3rem;
      background: rgba(255, 255, 255, 0.18); /* Updated background */
      backdrop-filter: blur(20px) saturate(180%); /* Updated backdrop-filter */
      -webkit-backdrop-filter: blur(20px) saturate(180%); /* Updated -webkit-backdrop-filter */
      border: 1.5px solid rgba(255,255,255,0.25); /* Updated border */
      box-shadow: 0 8px 40px 0 rgba(18,40,80,0.16), 0 1.5px 12px 0 rgba(60,100,160,0.08); /* Updated box-shadow */
      background-image: linear-gradient(120deg, rgba(255,255,255,0.13) 0%, rgba(200,225,255,0.08) 100%); /* New background-image */
      box-sizing: border-box;
      position: relative;
    }
    .panel h2, .leaderboard h3 {
      font-size: 1.45rem;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #fff;
      text-shadow: 0 2px 10px #21325422;
      letter-spacing: 0.02em;
    }
    /* 2. Animated Gradient Highlights for section headers */
    .gradient-header {
      background: linear-gradient(90deg, #76e4ff 0%, #a788ff 50%, #f7a5ff 100%);
      background-size: 200% 200%;
      animation: gradientMove 4s ease-in-out infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    label {
      display: block;
      margin: 1rem 0 .3rem;
      font-weight: 600;
      color: #fff;
      font-size: 1.02em;
    }
    .hint {
      font-size: .83rem;
      color: #b5bbd7;
      margin-bottom: .7rem;
      margin-left: .05rem;
    }
    input[readonly], input[type=password], select {
      width: 100%;
      padding: .65rem;
      border: none;
      border-radius: 12px;
      margin-top: .2rem;
      box-sizing: border-box;
      background: rgba(252,252,255,0.15);
      color: #fff;
      font-size: 1.01em;
      letter-spacing: 0.01em;
      outline: none;
      transition: background 0.12s;
    }
    input[readonly] { font-weight: 600; letter-spacing: 0.02em; }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='10' height='7' viewBox='0 0 10 7' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23b5bbd7' stroke-width='2'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right .7rem center;
      background-size: .7rem;
    }
    .stars {
      display: flex;
      gap: .3rem;
      margin: .6rem 0 1rem;
    }
    .stars span {
      font-size: 1.55rem;
      cursor: pointer;
      color: #d8dbe7;
      transition: color 0.18s;
    }
    .stars .filled {
      color: #ffd700;
      text-shadow: 0 3px 9px #fdcb0b77;
    }
    button {
      width: 100%;
      padding: .75rem;
      background: linear-gradient(90deg,#7ed2fa 0%,#8be3c2 100%);
      color: #2c3143;
      border: none;
      border-radius: 12px;
      font-size: 1.12rem;
      font-weight: 700;
      margin-top: 1.1rem;
      cursor: pointer;
      transition: background .15s, color .15s, box-shadow .14s, opacity .12s;
      box-shadow: 0 2px 12px #b9e7ff33;
      opacity: 1;
      letter-spacing: .01em;
    }
    button:disabled {
      opacity: .62;
      background: #b7c7d0 !important;
      color: #88949c !important;
      cursor: not-allowed;
    }

    /* 5. Frosted Glass Button & Icon Styles */
    #adminIconBtn {
      position: absolute;
      top: 18px;
      right: 18px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255,255,255,0.19); /* Glass button background */
      border: 1.4px solid rgba(255,255,255,0.21); /* Glass button border */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(120,180,255,0.14); /* Glass button shadow */
      backdrop-filter: blur(8px); /* Glass button backdrop-filter */
      transition: box-shadow 0.18s, background 0.13s, transform 0.2s ease; /* Added transform for hover */
      z-index: 10;
      padding: 0;
    }
    #adminIconBtn:hover {
      background: rgba(200,240,255,0.25); /* Glass button hover background */
      box-shadow: 0 6px 24px #90f5ffd2; /* Glass button hover shadow */
      transform: scale(1.07); /* Glass button hover transform */
    }
    #adminIconBtn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      border-radius: 50%;
    }

    /* 1. Enhanced Glassmorphism on Leaderboard */
    .leaderboard {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(255, 255, 255, 0.18); /* Updated background */
      backdrop-filter: blur(20px) saturate(180%); /* Updated backdrop-filter */
      -webkit-backdrop-filter: blur(20px) saturate(180%); /* Updated -webkit-backdrop-filter */
      border: 1.5px solid rgba(255,255,255,0.25); /* Updated border */
      box-shadow: 0 8px 40px 0 rgba(18,40,80,0.16), 0 1.5px 12px 0 rgba(60,100,160,0.08); /* Updated box-shadow */
      background-image: linear-gradient(120deg, rgba(255,255,255,0.13) 0%, rgba(200,225,255,0.08) 100%); /* New background-image */
    }
    .lb-group {
      width: 92%;
      border-radius: 20px;
      padding: 1.05rem 1.25rem .85rem 1.25rem;
      margin-bottom: 1.2rem;
      background: rgba(10,14,23,0.76); /* Original background, can be updated for more glass effect */
      box-shadow: 0 6px 40px #cfdef755;
      border: 2px solid rgba(140,145,170,0.13);
      transition: box-shadow .19s, transform .16s;
    }
    .offenseBox {
      border: 2px solid #fc718c;
      box-shadow: 0 0 0 transparent;
      margin-bottom: 1.0rem;
    }
    .defenseBox {
      border: 2px solid #53a4ff;
      box-shadow: 0 0 0 transparent;
      margin-bottom: 0;
    }
    .lb-group:hover {
      transform: translateY(-3px) scale(1.017);
      /* 4. Subtle Glow & Neon Edge Effects for highlighted cards */
      box-shadow: 0 0 24px 4px rgba(120,170,255,0.18), 0 1.5px 8px 0 rgba(120,220,255,0.13);
      z-index: 2;
    }
    .offenseBox:hover { box-shadow: 0 8px 38px #ff436899, 0 1.5px 8px #f48ca8bb; }
    .defenseBox:hover { box-shadow: 0 8px 38px #32a7ff99, 0 1.5px 8px #86caffbb; }

    .sectionTitle {
      display: flex; align-items: center;
      font-size: 1.13rem; font-weight: 700;
      margin-bottom: .7rem; margin-top: -.1rem;
    }
    .sectionTitle img.icon {
      width: 27px; height: 27px; margin-right: .6rem;
      /* 4. Subtle Glow & Neon Edge Effects for trophy/medal icons */
      filter: drop-shadow(0 0 7px #ffd70077);
    }
    .offenseBox .sectionTitle {
      color: #fc718c;
      text-shadow: 0 2px 10px #ff7c9951;
    }
    .defenseBox .sectionTitle {
      color: #4ba7ff;
      text-shadow: 0 2px 10px #1a7cda77;
    }
    .leaderboard ul {
      list-style: none; padding: 0; margin: 0;
    }
    .leaderboard li {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 1.01rem;
      transition: background .13s, color .14s;
      border-radius: 7px;
    }
    .leaderboard li:last-child { margin-bottom: 0; }
    .first-place .name {
      background: linear-gradient(45deg,#ffe484,#ffc93a 80%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 2.07rem;
      font-weight: 800;
    }
    .second-place .name {
      background: linear-gradient(45deg,#dbe8fc,#8e9cae 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.37rem;
      font-weight: 700;
    }
    .third-place .name {
      background: linear-gradient(45deg,#fbc28b,#c38348 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.09rem;
      font-weight: 700;
    }
    .name, .count { display: inline-block; }
    .name { transition: font-size 0.3s; }
    .count { font-weight: 600; font-size: 1.09rem; margin-left: auto; color: #fff; padding-right: 5px; }
    .leaderboard li:not(.first-place):not(.second-place):not(.third-place) .name {
      color: #e8ebfc;
      font-size: 1.06rem;
      background: none;
      font-weight: 600;
    }
    .leaderboard li .avatar-small {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 1.5px solid rgba(255,255,255,0.7);
    }
    .leaderboard li .list-item-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.6rem 1.25rem;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      box-sizing: border-box;
    }
    .leaderboard li:hover .list-item-content {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    /* 4. Subtle Glow & Neon Edge Effects for active/selected state */
    .glass-active {
      border: 1.7px solid #8efbff88;
      box-shadow: 0 0 16px 2px #a9eeff77;
      transition: box-shadow 0.22s, border 0.19s;
    }
    .leaderboard li.first-place:not(.diamond-member-entry) .list-item-content,
    .leaderboard li.second-place:not(.diamond-member-entry) .list-item-content,
    .leaderboard li.third-place:not(.diamond-member-entry) .list-item-content {
        background: rgba(255,255,255,0.08);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .leaderboard li.diamond-member-entry .list-item-content {
        background: var(--custom-gradient-bg);
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        border: none;
    }
    .leaderboard li.diamond-member-entry .background-banner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        opacity: 0.15;
        z-index: 0;
        border-radius: 12px;
    }
    .name-and-avatar {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .leaderboard li.diamond-member-entry .avatar-small {
        width: 32px;
        height: 32px;
        border: 2px solid rgba(255,255,255,0.8);
    }
    .leaderboard li.diamond-member-entry .name {
        font-weight: 700;
        font-size: 1.1em;
    }
    .leaderboard li.diamond-member-entry .count {
        font-weight: 600;
        font-size: 1.1em;
        margin-left: auto;
        padding-right: 0;
        position: relative;
        z-index: 1;
    }

    #leaderboardContainer { width: 100%; }
    #leaderboardContent { display: block; }
    #podiumContent, #tilesContent { display: none; }
    #leaderboardOffMessage { display: none; text-align: center; padding: 2rem 1rem; }
    .offMessage { color: #fff; text-shadow: 0 0 10px #fff8; font-size: 1.28rem; font-weight: 600; }
    .offSubtitle { color: #fff; font-style: italic; margin-top: 0.5rem; font-size: 1rem; }

    /* 3. Elevate Stat Blocks & Badges with Glass Cards */
    .glass-stat-block {
      background: rgba(255,255,255,0.13);
      border: 1.2px solid rgba(255,255,255,0.18);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(80,140,255,0.07);
      backdrop-filter: blur(8px) saturate(170%);
      padding: 0.5rem 1.1rem;
      margin: 0.2rem 0.2rem;
      display: inline-block;
      min-width: 90px;
      color: #fff; /* Ensure text is visible on glass */
    }
    .glass-stat-block .stat-title {
      font-size: 0.9em;
      font-weight: 500;
      opacity: 0.8;
      display: block;
    }
    .glass-stat-block .stat-value {
      font-size: 1.5em;
      font-weight: 700;
      color: #ffd700; /* Gold color for values */
      display: block;
    }

    #eventRating {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 380px;
      margin: 0 auto 2.3rem auto;
      text-align: center;
      font-size: 1.17rem;
      background: rgba(17,18,25,0.57);
      border-radius: 16px;
      padding: 1.03rem 0 .9rem 0;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #fff;
      box-shadow: 0 4px 20px #c6dbef18;
      position: relative;
      z-index: 10;
    }
    #eventRating span {
      font-size: 1.15em;
      color: #ffe484;
      font-weight: 700;
      margin: 0 .14em 0 .1em;
      letter-spacing: .01em;
    }
    /* Apple modal */
    #adminModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9000;
      background: rgba(24, 27, 38, 0.47);
      align-items: center;
      justify-content: center;
      transition: opacity .18s;
    }
    #adminModal.active { display: flex; }
    #adminModalContent {
      min-width: 360px;
      max-width: 97vw;
      max-height: 80vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.91);
      border-radius: 24px;
      box-shadow: 0 8px 64px #c9e6ff99;
      padding: 2rem 1.4rem 1.5rem 1.4rem;
      position: relative;
      color: #181b29;
      font-family: 'Poppins',sans-serif;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      animation: modalIn .18s cubic-bezier(.62,1.51,.5,1) 1;
    }
    @keyframes modalIn {
      from { transform: translateY(32px) scale(.98); opacity: 0; }
      to  { transform: none; opacity: 1; }
    }
    #adminModalContent h3 {
      margin-top: 0; margin-bottom: 1.1rem;
      font-size: 1.36rem; font-weight: 700; color: #19213b;
    }
    #adminClose {
      position: absolute; top: 18px; right: 18px;
      background: #e5e5f7; border-radius: 100px;
      font-size: 1.13em; border: none; color: #6c718c;
      font-weight: 700; padding: .25em .75em;
      cursor: pointer; box-shadow: 0 2px 8px #cbe6ff44;
      transition: background .14s;
    }
    #adminClose:hover { background: #e4eaff; color: #21314e; }
    #adminTableContainer {
      max-height: 30vh; overflow: auto; border-radius: 14px; width: 100%;
      margin: .7rem 0 .3rem 0; border: 1.2px solid #dde6f3;
      background: #fafcff;
      box-shadow: 0 2px 13px #bed0ec25;
    }
    #adminTableContainer table { width: 100%; border-collapse: collapse; }
    #adminTableContainer th, #adminTableContainer td {
      padding: .62rem .35rem;
      font-size: .97rem;
      text-align: left;
      color: #181b29;
      border-bottom: 1px solid #dde3ef;
    }
    #adminTableContainer th {
      background: #e9f2fe;
      font-weight: 700;
    }
    #adminTableContainer tr:last-child td { border-bottom: none; }
    .delBtn {
      background: #fd5976;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: .37rem .97rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.05em;
      transition: background .12s;
      box-shadow: 0 1px 5px #fd597655;
    }
    .delBtn:hover { background: #c42a49; }
    #adminControls { margin:1.3rem 0 1.4rem 0; }
    #unlockBtn {
      width: auto;
      padding: .54rem 1.3rem;
      border-radius: 8px;
      background: linear-gradient(90deg,#7ed2fa 0%,#8be3c2 100%);
      color: #16343b; font-weight: 700;
      font-size: 1.07em;
      margin-top: .3rem;
    }
    #unlockBtn:hover {
      background: linear-gradient(90deg,#c1f7f8 0%,#c9d2fa 100%);
      color: #181b29;
    }
    #resetBtn {
      background: #e04f69; color: #fff; font-weight: 700;
      border-radius: 10px; font-size: 1.05em;
      margin-top: 1.1rem;
    }
    #resetBtn:hover { background: #a92638; }
    #adminPass {
      background: #f3f8fc; color: #233046;
      border-radius: 9px; font-weight: 600;
      margin-bottom: .7rem;
      margin-top: .3rem;
      width: 100%;
      font-size: 1.1em;
      border: 1.2px solid #d3d8ef;
      letter-spacing: 0.04em;
    }
    /* Modal Overlay Z */
    #alertModal { z-index: 9100; }
    @media (max-width: 950px) {
      .grid-container { flex-direction: column; gap: 1.3rem; }
      .panel, .leaderboard { width: 97vw; min-width: 0; max-width: 99vw; }
      #eventRating { width: 99vw; }
      #adminModalContent { min-width: 92vw; }
    }
    @media (max-width: 670px) {
      .panel, .leaderboard { padding: 1.1rem .4rem; }
      .lb-group { padding: .6rem .45rem; }
      #eventRating { font-size: .98rem; }
    }
    #alertModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.28);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #alertContent {
      background: #fff;
      color: #233046;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 3px 34px #c9defb65;
      max-width: 320px;
      width: 90%;
      font-size: 1.13em;
      padding: 1.5rem 1rem 1.2rem 1rem;
    }

    select, select option {
      color: #222 !important;
      background: #fff !important;
    }
    #alertModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.28);
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #alertContent {
      background: #fff;
      color: #233046;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 3px 34px #c9defb65;
      max-width: 320px;
      width: 90%;
      font-size: 1.13em;
      padding: 1.5rem 1rem 1.2rem 1rem;
    }

    /* Styles for the new dropdown view selector */
    .view-selector-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 1rem;
      width: 92%;
    }
    .view-mode-display {
        background: rgba(252,252,255,0.15);
        border-radius: 12px;
        padding: 0.5rem 1rem;
        color: #fff;
        font-size: 1.1em;
        font-weight: 600;
        min-width: 100px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: background 0.3s ease, transform 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    .view-mode-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    .view-mode-display.animate::before {
        left: 100%;
    }
    .view-selector-arrow {
        background: rgba(252,252,255,0.1);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        color: #fff;
        font-size: 1.5em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease, transform 0.2s ease;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .view-selector-arrow:hover {
        background: rgba(252,252,255,0.2);
        transform: scale(1.1);
    }
    .view-selector-arrow:active {
        transform: scale(0.9);
    }


    /* Styles for the new podium view */
    #podiumContent {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }
    .offensePodium, .defensePodium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      padding: 1.5rem 0;
    }
    .podium-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
    }
    .podium-item .avatar-small {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 5px;
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .podium-item .name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-top: 5px;
    }
    .podium-item .count {
      display: none;
    }
    .podium-item .name, .podium-item .count {
      text-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }
    .podium-item.gold .name {
      background: linear-gradient(45deg,#ffe484,#ffc93a 80%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 2.2rem;
    }
    .podium-item.silver .name {
      background: linear-gradient(45deg,#dbe8fc,#8e9cae 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.6rem;
    }
    .podium-item.bronze .name {
      background: linear-gradient(45deg,#fbc28b,#c38348 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.3rem;
    }

    .podium-stand {
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.2));
      border-radius: 10px;
      width: 80px;
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
      top: 10px;
      transition: all 0.3s ease, box-shadow 0.3s ease;
    }

    .podium-stand.gold {
      height: 140px;
      width: 100px;
      background: linear-gradient(135deg, #FFD700, #b8860b);
      box-shadow: 0 6px 16px rgba(255,215,0,0.5);
    }
    .podium-stand.silver {
      height: 110px;
      width: 90px;
      background: linear-gradient(135deg, #C0C0C0, #a0a0a0);
      box-shadow: 0 4px 12px rgba(192,192,192,0.5);
    }
    .podium-stand.bronze {
      height: 80px;
      width: 80px;
      background: linear-gradient(135deg, #CD7F32, #8B4513);
      box-shadow: 0 4px 12px rgba(205,127,50,0.5);
    }
    .podium-stand.custom-gradient {
        background-image: var(--custom-podium-gradient, linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.2)));
        box-shadow: 0 4px 12px var(--custom-podium-shadow-color, rgba(0,0,0,0.2));
    }

    .podium-stand span {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .podium-stand.gold span { font-size: 2rem; }
    .podium-stand.silver span { font-size: 1.7rem; }
    .podium-stand.bronze span { font-size: 1.5rem; }

    .podium-stand.gold:hover { box-shadow: 0 0 25px #ffd700, 0 0 40px #ffd700; }
    .podium-stand.silver:hover { box-shadow: 0 0 25px #C0C0C0, 0 0 40px #C0C0C0; }
    .podium-stand.bronze:hover { box-shadow: 0 0 25px #CD7F32, 0 0 40px #CD7F32; }
    .podium-stand.custom-gradient:hover {
        box-shadow: 0 0 25px var(--custom-podium-glow-color, #fff), 0 0 40px var(--custom-podium-glow-color, #fff);
    }


    /* Styles for the new tiles view */
    .tiles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      padding: 1rem 0;
      justify-content: center;
    }
    .tile-item {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      box-sizing: border-box;
    }
    .tile-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .tile-item .avatar-small {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 8px auto;
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .tile-item .name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 5px;
      text-align: center;
    }
    .tile-item .count {
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      padding: 4px 10px;
      margin-top: 5px;
      display: inline-block;
    }
    .diamond-member-entry {
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        box-sizing: border-box;
        min-height: 120px;
        background: none;
    }
    .diamond-member-entry .background-banner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 25%;
        background-size: cover;
        background-position: center;
        opacity: 0.9;
        z-index: 0;
        border-radius: 15px 15px 0 0;
    }
    .tile-item.diamond-member-entry .gradient-area {
        position: absolute;
        top: 25%;
        left: 0;
        width: 100%;
        height: 75%;
        z-index: 0;
        border-radius: 0 0 15px 15px;
    }

    .diamond-member-entry .content-wrapper {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }
    .leaderboard li.diamond-member-entry {
        flex-direction: row;
        justify-content: flex-start;
        align-items: center;
        min-height: auto;
    }
    .leaderboard li.diamond-member-entry .content-wrapper {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        height: auto;
    }

    .diamond-member-entry .name-and-avatar {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
    }
    .diamond-member-entry .avatar-small {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 1.5px solid rgba(255,255,255,0.7);
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        margin: 0;
    }
    .diamond-member-entry .name {
        font-weight: 700;
        font-size: 1.1em;
    }
    .diamond-member-entry .count {
        font-weight: 600;
        font-size: 1.1em;
        margin-top: 0;
    }


    /* Responsive styles for podium */
    @media (max-width: 670px) {
      .leaderboard .offensePodium, .leaderboard .defensePodium {
        flex-direction: column;
        align-items: center;
      }
      .podium-item { margin-bottom: 15px; }
      .podium-stand.gold { width: 80px; height: 110px; }
      .podium-stand.silver { width: 70px; height: 90px; }
      .podium-stand.bronze { width: 60px; height: 70px; }
    }

    /* --- Profile Card Overall Structure --- */
    .voted-profile-card {
      position: relative;
      border-radius: 20px;
      background: none;
      overflow: hidden;
      text-align: center;
      width: 100%;
      min-width: 510px;
      max-width: 440px;
      margin: 5rem auto 0 auto;
      /* 1. Enhanced Glassmorphism for profile card */
      background: rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1.5px solid rgba(255,255,255,0.25);
      box-shadow: 0 8px 40px 0 rgba(18,40,80,0.16), 0 1.5px 12px 0 rgba(60,100,160,0.08);
      background-image: linear-gradient(120deg, rgba(255,255,255,0.13) 0%, rgba(200,225,255,0.08) 100%);
    }
    .voted-profile-banner {
      width: 100%;
      height: 130px;
      background-size: cover;
      background-position: center;
      border-radius: 20px 20px 0 0;
      position: relative;
      z-index: 1;
      opacity: 0.9;
      background-color: #cbd5e1;
    }
    .voted-profile-gradient-area {
      width: 100%;
      min-height: 220px;
      background: linear-gradient(180deg, #ff00cc 0%, #333399 100%);
      border-radius: 0 0 20px 20px;
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* --- Avatar bridges banner and gradient --- */
    .voted-profile-avatar {
      width: 95px;
      height: 95px;
      border-radius: 50%;
      border: 5px solid #fff;
      object-fit: cover;
      box-shadow: 0 8px 32px 0 #19203c29;
      background: #222;
      margin-top: -45px;
      z-index: 10;
    }
    /* --- Content (name & stats) inside gradient --- */
    .voted-profile-content-wrapper {
      margin-top: 18px;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      height: 385px;
    }
    .voted-profile-username {
      font-size: 2.1rem;
      font-weight: 700;
      margin-top: 7px;
      margin-bottom: 18px;
      color: #fff;
      text-shadow: 0 2px 14px rgba(0,0,0,0.12);
      z-index: 2;
    }
    .voted-profile-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      width: 80%;
      margin-top: 10px;
      position: relative;
      z-index: 1;
    }
    .stat-item:last-child {
      grid-column: span 2;
      text-align: center;
      margin-top: 15px;
    }
    /* Removed .stat-value styling here as it's now handled by .glass-stat-block .stat-value */
  </style>
</head>
<body>
  <!-- ALERT / CONFIRM OVERLAY -->
  <div id="alertModal">
    <div id="alertContent">
      <strong>KC Event says</strong>
      <p id="alertMsg"></p>
      <div id="confirmBtns" class="confirmButtons" style="display:none;">
        <button class="no">Cancel</button>
        <button class="yes">OK</button>
      </div>
      <button id="alertOK">OK</button>
    </div>
  </div>

  <!-- Apple-style Admin Modal -->
  <div id="adminModal">
    <div id="adminModalContent">
      <button id="adminClose">×</button>
      <h3>KC Admin Panel</h3>
      <label>Enter admin password</label>
      <input type="password" id="adminPass"/>
      <button id="unlockBtn">Unlock Admin</button>
      <div id="adminControls"></div>
      <div id="adminTableContainer">
        <table id="adminTable"></table>
      </div>
      <button id="resetBtn">Reset Votes</button>
    </div>
  </div>

  <!-- Main grid: 2x2 voting + leaderboard -->
  <div class="grid-container">
    <div class="panel">
      <h2 class="gradient-header">KC Event Voting</h2> <!-- Applied gradient-header -->
      <div id="voteContainer"><p>Loading…</p></div>
      <!-- Admin button as a circular icon -->
      <button id="adminIconBtn">
        <img src="https://github.com/kevinmidnight7-sudo/messageboardkc/blob/main/Admin.png?raw=true" alt="Admin Icon"/>
      </button>
    </div>
    <div class="leaderboard">
      <h3 class="gradient-header">Live Scores:</h3> <!-- Applied gradient-header -->
      <div class="view-selector-container">
        <button id="viewLeftArrow" class="view-selector-arrow glass-btn">&lt;</button> <!-- Added glass-btn -->
        <div id="viewModeDisplay" class="view-mode-display">List</div>
        <button id="viewRightArrow" class="view-selector-arrow glass-btn">&gt;</button> <!-- Added glass-btn -->
      </div>
      <div id="leaderboardContainer">
        <!-- Podium View -->
        <div id="podiumContent">
          <div class="lb-group offenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png" class="icon" alt="Offense Icon"/>
              <strong>Best Offence Podium</strong>
            </div>
            <div id="offensePodium" class="offensePodium"></div>
          </div>
          <div class="lb-group defenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png" class="icon" alt="Defense Icon"/>
              <strong>Best Defence Podium</strong>
            </div>
            <div id="defensePodium" class="defensePodium"></div>
          </div>
        </div>

        <!-- Tiles View -->
        <div id="tilesContent">
          <div class="lb-group offenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png" class="icon" alt="Offense Icon"/>
              <strong>Best Offence Tiles</strong>
            </div>
            <div id="offenseTiles" class="tiles-grid"></div>
          </div>
          <div class="lb-group defenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png" class="icon" alt="Defense Icon"/>
              <strong>Best Defence Tiles</strong>
            </div>
            <div id="defenseTiles" class="tiles-grid"></div>
          </div>
        </div>

        <!-- List View (Default) -->
        <div id="leaderboardContent">
          <div class="lb-group offenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png" class="icon" alt="Offense Icon"/>
              <strong>Best Offence</strong>
            </div>
            <ul id="offenseScores"><li>Loading…</li></ul>
          </div>
          <div class="lb-group defenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png" class="icon" alt="Defense Icon"/>
              <strong>Best Defence</strong>
            </div>
            <ul id="defenseScores"><li>Loading…</li></ul>
          </div>
        </div>

        <div id="leaderboardOffMessage">
          <div class="offMessage">The Live Leaderboard is currently offline.</div>
          <div class="offSubtitle">You can still vote! The leaderboard will be reactivated when the host decides.</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Centered event rating under grid -->
  <div id="eventRating">
    Overall Event Rating: <span id="avgRatingNum">–</span>/5 ⭐
  </div>
  <script>
    // Modal helpers
    const alertModal = document.getElementById('alertModal'),
          alertMsg   = document.getElementById('alertMsg'),
          alertOK    = document.getElementById('alertOK'),
          confirmBtns= document.getElementById('confirmBtns');
    function kcAlert(msg){
      confirmBtns.style.display  = 'none';
      alertOK.style.display      = 'inline-block';
      alertMsg.textContent       = msg;
      alertModal.style.display   = 'flex';
    }
    function kcConfirm(msg){
      return new Promise(resolve=>{
        alertMsg.textContent       = msg;
        alertOK.style.display      = 'none';
        confirmBtns.style.display  = 'flex';
        alertModal.style.display   = 'flex';
        confirmBtns.querySelector('.no').onclick  = ()=>{ alertModal.style.display='none'; resolve(false); };
        confirmBtns.querySelector('.yes').onclick = ()=>{ alertModal.style.display='none'; resolve(true); };
      });
    }
    alertOK.onclick = ()=> alertModal.style.display='none';

    // Admin Modal
    const adminIconBtn = document.getElementById('adminIconBtn'),
          adminModal   = document.getElementById('adminModal'),
          adminClose   = document.getElementById('adminClose'),
          adminPass    = document.getElementById('adminPass'),
          unlockBtn    = document.getElementById('unlockBtn'),
          adminControls= document.getElementById('adminControls'),
          adminTable   = document.getElementById('adminTable'),
          resetBtn     = document.getElementById('resetBtn'),
          adminTableContainer = document.getElementById('adminTableContainer');
    adminIconBtn.onclick = () => { adminModal.classList.add('active'); };
    adminClose.onclick = () => { adminModal.classList.remove('active'); };

    // Firebase init
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebaseapp.com",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth        = firebase.auth(),
          votesRef    = firebase.database().ref('votes'),
          configRef   = firebase.database().ref('config/liveLeaderboardEnabled'),
          usersRef    = firebase.database().ref('users'),
          badgesRef   = firebase.database().ref('badges');

    // DOM refs for voting form
    const voteContainer = document.getElementById('voteContainer');
    // Normalize helper
    function normalize(name){
      if (!name) return '';
      return name.toLowerCase().replace(/[^a-z0-9]/g,'');
    }

    // Leaderboard DOM references for different views
    const viewModeDisplay = document.getElementById('viewModeDisplay');
    const viewLeftArrow = document.getElementById('viewLeftArrow');
    const viewRightArrow = document.getElementById('viewRightArrow');

    const leaderboardContent = document.getElementById('leaderboardContent');
    const podiumContent = document.getElementById('podiumContent');
    const tilesContent = document.getElementById('tilesContent');

    const viewModes = ['list', 'podium', 'tiles'];
    let currentViewIndex = 0;

    // Function to show the selected leaderboard view
    function showLeaderboardView(view) {
      leaderboardContent.style.display = 'none';
      podiumContent.style.display = 'none';
      tilesContent.style.display = 'none';

      if (view === 'list') {
        leaderboardContent.style.display = 'block';
        viewModeDisplay.textContent = 'List';
      } else if (view === 'podium') {
        podiumContent.style.display = 'flex';
        viewModeDisplay.textContent = 'Podium';
      } else if (view === 'tiles') {
        tilesContent.style.display = 'block';
        viewModeDisplay.textContent = 'Tiles';
      }
      viewModeDisplay.classList.remove('animate');
      void viewModeDisplay.offsetWidth;
      viewModeDisplay.classList.add('animate');

      currentViewIndex = viewModes.indexOf(view);
    }

    // Arrow button functionality
    viewLeftArrow.onclick = () => {
        currentViewIndex = (currentViewIndex - 1 + viewModes.length) % viewModes.length;
        showLeaderboardView(viewModes[currentViewIndex]);
    };

    viewRightArrow.onclick = () => {
        currentViewIndex = (currentViewIndex + 1) % viewModes.length;
        showLeaderboardView(viewModes[currentViewIndex]);
    };


    // Leaderboard update function
    async function updateLeaderboard(){
      const [votesSnap, usersSnap, badgesSnap] = await Promise.all([
        votesRef.once('value'),
        usersRef.once('value'),
        badgesRef.once('value')
      ]);
      const allVotes = votesSnap.val() || {};
      const allUsers = usersSnap.val() || {};
      const allBadges = badgesSnap.val() || {};

      const nameToUidMap = {};
      const normalizedNameToOriginalNameMap = {};
      for (const uid in allUsers) {
        const user = allUsers[uid];
        const originalName = user.displayName || user.email || '';
        const nameKey = normalize(originalName);
        if (nameKey) {
          nameToUidMap[nameKey] = uid;
          normalizedNameToOriginalNameMap[nameKey] = originalName;
        }
      }

      const off = {}, def = {};
      
      for (const voteKey in allVotes) {
        const v = allVotes[voteKey];
        const o = normalize(v.bestOffence || '');
        const d = normalize(v.bestDefence || '');
        
        if (o) {
          if (!off[o]) {
            off[o] = { count: 0, voterUids: new Set() };
          }
          off[o].count++;
          if (v.uid) off[o].voterUids.add(v.uid);
        }
        if (d) {
          if (!def[d]) {
            def[d] = { count: 0, voterUids: new Set() };
          }
          def[d].count++;
          if (v.uid) def[d].voterUids.add(v.uid);
        }
      }

      const processEntries = (entriesMap) => {
        return Object.entries(entriesMap).map(([normalizedName, data]) => {
          const votedForUid = nameToUidMap[normalizedName];
          const representativeUser = votedForUid ? allUsers[votedForUid] : null;
          const originalDisplayName = normalizedNameToOriginalNameMap[normalizedName] || normalizedName;

          return { name: originalDisplayName, count: data.count, user: representativeUser, uid: votedForUid };
        }).sort((a, b) => b.count - a.count);
      };

      const offenseEntries = processEntries(off);
      const defenseEntries = processEntries(def);

      renderList('offenseScores', offenseEntries);
      renderList('defenseScores', defenseEntries);
      renderPodium('offensePodium', offenseEntries);
      renderPodium('defensePodium', defenseEntries);
      renderTiles('offenseTiles', offenseEntries);
      renderTiles('defenseTiles', defenseEntries);

      window.leaderboardData = { allVotes, allUsers, allBadges, normalizedNameToOriginalNameMap };
    }

    const DEFAULT_AVATAR_URL = 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';

    function renderList(id, entries){
      const ul=document.getElementById(id);
      ul.innerHTML='';
      if(!entries.length){ ul.innerHTML='<li>No votes yet.</li>'; return; }
      entries.forEach((data,i)=>{
        const { name, count, user } = data;
        const li=document.createElement('li');
        
        let isDiamond = false;
        let customGradient = null;
        let customBanner = null;
        let customNameColor = null;

        if (user && user.profileCustomizationUnlocked) {
            const codesUnlocked = user.codesUnlocked || {};
            if (codesUnlocked.diamond) {
                isDiamond = true;
                const custom = user.profileCustomization || {};
                customGradient = custom.gradient;
                customBanner = custom.banner;
                customNameColor = custom.nameColor;
            }
        }

        const listItemContent = document.createElement('div');
        listItemContent.className = 'list-item-content';
        // Add glass-active class for top 3 in list view if not diamond
        if (!isDiamond && (i === 0 || i === 1 || i === 2)) {
            listItemContent.classList.add('glass-active');
        }


        const nameAndAvatar = document.createElement('div');
        nameAndAvatar.className = 'name-and-avatar';

        const avatar = document.createElement('img');
        avatar.src = user && user.avatar ? user.avatar : DEFAULT_AVATAR_URL;
        avatar.className = 'avatar-small';
        nameAndAvatar.appendChild(avatar);
        
        const n = document.createElement('span');
        n.className = 'name';
        n.textContent = name;
        nameAndAvatar.appendChild(n);

        listItemContent.appendChild(nameAndAvatar);

        const c = document.createElement('span');
        c.className = 'count';
        c.textContent = count;
        listItemContent.appendChild(c);

        li.appendChild(listItemContent);

        if (isDiamond) {  
            li.classList.add('diamond-member-entry');
            if (customGradient) listItemContent.style.setProperty('--custom-gradient-bg', customGradient);
            if (customBanner) {
                const bannerDiv = document.createElement('div');
                bannerDiv.className = 'background-banner';
                bannerDiv.style.backgroundImage = `url('${customBanner}')`;
                listItemContent.appendChild(bannerDiv);
            }
            if (customNameColor) n.style.color = customNameColor;
        } else {
            if(i===0) n.classList.add('first-place');
            else if(i===1) n.classList.add('second-place');
            else if(i===2) n.classList.add('third-place');
            else {
                n.style.color = '#e8ebfc';
                n.style.fontSize = '1.06rem';
                n.style.background = 'none';
                n.style.fontWeight = '600';
            }
        }
        ul.append(li);
      });
    }

    function renderPodium(id, entries) {
      const podiumDiv = document.getElementById(id);
      podiumDiv.innerHTML = '';
      if (!entries.length) {
        podiumDiv.innerHTML = '<p>No votes yet.</p>';
        return;
      }

      const topEntries = entries.slice(0, 3);

      let orderedPodium = [];
      if (topEntries.length >= 2) {
        orderedPodium[1] = topEntries[0];
        orderedPodium[0] = topEntries[1];
        if (topEntries.length >= 3) {
          orderedPodium[2] = topEntries[2];
        }
      } else if (topEntries.length === 1) {
        orderedPodium[1] = topEntries[0];
      }

      const ranks = ['silver', 'gold', 'bronze'];
      const rankNumbers = ['2', '1', '3'];

      const podiumHTML = orderedPodium.map((data, index) => {
        if (!data) return '';
        const { name, count, user } = data;
        const rankClass = ranks[index];
        const rankNum = rankNumbers[index];
        
        let avatarHtml = '';
        const avatarSrc = user && user.avatar ? user.avatar : DEFAULT_AVATAR_URL;
        avatarHtml = `<img src="${avatarSrc}" class="avatar-small" alt="${name}'s Avatar">`;
        
        let podiumStandStyle = '';
        let podiumStandClass = '';
        let glowColor = '';

        if (user && user.profileCustomizationUnlocked && user.codesUnlocked && user.codesUnlocked.diamond && user.profileCustomization && user.profileCustomization.gradient) {
            podiumStandStyle = `background: ${user.profileCustomization.gradient};`;
            podiumStandClass = 'custom-gradient';
            const gradientMatch = user.profileCustomization.gradient.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (gradientMatch) {
                glowColor = `rgba(${gradientMatch[1]}, ${gradientMatch[2]}, ${gradientMatch[3]}, 0.8)`;
            } else {
                glowColor = '#fff';
            }
        } else {
            if (rankClass === 'gold') podiumStandStyle = 'background: linear-gradient(135deg, #FFD700, #b8860b);';
            else if (rankClass === 'silver') podiumStandStyle = 'background: linear-gradient(135deg, #C0C0C0, #a0a0a0);';
            else if (rankClass === 'bronze') podiumStandStyle = 'background: linear-gradient(135deg, #CD7F32, #8B4513);';
        }


        return `
          <div class="podium-item ${rankClass}">
            ${avatarHtml}
            <span class="name">${name}</span>
            <div class="podium-stand ${rankClass} ${podiumStandClass}" style="${podiumStandStyle}; --custom-podium-gradient: ${podiumStandStyle}; --custom-podium-glow-color: ${glowColor}; --custom-podium-shadow-color: ${glowColor};"><span>${rankNum}</span></div>
            </div>
        `;
      }).join('');
      podiumDiv.innerHTML = podiumHTML;
    }

    function renderTiles(id, entries) {
      const tilesDiv = document.getElementById(id);
      tilesDiv.innerHTML = '';
      if (!entries.length) {
        tilesDiv.innerHTML = '<p>No votes yet.</p>';
        return;
      }
      const tilesHTML = entries.map((data, i) => {
        const { name, count, user } = data;
        let avatarHtml = '';
        const avatarSrc = user && user.avatar ? user.avatar : DEFAULT_AVATAR_URL;
        avatarHtml = `<img src="${avatarSrc}" class="avatar-small" alt="${name}'s Avatar">`;
        

        let isDiamond = false;
        let customGradient = null;
        let customBanner = null;
        let customNameColor = null;

        if (user && user.profileCustomizationUnlocked) {
            const codesUnlocked = user.codesUnlocked || {};
            if (codesUnlocked.diamond) {
                isDiamond = true;
                const custom = user.profileCustomization || {};
                customGradient = custom.gradient;
                customBanner = custom.banner;
                customNameColor = custom.nameColor;
            }
        }

        let backgroundBannerHtml = '';
        let gradientAreaHtml = '';
        let nameStyle = '';

        if (isDiamond) {  
            if (customBanner) {
                backgroundBannerHtml = `<div class="background-banner" style="background-image: url('${customBanner}');"></div>`;
            }
            if (customGradient) {
                gradientAreaHtml = `<div class="gradient-area" style="background: ${customGradient};"></div>`;
            }
            nameStyle = customNameColor ? `color: ${customNameColor};` : '';
            
            return `
              <div class="tile-item diamond-member-entry">
                ${backgroundBannerHtml}
                ${gradientAreaHtml}
                <div class="content-wrapper">
                    ${avatarHtml}
                    <div class="name" style="${nameStyle}">${name}</div>
                    <div class="count">${count}</div>
                </div>
              </div>
            `;

        } else {
            return `
              <div class="tile-item">
                ${avatarHtml}
                <div class="name">${name}</div>
                <div class="count">${count}</div>
              </div>
            `;
        }
      }).join('');
      tilesDiv.innerHTML = tilesHTML;
    }

    async function renderVotedUserProfile(currentUser, allVotes, allUsers, allBadges, normalizedNameToOriginalNameMap) {
        const uid = currentUser.uid;
        const userData = allUsers[uid] || {};
        const userBadges = allBadges[uid] || {};

        const avatarSrc = userData.avatar || DEFAULT_AVATAR_URL;
        const username = userData.username || currentUser.displayName || currentUser.email || 'Guest';
        const profileCustomization = userData.profileCustomization || {};
        const isDiamond = userData.profileCustomizationUnlocked && userData.codesUnlocked && userData.codesUnlocked.diamond;

        let bannerStyle = '';
        if (isDiamond && profileCustomization.banner) {
            bannerStyle = `background-image: url('${profileCustomization.banner}');`;
        }

        let cardBgStyle = `background: rgba(255, 255, 255, 0.18);`; // Default glassmorphism background for the whole card

        let gradientStyle = '';
        if (isDiamond && profileCustomization.gradient) {
            gradientStyle = `background: ${profileCustomization.gradient};`;
        }

        let usernameColor = '#fff';
        if (isDiamond && profileCustomization.nameColor) {
            usernameColor = profileCustomization.nameColor;
        }

        let offenseRank = 'N/A';
        let offenseVotes = 0;
        let defenseRank = 'N/A';
        let defenseVotes = 0;

        const offenseCounts = {};
        const defenseCounts = {};

        for (const voteKey in allVotes) {
            const vote = allVotes[voteKey];
            const offensePlayer = normalize(vote.bestOffence || '');
            const defensePlayer = normalize(vote.bestDefence || '');

            if (offensePlayer) {
                offenseCounts[offensePlayer] = (offenseCounts[offensePlayer] || 0) + 1;
            }
            if (defensePlayer) {
                defenseCounts[defensePlayer] = (defenseCounts[defensePlayer] || 0) + 1;
            }
        }

        const sortedOffense = Object.entries(offenseCounts).sort(([, countA], [, countB]) => countB - countA);
        const sortedDefense = Object.entries(defenseCounts).sort(([, countA], [, countB]) => countB - countA);

        const normalizedCurrentUserDisplayName = normalize(currentUser.displayName || currentUser.email);

        const findStats = (sortedEntries, targetNormalizedName) => {
            let rank = 'N/A';
            let votes = 0;
            for (let i = 0; i < sortedEntries.length; i++) {
                if (sortedEntries[i][0] === targetNormalizedName) {
                    rank = `#${i + 1}`;
                    votes = sortedEntries[i][1];
                    break;
                }
            }
            return { rank, votes };
        };

        const userOffenseStats = findStats(sortedOffense, normalizedCurrentUserDisplayName);
        offenseRank = userOffenseStats.rank;
        offenseVotes = userOffenseStats.votes;

        const userDefenseStats = findStats(sortedDefense, normalizedCurrentUserDisplayName);
        defenseRank = userDefenseStats.rank;
        defenseVotes = userDefenseStats.votes;

        const wins = (userBadges.offence || 0) + (userBadges.defence || 0);

        voteContainer.innerHTML = `
<div class="voted-profile-card">
  <div class="voted-profile-banner" style="${bannerStyle}"></div>
  <div class="voted-profile-gradient-area" style="${gradientStyle}">
    <img src="${avatarSrc}" alt="Your Avatar" class="voted-profile-avatar"/>
    <div class="voted-profile-content-wrapper">
      <div class="voted-profile-username" style="color: ${usernameColor};">${username}</div>
      <div class="voted-profile-stats">
        <div class="glass-stat-block"> <!-- Applied glass-stat-block -->
            <span class="stat-title">Offence Rank</span>
            <span class="stat-value">${offenseRank}</span>
        </div>
        <div class="glass-stat-block"> <!-- Applied glass-stat-block -->
            <span class="stat-title">Offence Votes</span>
            <span class="stat-value">${offenseVotes}</span>
        </div>
        <div class="glass-stat-block"> <!-- Applied glass-stat-block -->
            <span class="stat-title">Defence Rank</span>
            <span class="stat-value">${defenseRank}</span>
        </div>
        <div class="glass-stat-block"> <!-- Applied glass-stat-block -->
            <span class="stat-title">Defence Votes</span>
            <span class="stat-value">${defenseVotes}</span>
        </div>
        <div class="glass-stat-block" style="grid-column: span 2;"> <!-- Applied glass-stat-block -->
            <span class="stat-title">Total Wins</span>
            <span class="stat-value">${wins}</span>
        </div>
      </div>
    </div>
  </div>
</div>
        `;
    }

    function updateAverageRating(){
      votesRef.once('value').then(snap=>{
        let sum=0,n=0;
        snap.forEach(c=>{
          const r=c.val().rating;
          if(typeof r==='number'&&r>0){ sum+=r; n++; }
        });
        document.getElementById('avgRatingNum').textContent = n? (sum/n).toFixed(2): '–';
      });
    }
    function renderForm(user, opts){
      voteContainer.innerHTML=`
        <label>Your Username</label>
        <input readonly id="username" value="${user.displayName||user.email||''}"/>
        <div class="hint">Pick the name you played under.</div>
        <label>Best offence</label>
        <select id="offence">${opts}</select>
        <div class="hint">Choose from registered players.</div>
        <label>Best defence</label>
        <select id="defence">${opts}</select>
        <div class="hint">Choose from registered players.</div>
        <label>Rate today's event</label>
        <div class="stars" id="starContainer">
          <span data-value="1">★</span><span data-value="2">★</span>
          <span data-value="3">★</span><span data-value="4">★</span>
          <span data-value="5">★</span>
        </div>
        <button id="submitBtn" disabled>Submit Vote</button>`;
      const off=document.getElementById('offence'),
            def=document.getElementById('defence'),
            stars=document.getElementById('starContainer').children,
            sub=document.getElementById('submitBtn');
      let rating=0;
      function updateBtn(){ sub.disabled=!(off.value&&def.value&&rating>0); }
      Array.from(stars).forEach(s=>{
        s.onclick=()=>{
          rating=+s.dataset.value;
          Array.from(stars).forEach(x=>x.classList.toggle('filled',+x.dataset.value<=rating));
          updateBtn();
        };
      });
      off.onchange=updateBtn;
      def.onchange=updateBtn;
      votesRef.orderByChild('uid').equalTo(user.uid).once('value').then(async snap=>{
        if(snap.exists()){
          if (window.leaderboardData) {
            renderVotedUserProfile(user, window.leaderboardData.allVotes, window.leaderboardData.allUsers, window.leaderboardData.allBadges, window.leaderboardData.normalizedNameToOriginalNameMap);
          } else {
            const [votesSnap, usersSnap, badgesSnap] = await Promise.all([
                votesRef.once('value'),
                usersRef.once('value'),
                badgesRef.once('value')
            ]);
            const normalizedNameToOriginalNameMap = {};
            const allUsersLocal = usersSnap.val() || {};
            for (const uid in allUsersLocal) {
                const userData = allUsersLocal[uid];
                const originalName = userData.displayName || userData.email || '';
                const nameKey = normalize(originalName);
                if (nameKey) {
                    normalizedNameToOriginalNameMap[nameKey] = originalName;
                }
            }

            window.leaderboardData = {
                allVotes: votesSnap.val() || {},
                allUsers: allUsersLocal,
                allBadges: badgesSnap.val() || {},
                normalizedNameToOriginalNameMap: normalizedNameToOriginalNameMap
            };
            renderVotedUserProfile(user, window.leaderboardData.allVotes, window.leaderboardData.allUsers, window.leaderboardData.allBadges, window.leaderboardData.normalizedNameToOriginalNameMap);
          }
        }
      });
      sub.onclick=()=>{
        sub.disabled=true;
        votesRef.push({
          uid:user.uid,
          username:user.displayName||user.email,
          bestOffence:off.value,
          bestDefence:def.value,
          rating,
          time:firebase.database.ServerValue.TIMESTAMP
        })
        .then(()=> {
            kcAlert('Thanks for voting!');
            updateLeaderboard();
            updateAverageRating();
            if (window.leaderboardData) {
                renderVotedUserProfile(user, window.leaderboardData.allVotes, window.leaderboardData.allUsers, window.leaderboardData.allBadges, window.leaderboardData.normalizedNameToOriginalNameMap);
            } else {
                usersRef.once('value').then(usersSnap => {
                    const allUsersLocal = usersSnap.val() || {};
                    const normalizedNameToOriginalNameMap = {};
                    for (const uid in allUsersLocal) {
                        const userData = allUsersLocal[uid];
                        const originalName = userData.displayName || userData.email || '';
                        const nameKey = normalize(originalName);
                        if (nameKey) {
                            normalizedNameToOriginalNameMap[nameKey] = originalName;
                        }
                    }
                    votesRef.once('value').then(votesSnap => {
                        badgesRef.once('value').then(badgesSnap => {
                            window.leaderboardData = {
                                allVotes: votesSnap.val() || {},
                                allUsers: allUsersLocal,
                                allBadges: badgesSnap.val() || {},
                                normalizedNameToOriginalNameMap: normalizedNameToOriginalNameMap
                            };
                            renderVotedUserProfile(user, window.leaderboardData.allVotes, window.leaderboardData.allUsers, window.leaderboardData.allBadges, window.leaderboardData.normalizedNameToOriginalNameMap);
                        });
                    });
                });
            }
        })
        .catch(e=>kcAlert('Error submitting: '+e.message));
      };
    }
    auth.onAuthStateChanged(u=>{
      if(!u){
        voteContainer.innerHTML =
          `<p>Please <a href="https://kcevents.uk/#loginpage" target="_blank" rel="noopener">log in</a> to vote.</p>`;
        return;
      }
      usersRef.child(u.uid).update({
        displayName: u.displayName||null,
        email:       u.email        ||null,
        joined:      firebase.database.ServerValue.TIMESTAMP,
        emailVerified: u.emailVerified
      });
      if(!u.emailVerified){
        kcAlert('Please verify your email before voting.');
        voteContainer.innerHTML =
          `<p>Verify your email to vote. <a href="https://kcevents.uk/#loginpage" target="_blank" rel="noopener">Resend verification</a></p>`;
        return;
      }
      usersRef.once('value').then(snap=>{
        let opts='<option value="" disabled selected>– Select a player –</option>';
        snap.forEach(c=>{
          const userVal=c.val();
          if(userVal.emailVerified){
            const name=userVal.displayName||userVal.email||'(unknown)',
                  esc=name.replace(/"/g,'&quot;');
            opts+=`<option value="${esc}">${esc}</option>`;
          }
        });
        renderForm(u,opts);
      });
    });
    unlockBtn.onclick = ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      if(!document.getElementById('toggleLeaderboard')){
        const lbl=document.createElement('label');
        lbl.innerHTML=`<input type="checkbox" id="toggleLeaderboard"/> Enable Live Leaderboard`;
        adminControls.appendChild(lbl);
        const chk=document.getElementById('toggleLeaderboard');
        configRef.once('value').then(s=> chk.checked=s.val()!==false);
        const save=document.createElement('button');
        save.textContent='Save Leaderboard Setting';
        save.style.marginTop='.5rem';
        adminControls.appendChild(save);
        save.onclick=()=>{
          configRef.set(chk.checked)
            .then(()=>kcAlert('Live leaderboard setting saved.'))
            .catch(e=>kcAlert('Save failed: '+e.message));
        };
      }
      votesRef.orderByChild('time').once('value').then(snap=>{
        let html=`<tr><th>Date</th><th>User</th><th>Offence</th><th>Defence</th><th>Rating</th><th>Delete</th></tr>`;
        snap.forEach(c=>{
          const v=c.val(), d=new Date(v.time).toLocaleString();
          html+=`<tr data-key="${c.key}"><td>${d}</td><td>${v.username}</td>
                  <td>${v.bestOffence}</td><td>${v.bestDefence}</td>
                  <td>${v.rating}/5</td>
                  <td><button class="delBtn">Delete</button></td></tr>`;
        });
        adminTable.innerHTML=html;
        updateLeaderboard(); updateAverageRating();
      });
    };
    adminTable.addEventListener('click',async e=>{
      if(!e.target.matches('.delBtn')) return;
      const key=e.target.closest('tr').dataset.key;
      if(!await kcConfirm('Delete this vote?')) return;
      votesRef.child(key).remove()
        .then(()=>{ kcAlert('Vote deleted.'); updateLeaderboard(); updateAverageRating(); })
        .catch(err=>kcAlert('Delete failed: '+err.message));
    });
    resetBtn.onclick=async ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      if(!await kcConfirm('Reset all votes? This cannot be undone.')) return;
      const snap=await votesRef.once('value'), tasks=[];
      snap.forEach(c=>tasks.push(votesRef.child(c.key).remove()));
      Promise.all(tasks)
        .then(()=>{ adminTable.innerHTML=''; kcAlert('All votes have been reset.'); updateLeaderboard(); updateAverageRating(); })
        .catch(err=>kcAlert('Reset failed: '+err.message));
    };

    configRef.on('value',snap=>{
      const on=snap.val()!==false;
      if (on) {
        document.getElementById('leaderboardOffMessage').style.display = 'none';
        showLeaderboardView(viewModes[currentViewIndex]);
        document.querySelector('.view-selector-container').style.display = 'flex';
      } else {
        leaderboardContent.style.display = 'none';
        podiumContent.style.display = 'none';
        tilesContent.style.display = 'none';
        document.getElementById('leaderboardOffMessage').style.display = 'block';
        document.querySelector('.view-selector-container').style.display = 'none';
      }
      if(on) updateLeaderboard();
    });

    updateLeaderboard();
    updateAverageRating();
    showLeaderboardView(viewModes[currentViewIndex]);
  </script>
</body>
</html>
