<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Voting</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
    }
    .grid-container {
      display: flex;
      gap: 2.5rem;
      margin-top: 2.5rem;
      margin-bottom: 1.7rem;
      z-index: 1;
    }
    .panel, .leaderboard {
      width: 560px;
      min-width: 480px;
      border-radius: 24px;
      padding: 2rem 1.3rem 1.5rem 1.3rem;
      background: rgba(36,40,48,0.65);
      box-shadow: 0 8px 48px 0 #c0d2e733, 0 2px 8px #8390b51a;
      backdrop-filter: blur(18px) brightness(1.13);
      -webkit-backdrop-filter: blur(18px) brightness(1.13);
      box-sizing: border-box;
      position: relative;
      border: none;
    }
    .panel h2, .leaderboard h3 {
      font-size: 1.45rem;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #fff;
      text-shadow: 0 2px 10px #21325422;
      letter-spacing: 0.02em;
    }
    label {
      display: block;
      margin: 1rem 0 .3rem;
      font-weight: 600;
      color: #fff;
      font-size: 1.02em;
    }
    .hint {
      font-size: .83rem;
      color: #b5bbd7;
      margin-bottom: .7rem;
      margin-left: .05rem;
    }
    input[readonly], input[type=password], select {
      width: 100%;
      padding: .65rem;
      border: none;
      border-radius: 12px;
      margin-top: .2rem;
      box-sizing: border-box;
      background: rgba(252,252,255,0.15);
      color: #fff;
      font-size: 1.01em;
      letter-spacing: 0.01em;
      outline: none;
      transition: background 0.12s;
    }
    input[readonly] { font-weight: 600; letter-spacing: 0.02em; }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='10' height='7' viewBox='0 0 10 7' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23b5bbd7' stroke-width='2'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right .7rem center;
      background-size: .7rem;
    }
    .stars {
      display: flex;
      gap: .3rem;
      margin: .6rem 0 1rem;
    }
    .stars span {
      font-size: 1.55rem;
      cursor: pointer;
      color: #d8dbe7;
      transition: color 0.18s;
    }
    .stars .filled {
      color: #ffd700;
      text-shadow: 0 3px 9px #fdcb0b77;
    }
    button {
      width: 100%;
      padding: .75rem;
      background: linear-gradient(90deg,#7ed2fa 0%,#8be3c2 100%);
      color: #2c3143;
      border: none;
      border-radius: 12px;
      font-size: 1.12rem;
      font-weight: 700;
      margin-top: 1.1rem;
      cursor: pointer;
      transition: background .15s, color .15s, box-shadow .14s, opacity .12s;
      box-shadow: 0 2px 12px #b9e7ff33;
      opacity: 1;
      letter-spacing: .01em;
    }
    button:disabled {
      opacity: .62;
      background: #b7c7d0 !important;
      color: #88949c !important;
      cursor: not-allowed;
    }
    #showAdminBtn {
      background: linear-gradient(90deg,#d3ecfa 0%,#bde3fa 100%);
      color: #3762a7;
      font-weight: 600;
      margin-top: .7rem;
      margin-bottom: 0;
      box-shadow: 0 2px 10px #cbe6ff22;
      border: 1.2px solid #bad2e3;
    }
    #showAdminBtn:hover {
      background: linear-gradient(90deg,#d6e6f8 0%,#d2f3f6 100%);
      color: #21428f;
      box-shadow: 0 8px 18px #b3e8ff44;
    }

    /* Apple glass leaderboard */
    .leaderboard {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(31,33,36,0.46);
      border: none;
      box-shadow: 0 12px 60px #abc9ef25, 0 2px 8px #8390b51a;
      backdrop-filter: blur(24px) brightness(1.10);
      -webkit-backdrop-filter: blur(24px) brightness(1.10);
    }
    .lb-group {
      width: 92%;
      border-radius: 20px;
      padding: 1.05rem 1.25rem .85rem 1.25rem;
      margin-bottom: 1.2rem;
      background: rgba(10,14,23,0.76);
      box-shadow: 0 6px 40px #cfdef755;
      border: 2px solid rgba(140,145,170,0.13);
      transition: box-shadow .19s, transform .16s;
    }
    .offenseBox {
      border: 2px solid #fc718c;
      box-shadow: 0 0 0 transparent;
      margin-bottom: 1.0rem;
    }
    .defenseBox {
      border: 2px solid #53a4ff;
      box-shadow: 0 0 0 transparent;
      margin-bottom: 0;
    }
    .lb-group:hover {
      transform: translateY(-3px) scale(1.017);
      box-shadow: 0 8px 32px #ffe0ec90, 0 1.5px 8px #f48ca888;
      z-index: 2;
    }
    .offenseBox:hover { box-shadow: 0 8px 38px #ff436899, 0 1.5px 8px #f48ca8bb; }
    .defenseBox:hover { box-shadow: 0 8px 38px #32a7ff99, 0 1.5px 8px #86caffbb; }

    .sectionTitle {
      display: flex; align-items: center;
      font-size: 1.13rem; font-weight: 700;
      margin-bottom: .7rem; margin-top: -.1rem;
    }
    .sectionTitle img.icon {
      width: 27px; height: 27px; margin-right: .6rem; filter: drop-shadow(0 2px 6px #181c2c33);
    }
    .offenseBox .sectionTitle {
      color: #fc718c;
      text-shadow: 0 2px 10px #ff7c9951;
    }
    .defenseBox .sectionTitle {
      color: #4ba7ff;
      text-shadow: 0 2px 10px #1a7cda77;
    }
    .leaderboard ul {
      list-style: none; padding: 0; margin: 0;
    }
    .leaderboard li {
      display: flex; justify-content: space-between; align-items: center;
      padding: .44rem 0 .44rem .13rem;
      border-bottom: 1.2px solid rgba(255,255,255,0.10);
      font-size: 1.01rem;
      transition: background .13s, color .14s;
      border-radius: 7px;
    }
    .leaderboard li:last-child { border-bottom: none; }
    .first-place .name {
      background: linear-gradient(45deg,#ffe484,#ffc93a 80%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 2.07rem;
      font-weight: 800;
    }
    .second-place .name {
      background: linear-gradient(45deg,#dbe8fc,#8e9cae 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.37rem;
      font-weight: 700;
    }
    .third-place .name {
      background: linear-gradient(45deg,#fbc28b,#c38348 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.09rem;
      font-weight: 700;
    }
    .name, .count { display: inline-block; }
    .name { transition: font-size 0.3s; }
    .count { font-weight: 600; font-size: 1.09rem; margin-left: .7rem; color: #fff; }
    .leaderboard li:not(.first-place):not(.second-place):not(.third-place) .name {
      color: #e8ebfc;
      font-size: 1.06rem;
      background: none;
      font-weight: 600;
    }
    #leaderboardContainer { width: 100%; }
    #leaderboardContent { display: block; }
    #leaderboardOffMessage { display: none; text-align: center; padding: 2rem 1rem; }
    .offMessage { color: #fff; text-shadow: 0 0 10px #fff8; font-size: 1.28rem; font-weight: 600; }
    .offSubtitle { color: #fff; font-style: italic; margin-top: 0.5rem; font-size: 1rem; }

    #eventRating {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 380px;
      margin: 0 auto 2.3rem auto;
      text-align: center;
      font-size: 1.17rem;
      background: rgba(17,18,25,0.57);
      border-radius: 16px;
      padding: 1.03rem 0 .9rem 0;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #fff;
      box-shadow: 0 4px 20px #c6dbef18;
      position: relative;
      z-index: 10;
    }
    #eventRating span {
      font-size: 1.15em;
      color: #ffe484;
      font-weight: 700;
      margin: 0 .14em 0 .1em;
      letter-spacing: .01em;
    }
    /* Apple modal */
    #adminModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9000;
      background: rgba(24, 27, 38, 0.47);
      align-items: center;
      justify-content: center;
      transition: opacity .18s;
    }
    #adminModal.active { display: flex; }
    #adminModalContent {
      min-width: 360px;
      max-width: 97vw;
      max-height: 80vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.91);
      border-radius: 24px;
      box-shadow: 0 8px 64px #c9e6ff99;
      padding: 2rem 1.4rem 1.5rem 1.4rem;
      position: relative;
      color: #181b29;
      font-family: 'Poppins',sans-serif;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      animation: modalIn .18s cubic-bezier(.62,1.51,.5,1) 1;
    }
    @keyframes modalIn {
      from { transform: translateY(32px) scale(.98); opacity: 0; }
      to   { transform: none; opacity: 1; }
    }
    #adminModalContent h3 {
      margin-top: 0; margin-bottom: 1.1rem;
      font-size: 1.36rem; font-weight: 700; color: #19213b;
    }
    #adminClose {
      position: absolute; top: 18px; right: 18px;
      background: #e5e5f7; border-radius: 100px;
      font-size: 1.13em; border: none; color: #6c718c;
      font-weight: 700; padding: .25em .75em;
      cursor: pointer; box-shadow: 0 2px 8px #cbe6ff44;
      transition: background .14s;
    }
    #adminClose:hover { background: #e4eaff; color: #21314e; }
    #adminTableContainer {
      max-height: 30vh; overflow: auto; border-radius: 14px; width: 100%;
      margin: .7rem 0 .3rem 0; border: 1.2px solid #dde6f3;
      background: #fafcff;
      box-shadow: 0 2px 13px #bed0ec25;
    }
    #adminTableContainer table { width: 100%; border-collapse: collapse; }
    #adminTableContainer th, #adminTableContainer td {
      padding: .62rem .35rem;
      font-size: .97rem;
      text-align: left;
      color: #181b29;
      border-bottom: 1px solid #dde3ef;
    }
    #adminTableContainer th {
      background: #e9f2fe;
      font-weight: 700;
    }
    #adminTableContainer tr:last-child td { border-bottom: none; }
    .delBtn {
      background: #fd5976;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: .37rem .97rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.05em;
      transition: background .12s;
      box-shadow: 0 1px 5px #fd597655;
    }
    .delBtn:hover { background: #c42a49; }
    #adminControls { margin:1.3rem 0 1.4rem 0; }
    #unlockBtn {
      width: auto;
      padding: .54rem 1.3rem;
      border-radius: 8px;
      background: linear-gradient(90deg,#7ed2fa 0%,#8be3c2 100%);
      color: #16343b; font-weight: 700;
      font-size: 1.07em;
      margin-top: .3rem;
    }
    #unlockBtn:hover {
      background: linear-gradient(90deg,#c1f7f8 0%,#c9d2fa 100%);
      color: #181b29;
    }
    #resetBtn {
      background: #e04f69; color: #fff; font-weight: 700;
      border-radius: 10px; font-size: 1.05em;
      margin-top: 1.1rem;
    }
    #resetBtn:hover { background: #a92638; }
    #adminPass {
      background: #f3f8fc; color: #233046;
      border-radius: 9px; font-weight: 600;
      margin-bottom: .7rem;
      margin-top: .3rem;
      width: 100%;
      font-size: 1.1em;
      border: 1.2px solid #d3d8ef;
      letter-spacing: 0.04em;
    }
    /* Modal Overlay Z */
    #alertModal { z-index: 9100; }
    @media (max-width: 950px) {
      .grid-container { flex-direction: column; gap: 1.3rem; }
      .panel, .leaderboard { width: 97vw; min-width: 0; max-width: 99vw; }
      #eventRating { width: 99vw; }
      #adminModalContent { min-width: 92vw; }
    }
    @media (max-width: 670px) {
      .panel, .leaderboard { padding: 1.1rem .4rem; }
      .lb-group { padding: .6rem .45rem; }
      #eventRating { font-size: .98rem; }
    }
#alertModal {
  display: none; /* or flex when active */
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.28);  /* Or .45, whatever you use for frosted glass */
  align-items: center;
  justify-content: center;
  z-index: 9999;  /* ensure it's above everything */
}

#alertContent {
  background: #fff;
  color: #233046;
  border-radius: 18px;
  text-align: center;
  box-shadow: 0 3px 34px #c9defb65;
  max-width: 320px;
  width: 90%;
  font-size: 1.13em;
  padding: 1.5rem 1rem 1.2rem 1rem;
}

select, select option {
  color: #222 !important;
  background: #fff !important;
}
#alertModal {
  display: none; /* or flex when active */
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.28);  /* Or .45, whatever you use for frosted glass */
  align-items: center;
  justify-content: center;
  z-index: 9999;  /* ensure it's above everything */
}

#alertContent {
  background: #fff;
  color: #233046;
  border-radius: 18px;
  text-align: center;
  box-shadow: 0 3px 34px #c9defb65;
  max-width: 320px;
  width: 90%;
  font-size: 1.13em;
  padding: 1.5rem 1rem 1.2rem 1rem;
}

  </style>
</head>
<body>
  <!-- ALERT / CONFIRM OVERLAY -->
  <div id="alertModal">
    <div id="alertContent">
      <strong>KC Event says</strong>
      <p id="alertMsg"></p>
      <div id="confirmBtns" class="confirmButtons" style="display:none;">
        <button class="no">Cancel</button>
        <button class="yes">OK</button>
      </div>
      <button id="alertOK">OK</button>
    </div>
  </div>

  <!-- Apple-style Admin Modal -->
  <div id="adminModal">
    <div id="adminModalContent">
      <button id="adminClose">×</button>
      <h3>KC Admin Panel</h3>
      <label>Enter admin password</label>
      <input type="password" id="adminPass"/>
      <button id="unlockBtn">Unlock Admin</button>
      <div id="adminControls"></div>
      <div id="adminTableContainer">
        <table id="adminTable"></table>
      </div>
      <button id="resetBtn">Reset Votes</button>
    </div>
  </div>

  <!-- Main grid: 2x2 voting + leaderboard -->
  <div class="grid-container">
    <div class="panel">
      <h2>KC Event Voting</h2>
      <div id="voteContainer"><p>Loading…</p></div>
      <button id="showAdminBtn">Admin</button>
    </div>
    <div class="leaderboard">
      <h3>Live Scores:</h3>
      <div id="leaderboardContainer">
        <div id="leaderboardContent">
          <div class="lb-group offenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png" class="icon" alt="Offense Icon"/>
              <strong>Best Offence</strong>
            </div>
            <ul id="offenseScores"><li>Loading…</li></ul>
          </div>
          <div class="lb-group defenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png" class="icon" alt="Defense Icon"/>
              <strong>Best Defence</strong>
            </div>
            <ul id="defenseScores"><li>Loading…</li></ul>
          </div>
        </div>
        <div id="leaderboardOffMessage">
          <div class="offMessage">The Live Leaderboard is currently offline.</div>
          <div class="offSubtitle">You can still vote! The leaderboard will be reactivated when the host decides.</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Centered event rating under grid -->
  <div id="eventRating">
    Overall Event Rating: <span id="avgRatingNum">–</span>/5 ⭐
  </div>
  <script>
    // Modal helpers
    const alertModal = document.getElementById('alertModal'),
          alertMsg   = document.getElementById('alertMsg'),
          alertOK    = document.getElementById('alertOK'),
          confirmBtns= document.getElementById('confirmBtns');
    function kcAlert(msg){
      confirmBtns.style.display   = 'none';
      alertOK.style.display       = 'inline-block';
      alertMsg.textContent        = msg;
      alertModal.style.display    = 'flex';
    }
    function kcConfirm(msg){
      return new Promise(resolve=>{
        alertMsg.textContent        = msg;
        alertOK.style.display       = 'none';
        confirmBtns.style.display   = 'flex';
        alertModal.style.display    = 'flex';
        confirmBtns.querySelector('.no').onclick  = ()=>{ alertModal.style.display='none'; resolve(false); };
        confirmBtns.querySelector('.yes').onclick = ()=>{ alertModal.style.display='none'; resolve(true); };
      });
    }
    alertOK.onclick = ()=> alertModal.style.display='none';

    // Admin Modal
    const showAdminBtn = document.getElementById('showAdminBtn'),
          adminModal   = document.getElementById('adminModal'),
          adminClose   = document.getElementById('adminClose'),
          adminPass    = document.getElementById('adminPass'),
          unlockBtn    = document.getElementById('unlockBtn'),
          adminControls= document.getElementById('adminControls'),
          adminTable   = document.getElementById('adminTable'),
          resetBtn     = document.getElementById('resetBtn'),
          adminTableContainer = document.getElementById('adminTableContainer');
    showAdminBtn.onclick = () => { adminModal.classList.add('active'); };
    adminClose.onclick = () => { adminModal.classList.remove('active'); };

    // Firebase init
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth      = firebase.auth(),
          votesRef  = firebase.database().ref('votes'),
          configRef = firebase.database().ref('config/liveLeaderboardEnabled'),
          usersRef  = firebase.database().ref('users');
    // DOM refs for voting form
    const voteContainer = document.getElementById('voteContainer');
    // Normalize helper
    const canonical = { 'w1de':'wide','wide':'wide','w1deeee':'wide','lbgoo':'goo','lbg00':'goo','goo':'goo' };
    function normalize(name){
      const key = name.toLowerCase().replace(/[^a-z0-9]/g,'');
      return canonical[key] || key;
    }
    // Leaderboard
    function updateLeaderboard(){
      votesRef.once('value').then(snap=>{
        const off={}, def={};
        snap.forEach(c=>{
          const v=c.val(),
                o=normalize(v.bestOffence||''),
                d=normalize(v.bestDefence||'');
          if(o) off[o]=(off[o]||0)+1;
          if(d) def[d]=(def[d]||0)+1;
        });
        renderList('offenseScores', Object.entries(off).sort((a,b)=>b[1]-a[1]));
        renderList('defenseScores',Object.entries(def).sort((a,b)=>b[1]-a[1]));
      });
    }
    function renderList(id, entries){
      const ul=document.getElementById(id);
      ul.innerHTML='';
      if(!entries.length){ ul.innerHTML='<li>No votes yet.</li>'; return; }
      entries.forEach(([name,count],i)=>{
        const li=document.createElement('li'),
              n=document.createElement('span'),
              c=document.createElement('span');
        n.className='name'; c.className='count';
        n.textContent=name; c.textContent=count;
        li.append(n,c);
        if(i===0) li.classList.add('first-place');
        else if(i===1) li.classList.add('second-place');
        else if(i===2) li.classList.add('third-place');
        ul.append(li);
      });
    }
    // Average rating
    function updateAverageRating(){
      votesRef.once('value').then(snap=>{
        let sum=0,n=0;
        snap.forEach(c=>{
          const r=c.val().rating;
          if(typeof r==='number'&&r>0){ sum+=r; n++; }
        });
        document.getElementById('avgRatingNum').textContent = n? (sum/n).toFixed(2): '–';
      });
    }
    // Render voting form
    function renderForm(user, opts){
      voteContainer.innerHTML=`
        <label>Your Username</label>
        <input readonly id="username" value="${user.displayName||user.email||''}"/>
        <div class="hint">Pick the name you played under.</div>
        <label>Best offence</label>
        <select id="offence">${opts}</select>
        <div class="hint">Choose from registered players.</div>
        <label>Best defence</label>
        <select id="defence">${opts}</select>
        <div class="hint">Choose from registered players.</div>
        <label>Rate today's event</label>
        <div class="stars" id="starContainer">
          <span data-value="1">★</span><span data-value="2">★</span>
          <span data-value="3">★</span><span data-value="4">★</span>
          <span data-value="5">★</span>
        </div>
        <button id="submitBtn" disabled>Submit Vote</button>`;
      const off=document.getElementById('offence'),
            def=document.getElementById('defence'),
            stars=document.getElementById('starContainer').children,
            sub=document.getElementById('submitBtn');
      let rating=0;
      function updateBtn(){ sub.disabled=!(off.value&&def.value&&rating>0); }
      Array.from(stars).forEach(s=>{
        s.onclick=()=>{
          rating=+s.dataset.value;
          Array.from(stars).forEach(x=>x.classList.toggle('filled',+x.dataset.value<=rating));
          updateBtn();
        };
      });
      off.onchange=updateBtn;
      def.onchange=updateBtn;
      votesRef.orderByChild('uid').equalTo(user.uid).once('value').then(snap=>{
        if(snap.exists()){
          voteContainer.innerHTML=`<p>You’ve already voted—thank you!</p>`;
        }
      });
      sub.onclick=()=>{
        sub.disabled=true;
        votesRef.push({
          uid:user.uid,
          username:user.displayName||user.email,
          bestOffence:off.value,
          bestDefence:def.value,
          rating,
          time:firebase.database.ServerValue.TIMESTAMP
        })
        .then(()=>{ kcAlert('Thanks for voting!'); updateLeaderboard(); updateAverageRating(); })
        .catch(e=>kcAlert('Error submitting: '+e.message))
        .finally(()=>renderForm(user,opts));
      };
    }
    // Auth listener
    auth.onAuthStateChanged(user=>{
      if(!user){
        voteContainer.innerHTML =
          `<p>Please <a href="https://kcevents.uk/#loginpage" target="_blank" rel="noopener">log in</a> to vote.</p>`;
        return;
      }
      // sync profile + emailVerified
      usersRef.child(user.uid).update({
        displayName: user.displayName||null,
        email:       user.email      ||null,
        joined:      firebase.database.ServerValue.TIMESTAMP,
        emailVerified: user.emailVerified
      });
      // block unverified
      if(!user.emailVerified){
        kcAlert('Please verify your email before voting.');
        voteContainer.innerHTML =
          `<p>Verify your email to vote. <a href="https://kcevents.uk/#loginpage" target="_blank" rel="noopener">Resend verification</a></p>`;
        return;
      }
      // fetch all users, filter client‑side on emailVerified
      usersRef.once('value').then(snap=>{
        let opts='<option value="" disabled selected>– Select a player –</option>';
        snap.forEach(c=>{
          const u=c.val();
          if(u.emailVerified){
            const name=u.displayName||u.email||'(unknown)',
                  esc=name.replace(/"/g,'&quot;');
            opts+=`<option value="${esc}">${esc}</option>`;
          }
        });
        renderForm(user,opts);
      });
    });
    // Admin unlock logic in modal
    unlockBtn.onclick = ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      if(!document.getElementById('toggleLeaderboard')){
        const lbl=document.createElement('label');
        lbl.innerHTML=`<input type="checkbox" id="toggleLeaderboard"/> Enable Live Leaderboard`;
        adminControls.appendChild(lbl);
        const chk=document.getElementById('toggleLeaderboard');
        configRef.once('value').then(s=> chk.checked=s.val()!==false);
        const save=document.createElement('button');
        save.textContent='Save Leaderboard Setting';
        save.style.marginTop='.5rem';
        adminControls.appendChild(save);
        save.onclick=()=>{
          configRef.set(chk.checked)
            .then(()=>kcAlert('Live leaderboard setting saved.'))
            .catch(e=>kcAlert('Save failed: '+e.message));
        };
      }
      // populate table
      votesRef.orderByChild('time').once('value').then(snap=>{
        let html=`<tr><th>Date</th><th>User</th><th>Offence</th><th>Defence</th><th>Rating</th><th>Delete</th></tr>`;
        snap.forEach(c=>{
          const v=c.val(), d=new Date(v.time).toLocaleString();
          html+=`<tr data-key="${c.key}"><td>${d}</td><td>${v.username}</td>
                 <td>${v.bestOffence}</td><td>${v.bestDefence}</td>
                 <td>${v.rating}/5</td>
                 <td><button class="delBtn">Delete</button></td></tr>`;
        });
        adminTable.innerHTML=html;
        updateLeaderboard(); updateAverageRating();
      });
    };
    adminTable.addEventListener('click',async e=>{
      if(!e.target.matches('.delBtn')) return;
      const key=e.target.closest('tr').dataset.key;
      if(!await kcConfirm('Delete this vote?')) return;
      votesRef.child(key).remove()
        .then(()=>{ kcAlert('Vote deleted.'); updateLeaderboard(); updateAverageRating(); })
        .catch(err=>kcAlert('Delete failed: '+err.message));
    });
    resetBtn.onclick=async ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      if(!await kcConfirm('Reset all votes? This cannot be undone.')) return;
      const snap=await votesRef.once('value'), tasks=[];
      snap.forEach(c=>tasks.push(votesRef.child(c.key).remove()));
      Promise.all(tasks)
        .then(()=>{ adminTable.innerHTML=''; kcAlert('All votes have been reset.'); updateLeaderboard(); updateAverageRating(); })
        .catch(err=>kcAlert('Reset failed: '+err.message));
    };
    // Live toggle & init
    configRef.on('value',snap=>{
      const on=snap.val()!==false;
      document.getElementById('leaderboardContent').style.display = on?'block':'none';
      document.getElementById('leaderboardOffMessage').style.display = on?'none':'block';
      if(on) updateLeaderboard();
    });
    updateLeaderboard();
    updateAverageRating();
  </script>
</body>
</html>
