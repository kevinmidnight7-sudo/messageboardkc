<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Voting</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { margin:0; padding:0; font-family:'Poppins',sans-serif; color:#fff; background:transparent; }
    .panel {
      background:rgba(0,0,0,0.6); border-radius:12px;
      padding:1rem; max-width:400px; margin:1rem auto;
    }
    h2 { margin-top:0; }
    label { display:block; margin:1rem 0 .3rem; font-weight:600; }
    .hint { font-size:.75rem; color:#ccc; margin-bottom:.8rem; }
    input[readonly], input[type=text], input[type=password] {
      width:100%; padding:.5rem; border:none; border-radius:6px;
      margin-top:.3rem; box-sizing:border-box;
    }
    input[readonly] { background:#333; color:#fff; }
    .stars { display:flex; gap:.3rem; margin:.5rem 0 1rem; }
    .stars span { font-size:1.5rem; cursor:pointer; color:#555; }
    .stars .filled { color:#facc15; }
    button {
      width:100%; padding:.6rem; background:#22c55e; color:#fff;
      border:none; border-radius:6px; font-size:1rem; font-weight:600;
      cursor:pointer; margin-top:.8rem;
    }
    button:disabled { background:#555; cursor:not-allowed; }
    #showAdminBtn { background:rgba(255,255,255,0.1); }
    #adminSection { display:none; margin-top:1rem; }
    #resetBtn { background:#ef4444; }
    table {
      width:100%; border-collapse:collapse; margin-top:.8rem;
    }
    th, td { padding:.4rem; border:1px solid #444; font-size:.85rem; text-align:left; }
    th { background:rgba(255,255,255,0.1); }
    .delBtn {
      background:#ef4444; color:#fff; padding:.3rem .6rem;
      border:none; border-radius:4px; cursor:pointer;
    }
    /* Overlay alert / confirm */
    #alertModal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.5);
      align-items:center; justify-content:center; z-index:9999;
    }
    #alertContent {
      background:#fff; color:#000; padding:1.5rem; border-radius:8px;
      max-width:300px; width:90%; text-align:center; font-family:'Poppins',sans-serif;
    }
    #alertContent strong { display:block; margin-bottom:.5rem; font-size:1.1rem; }
    #alertContent p { margin:.8rem 0; }
    #alertOK {
      margin-top:1rem; padding:.5rem 1rem; background:#22c55e; color:#fff;
      border:none; border-radius:4px; cursor:pointer; font-weight:600;
    }
    .confirmButtons {
      display:flex; justify-content:center; gap:1rem; margin-top:1rem;
    }
    .confirmButtons button {
      padding:.5rem 1rem; border:none; border-radius:4px;
      font-weight:600; cursor:pointer;
    }
    .confirmButtons .yes { background:#22c55e; color:#fff; }
    .confirmButtons .no  { background:#60a5fa; color:#fff; }
  </style>
</head>
<body>

  <!-- ALERT / CONFIRM OVERLAY -->
  <div id="alertModal">
    <div id="alertContent">
      <strong>KC Event says</strong>
      <p id="alertMsg"></p>
      <div id="confirmBtns" class="confirmButtons" style="display:none;">
        <button class="no">Cancel</button>
        <button class="yes">OK</button>
      </div>
      <button id="alertOK">OK</button>
    </div>
  </div>

  <div class="panel">
    <h2>KC Event Voting</h2>
    <div id="voteContainer"><p>Loading…</p></div>
    <button id="showAdminBtn">Admin</button>
    <div id="adminSection">
      <label>Enter admin password</label>
      <input type="password" id="adminPass"/>
      <button id="unlockBtn">Unlock Admin</button>
      <div id="adminTable"></div>
      <button id="resetBtn">Reset Votes</button>
    </div>
  </div>

  <script>
    // --- Overlay modal logic ---
    const alertModal  = document.getElementById('alertModal'),
          alertMsg    = document.getElementById('alertMsg'),
          alertOK     = document.getElementById('alertOK'),
          confirmBtns = document.getElementById('confirmBtns');

    function kcAlert(msg){
      confirmBtns.style.display = 'none';
      alertOK.style.display     = 'inline-block';
      alertMsg.textContent      = msg;
      alertModal.style.display  = 'flex';
    }
    function kcConfirm(msg){
      return new Promise(res=>{
        alertMsg.textContent      = msg;
        alertOK.style.display     = 'none';
        confirmBtns.style.display = 'flex';
        alertModal.style.display  = 'flex';
        confirmBtns.querySelector('.no').onclick = () => { alertModal.style.display='none'; res(false); };
        confirmBtns.querySelector('.yes').onclick= () => { alertModal.style.display='none'; res(true);  };
      });
    }
    alertOK.onclick = ()=> alertModal.style.display='none';

    // --- Firebase init & refs ---
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth     = firebase.auth(),
          db       = firebase.database(),
          votesRef = db.ref('votes');

    // --- Load all profiles ---
    const userProfiles = {};
    db.ref('users').on('value', snap => {
      snap.forEach(ch => userProfiles[ch.key] = ch.val());
    });

    // --- DOM refs ---
    const voteContainer = document.getElementById('voteContainer'),
          showAdmin      = document.getElementById('showAdminBtn'),
          adminSection   = document.getElementById('adminSection'),
          adminPass      = document.getElementById('adminPass'),
          unlockBtn      = document.getElementById('unlockBtn'),
          adminTable     = document.getElementById('adminTable'),
          resetBtn       = document.getElementById('resetBtn');

    // --- Render voting form ---
    function renderForm(user) {
      // pick the best display name
      const name = (userProfiles[user.uid] && userProfiles[user.uid].displayName)
                 || user.displayName
                 || user.email;
      voteContainer.innerHTML = `
        <label>Your username</label>
        <input readonly id="username" value="${name}"/>
        <div class="hint">needs to match the name you played with</div>

        <label>Best offence</label><input type="text" id="offence"/>
        <div class="hint">needs to match the name they played with</div>

        <label>Best defence</label><input type="text" id="defence"/>
        <div class="hint">needs to match the name they played with</div>

        <label>Rate today's event</label>
        <div class="stars" id="starContainer">
          <span data-value="1">★</span><span data-value="2">★</span>
          <span data-value="3">★</span><span data-value="4">★</span>
          <span data-value="5">★</span>
        </div>

        <button id="submitBtn" disabled>Submit Vote</button>
      `;

      const offence   = document.getElementById('offence'),
            defence   = document.getElementById('defence'),
            stars     = document.getElementById('starContainer').children,
            submitBtn = document.getElementById('submitBtn');
      let rating = 0;

      Array.from(stars).forEach(s => {
        s.onclick = () => {
          rating = +s.dataset.value;
          Array.from(stars).forEach(x =>
            x.classList.toggle('filled', +x.dataset.value <= rating)
          );
          submitBtn.disabled = !(
            offence.value.trim() &&
            defence.value.trim() &&
            rating > 0
          );
        };
      });

      // prevent double‐voting
      votesRef.orderByChild('uid')
              .equalTo(user.uid)
              .once('value', snap => {
        if (snap.exists()) {
          voteContainer.innerHTML = `<p>You’ve already voted—thank you!</p>`;
        }
      });

      // submit
      submitBtn.onclick = () => {
        submitBtn.disabled = true;
        votesRef.push({
          uid: user.uid,
          username: name,
          bestOffence: offence.value.trim(),
          bestDefence: defence.value.trim(),
          rating,
          time: firebase.database.ServerValue.TIMESTAMP
        })
        .then(() => kcAlert('Thanks for voting!'))
        .catch(e  => kcAlert('Error submitting: '+e.message))
        .finally(()=>{
          submitBtn.disabled = false;
          renderForm(user);
        });
      };
    }

    // --- Auth state listener ---
    auth.onAuthStateChanged(user => {
      if (!user) {
        voteContainer.innerHTML = `
          <p>Please
            <a href="https://kcevents.uk/#chatscroll" target="_top" style="color:#4ade80;">
              Log In
            </a>
            to vote.
          </p>`;
      } else {
        renderForm(user);
      }
    });

    // --- Admin toggle & functions ---
    showAdmin.onclick = () => {
      adminSection.style.display =
        adminSection.style.display === 'block'
          ? 'none'
          : 'block';
    };

    unlockBtn.onclick = () => {
      if (adminPass.value !== 'events2025KC') return kcAlert('Incorrect password.');
      votesRef.orderByChild('time').once('value', snap => {
        const data = snap.val() || {};
        let html = `<table>
          <tr><th>Date</th><th>User</th><th>Offence</th>
              <th>Defence</th><th>Rating</th><th>Delete</th></tr>`;
        Object.entries(data).forEach(([key, v]) => {
          const d = new Date(v.time),
                displayName = (userProfiles[v.uid] && userProfiles[v.uid].displayName)
                            || v.username;
          html += `<tr data-key="${key}">
            <td>${d.toLocaleString()}</td>
            <td>${displayName}</td>
            <td>${v.bestOffence}</td>
            <td>${v.bestDefence}</td>
            <td>${v.rating}/5</td>
            <td><button class="delBtn">Delete</button></td>
          </tr>`;
        });
        html += `</table>`;
        adminTable.innerHTML = html;
      });
    };

    // delete a single vote
    adminTable.addEventListener('click', async e => {
      if (!e.target.matches('.delBtn')) return;
      const key = e.target.closest('tr').dataset.key,
            ok  = await kcConfirm('Delete this vote?');
      if (!ok) return;
      votesRef.child(key).remove()
        .then(() => kcAlert('Vote deleted.'))
        .catch(e => kcAlert('Delete failed: '+e.message));
    });

    // reset all votes
    resetBtn.onclick = async () => {
      if (adminPass.value !== 'events2025KC')
        return kcAlert('Incorrect password.');
      const ok = await kcConfirm('Reset all votes? This cannot be undone.');
      if (!ok) return;
      const snap  = await votesRef.once('value'),
            tasks = [];
      snap.forEach(ch => tasks.push(votesRef.child(ch.key).remove()));
      Promise.all(tasks)
        .then(() => {
          adminTable.innerHTML = '';
          kcAlert('All votes have been reset.');
        })
        .catch(e => kcAlert('Reset failed: '+e.message));
    };
  </script>
</body>
</html>
