<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Voting</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin:0; padding:1rem;
      font-family:'Poppins',sans-serif;
      color:#fff;
      background:transparent;
      display:flex;
      flex-wrap:wrap;
      gap:1rem;
      justify-content:center;
    }
    .panel, .leaderboard {
      background:rgba(0,0,0,0.6);
      border-radius:12px;
      padding:1rem;
      width:400px;
      box-sizing:border-box;
    }
    h2, .leaderboard h3 { margin-top:0; }

    label { display:block; margin:1rem 0 .3rem; font-weight:600; }
    .hint { font-size:.75rem; color:#ccc; margin-bottom:.8rem; }
    input[readonly], input[type=text], input[type=password] {
      width:100%; padding:.5rem; border:none; border-radius:6px;
      margin-top:.3rem; box-sizing:border-box;
    }
    input[readonly] { background:#333; color:#fff; }

    .stars { display:flex; gap:.3rem; margin:.5rem 0 1rem; }
    .stars span { font-size:1.5rem; cursor:pointer; color:#555; }
    .stars .filled { color:#facc15; }

    button {
      width:100%; padding:.6rem; background:#22c55e; color:#fff;
      border:none; border-radius:6px; font-size:1rem; font-weight:600;
      cursor:pointer; margin-top:.8rem;
    }
    button:disabled { background:#555; cursor:not-allowed; }
    #showAdminBtn { background:rgba(255,255,255,0.1); }
    #adminSection { display:none; margin-top:1rem; }
    #resetBtn { background:#ef4444; }

    table { width:100%; border-collapse:collapse; margin-top:.8rem; }
    th, td {
      padding:.4rem; border:1px solid #444; font-size:.85rem; text-align:left;
    }
    th { background:rgba(255,255,255,0.1); }
    .delBtn {
      background:#ef4444; color:#fff; padding:.3rem .6rem;
      border:none; border-radius:4px; cursor:pointer;
    }

    #alertModal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.5);
      align-items:center; justify-content:center; z-index:9999;
    }
    #alertContent {
      background:#fff; color:#000; padding:1.5rem;
      border-radius:8px; max-width:300px; width:90%;
      text-align:center; font-family:'Poppins',sans-serif;
    }
    #alertContent strong { display:block; margin-bottom:.5rem; font-size:1.1rem; }
    #alertContent p { margin:.8rem 0; }
    #alertOK {
      margin-top:1rem; padding:.5rem 1rem; background:#22c55e;
      color:#fff; border:none; border-radius:4px;
      cursor:pointer; font-weight:600;
    }
    .confirmButtons {
      display:flex; justify-content:center; gap:1rem; margin-top:1rem;
    }
    .confirmButtons button {
      padding:.5rem 1rem; border:none; border-radius:4px;
      font-weight:600; cursor:pointer;
    }
    .confirmButtons .yes { background:#22c55e; color:#fff; }
    .confirmButtons .no  { background:#60a5fa; color:#fff; }

    .leaderboard h3 {
      text-align:center;
      font-size:1.3rem;
      margin-bottom:.5rem;
    }
    .offenseBox, .defenseBox {
      border:2px solid; border-radius:8px;
      padding:.75rem; margin-bottom:1rem;
    }
    .offenseBox { border-color:#f87171; }
    .defenseBox{ border-color:#3b82f6; }

    .sectionTitle {
      display:flex; align-items:center;
      font-size:1.1rem; margin-bottom:.5rem;
    }
    .sectionTitle img.icon {
      width:24px; height:24px; margin-right:.5rem;
    }
    .offenseBox .sectionTitle {
      color:#f87171;
      text-shadow:0 0 8px rgba(248,113,113,0.7);
    }
    .defenseBox .sectionTitle {
      color:#3b82f6;
      text-shadow:0 0 8px rgba(59,130,246,0.7);
    }

    .leaderboard ul { list-style:none; padding:0; margin:0; }
    .leaderboard li {
      display:flex; justify-content:space-between; align-items: center;
      padding:.4rem 0; border-bottom:1px solid rgba(255,255,255,0.2);
      font-size:.9rem;
    }
    .leaderboard li:last-child { border-bottom:none; }

    .first-place  .name { background:linear-gradient(45deg,#fbbf24,#f59e0b);
                         -webkit-background-clip:text;color:transparent;
                         font-size:2.1rem; font-weight:700; }
    .second-place .name { background:linear-gradient(45deg,#e5e7eb,#9ca3af);
                         -webkit-background-clip:text;color:transparent;
                         font-size:1.45rem; font-weight:700; }
    .third-place  .name { background:linear-gradient(45deg,#cd7f32,#a6520e);
                         -webkit-background-clip:text;color:transparent;
                         font-size:1.13rem; font-weight:700; }
    .name, .count { display:inline-block; }
    .name { transition: font-size 0.3s; }
    .count { font-weight:600; font-size:1.12rem; margin-left:.7rem; color:#fff;}
    /* Regular names (4th and below) */
    .leaderboard li:not(.first-place):not(.second-place):not(.third-place) .name {
      color:#fff;
      font-size:1rem;
      background:none;
      font-weight:600;
    }

    /* Rating box below leaderboard */
    #eventRating {
      width:400px; margin:0 auto; text-align:center; font-size:1.18rem;
      background:rgba(0,0,0,0.55); border-radius:12px; padding:.8rem .2rem .7rem .2rem;
      margin-top:-.3rem;
      font-weight:600;
      letter-spacing: 0.02em;
    }
  </style>
</head>
<body>

  <!-- ALERT / CONFIRM OVERLAY -->
  <div id="alertModal">
    <div id="alertContent">
      <strong>KC Event says</strong>
      <p id="alertMsg"></p>
      <div id="confirmBtns" class="confirmButtons" style="display:none;">
        <button class="no">Cancel</button>
        <button class="yes">OK</button>
      </div>
      <button id="alertOK">OK</button>
    </div>
  </div>

  <!-- Voting panel -->
  <div class="panel">
    <h2>KC Event Voting</h2>
    <div id="voteContainer"><p>Loading…</p></div>
    <button id="showAdminBtn">Admin</button>
    <div id="adminSection">
      <label>Enter admin password</label>
      <input type="password" id="adminPass"/>
      <button id="unlockBtn">Unlock Admin</button>
      <div id="adminTable"></div>
      <button id="resetBtn">Reset Votes</button>
    </div>
  </div>

  <!-- Leaderboard panel -->
  <div class="leaderboard">
    <h3>Live Scores:</h3>
    <div class="offenseBox">
      <div class="sectionTitle">
        <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png"
             class="icon" alt="Offense Icon"/>
        <strong>Best Offence</strong>
      </div>
      <ul id="offenseScores"><li>Loading…</li></ul>
    </div>
    <div class="defenseBox">
      <div class="sectionTitle">
        <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png"
             class="icon" alt="Defense Icon"/>
        <strong>Best Defence</strong>
      </div>
      <ul id="defenseScores"><li>Loading…</li></ul>
    </div>
  </div>

  <!-- Overall Event Rating -->
  <div id="eventRating">
    Overall Event Rating: <span id="avgRatingNum">–</span>/5 ⭐
  </div>

  <script>
    // Overlay modal logic
    const alertModal = document.getElementById('alertModal'),
          alertMsg   = document.getElementById('alertMsg'),
          alertOK    = document.getElementById('alertOK'),
          confirmBtns= document.getElementById('confirmBtns');

    function kcAlert(msg){
      confirmBtns.style.display = 'none';
      alertOK.style.display     = 'inline-block';
      alertMsg.textContent      = msg;
      alertModal.style.display  = 'flex';
    }
    function kcConfirm(msg){
      return new Promise(resolve=>{
        alertMsg.textContent      = msg;
        alertOK.style.display     = 'none';
        confirmBtns.style.display = 'flex';
        alertModal.style.display  = 'flex';
        confirmBtns.querySelector('.no').onclick  = ()=>{ alertModal.style.display='none'; resolve(false); };
        confirmBtns.querySelector('.yes').onclick = ()=>{ alertModal.style.display='none'; resolve(true); };
      });
    }
    alertOK.onclick = ()=> alertModal.style.display='none';

    // Firebase init
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth     = firebase.auth(),
          votesRef = firebase.database().ref('votes');

    // DOM refs
    const voteContainer = document.getElementById('voteContainer'),
          showAdmin      = document.getElementById('showAdminBtn'),
          adminSection   = document.getElementById('adminSection'),
          adminPass      = document.getElementById('adminPass'),
          unlockBtn      = document.getElementById('unlockBtn'),
          adminTable     = document.getElementById('adminTable'),
          resetBtn       = document.getElementById('resetBtn');

    // Canonical mapping for normalization
    const canonical = {
      'w1de': 'wide', 'wide': 'wide', 'w1deeee': 'wide',
      'lbgoo': 'goo','lbg00':'goo','goo':'goo'
    };
    function normalize(name){
      const key = name.toLowerCase().replace(/[^a-z0-9]/g,'');
      return canonical[key] || key;
    }

    // Rebuild both leaderboards
    function updateLeaderboard(){
      votesRef.once('value').then(snap=>{
        const offCounts = {}, defCounts = {};
        snap.forEach(ch=>{
          const v = ch.val();
          const o = normalize(v.bestOffence||''),
                d = normalize(v.bestDefence||'');
          if(o) offCounts[o] = (offCounts[o]||0)+1;
          if(d) defCounts[d] = (defCounts[d]||0)+1;
        });
        const sortEntries = o=> Object.entries(o)
                                    .sort((a,b)=>b[1]-a[1]);
        renderList('offenseScores', sortEntries(offCounts));
        renderList('defenseScores', sortEntries(defCounts));
      });
    }
    function renderList(id, entries){
      const ul = document.getElementById(id);
      ul.innerHTML = '';
      if(!entries.length){
        ul.innerHTML = '<li>No votes yet.</li>';
        return;
      }
      entries.forEach(([name,count],idx)=>{
        const li = document.createElement('li'),
              spanName  = document.createElement('span'),
              spanCount = document.createElement('span');
        spanName.className = 'name';
        spanCount.className= 'count';
        spanName.textContent  = name;
        spanCount.textContent = count;
        li.append(spanName, spanCount);
        if(idx===0) li.classList.add('first-place');
        else if(idx===1) li.classList.add('second-place');
        else if(idx===2) li.classList.add('third-place');
        ul.append(li);
      });
    }

    // Calculate and display overall event rating
    function updateAverageRating() {
      votesRef.once('value').then(snap => {
        let sum = 0, n = 0;
        snap.forEach(ch => {
          const v = ch.val();
          if (typeof v.rating === 'number' && v.rating > 0) {
            sum += v.rating;
            n++;
          }
        });
        const avg = n ? (sum/n) : 0;
        const avgDisplay = avg ? avg.toFixed(2) : '–';
        document.getElementById('avgRatingNum').textContent = avgDisplay;
      });
    }

    // Voting form
    function renderForm(user){
      voteContainer.innerHTML = `
        <label>Your Username</label>
        <input readonly id="username" value="${user.displayName||user.email||''}"/>
        <div class="hint">Needs to match the name you played with.</div>
        <label>Best offence</label><input type="text" id="offence"/>
        <div class="hint">Needs to match the name they played with.</div>
        <label>Best defence</label><input type="text" id="defence"/>
        <div class="hint">Needs to match the name they played with.</div>
        <label>Rate today's event</label>
        <div class="stars" id="starContainer">
          <span data-value="1">★</span>
          <span data-value="2">★</span>
          <span data-value="3">★</span>
          <span data-value="4">★</span>
          <span data-value="5">★</span>
        </div>
        <button id="submitBtn" disabled>Submit Vote</button>`;
      const offence = document.getElementById('offence'),
            defence = document.getElementById('defence'),
            stars   = document.getElementById('starContainer').children,
            submit  = document.getElementById('submitBtn');
      let rating = 0;
      Array.from(stars).forEach(s=>{
        s.onclick = ()=>{
          rating = +s.dataset.value;
          Array.from(stars).forEach(x=>
            x.classList.toggle('filled', +x.dataset.value<=rating)
          );
          submit.disabled = !(offence.value.trim() && defence.value.trim() && rating>0);
        };
      });
      votesRef.orderByChild('uid').equalTo(user.uid)
        .once('value',snap=>{
          if(snap.exists()){
            voteContainer.innerHTML = `<p>You’ve already voted—thank you!</p>`;
            return;
          }
        });
      submit.onclick = ()=>{
        submit.disabled = true;
        votesRef.push({
          uid: user.uid,
          username: user.displayName||user.email,
          bestOffence: offence.value.trim(),
          bestDefence: defence.value.trim(),
          rating,
          time: firebase.database.ServerValue.TIMESTAMP
        })
        .then(()=>{
          kcAlert('Thanks for voting!');
          updateLeaderboard();
          updateAverageRating();
        })
        .catch(e=> kcAlert('Error submitting: '+e.message))
        .finally(()=>{
          submit.disabled=false;
          renderForm(user);
        });
      };
    }

    // Auth listener
    auth.onAuthStateChanged(user=>{
  if(!user){
    voteContainer.innerHTML = `
      <p>Please <a href="https://kcevents.uk/#loginpage" target="_top" style="color:#4ade80;">
        log in
      </a> to vote.</p>`;
  } else {
    renderForm(user);
  }
});
    // Admin
    showAdmin.onclick = ()=>{
      adminSection.style.display =
        adminSection.style.display==='block'?'none':'block';
    };
    unlockBtn.onclick = ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      votesRef.orderByChild('time').once('value',snap=>{
        const data=snap.val()||{};
        let html=`<table>
          <tr><th>Date</th><th>User</th><th>Offence</th><th>Defence</th>
              <th>Rating</th><th>Delete</th></tr>`;
        Object.entries(data).forEach(([k,v])=>{
          const d=new Date(v.time);
          html+=`<tr data-key="${k}">
            <td>${d.toLocaleString()}</td>
            <td>${v.username}</td>
            <td>${v.bestOffence}</td>
            <td>${v.bestDefence}</td>
            <td>${v.rating}/5</td>
            <td><button class="delBtn">Delete</button></td>
          </tr>`;
        });
        html+=`</table>`;
        adminTable.innerHTML=html;
        updateLeaderboard();
        updateAverageRating();
      });
    };
    adminTable.addEventListener('click',async e=>{
      if(!e.target.matches('.delBtn'))return;
      const key=e.target.closest('tr').dataset.key,
            ok=await kcConfirm('Delete this vote?');
      if(!ok)return;
      votesRef.child(key).remove()
        .then(()=>{
          kcAlert('Vote deleted.');
          updateLeaderboard();
          updateAverageRating();
        })
        .catch(err=>kcAlert('Delete failed: '+err.message));
    });
    resetBtn.onclick = async ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      const ok=await kcConfirm('Reset all votes? This cannot be undone.');
      if(!ok)return;
      const snap=await votesRef.once('value'), tasks=[];
      snap.forEach(c=>tasks.push(votesRef.child(c.key).remove()));
      Promise.all(tasks)
        .then(()=>{
          adminTable.innerHTML='';
          kcAlert('All votes have been reset.');
          updateLeaderboard();
          updateAverageRating();
        })
        .catch(err=>kcAlert('Reset failed: '+err.message));
    };

    // Initial render
    updateLeaderboard();
    updateAverageRating();
  </script>
</body>
</html>
