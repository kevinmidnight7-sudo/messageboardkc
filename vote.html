<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Voting</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Poppins', sans-serif;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
    }
    .grid-container {
      display: flex;
      gap: 2.5rem;
      margin-top: 2.5rem;
      margin-bottom: 1.7rem;
      z-index: 1;
    }
    .panel, .leaderboard {
      width: 560px;
      min-width: 480px;
      border-radius: 24px;
      padding: 2rem 1.3rem 1.5rem 1.3rem;
      background: rgba(36,40,48,0.65);
      box-shadow: 0 8px 48px 0 #c0d2e733, 0 2px 8px #8390b51a;
      backdrop-filter: blur(18px) brightness(1.13);
      -webkit-backdrop-filter: blur(18px) brightness(1.13);
      box-sizing: border-box;
      position: relative;
      border: none;
    }
    .panel h2, .leaderboard h3 {
      font-size: 1.45rem;
      font-weight: 700;
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #fff;
      text-shadow: 0 2px 10px #21325422;
      letter-spacing: 0.02em;
    }
    label {
      display: block;
      margin: 1rem 0 .3rem;
      font-weight: 600;
      color: #fff;
      font-size: 1.02em;
    }
    .hint {
      font-size: .83rem;
      color: #b5bbd7;
      margin-bottom: .7rem;
      margin-left: .05rem;
    }
    input[readonly], input[type=password], select {
      width: 100%;
      padding: .65rem;
      border: none;
      border-radius: 12px;
      margin-top: .2rem;
      box-sizing: border-box;
      background: rgba(252,252,255,0.15);
      color: #fff;
      font-size: 1.01em;
      letter-spacing: 0.01em;
      outline: none;
      transition: background 0.12s;
    }
    input[readonly] { font-weight: 600; letter-spacing: 0.02em; }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='10' height='7' viewBox='0 0 10 7' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23b5bbd7' stroke-width='2'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right .7rem center;
      background-size: .7rem;
    }
    .stars {
      display: flex;
      gap: .3rem;
      margin: .6rem 0 1rem;
    }
    .stars span {
      font-size: 1.55rem;
      cursor: pointer;
      color: #d8dbe7;
      transition: color 0.18s;
    }
    .stars .filled {
      color: #ffd700;
      text-shadow: 0 3px 9px #fdcb0b77;
    }
    button {
      width: 100%;
      padding: .75rem;
      background: linear-gradient(90deg,#7ed2fa 0%,#8be3c2 100%);
      color: #2c3143;
      border: none;
      border-radius: 12px;
      font-size: 1.12rem;
      font-weight: 700;
      margin-top: 1.1rem;
      cursor: pointer;
      transition: background .15s, color .15s, box-shadow .14s, opacity .12s;
      box-shadow: 0 2px 12px #b9e7ff33;
      opacity: 1;
      letter-spacing: .01em;
    }
    button:disabled {
      opacity: .62;
      background: #b7c7d0 !important;
      color: #88949c !important;
      cursor: not-allowed;
    }

    /* Admin button as a circular icon */
    #adminIconBtn {
      position: absolute;
      top: 18px;
      right: 18px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.15); /* Slightly transparent white */
      border: 1.5px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      z-index: 10; /* Ensure it's above other elements */
      padding: 0; /* Remove default button padding */
    }
    #adminIconBtn:hover {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.25);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    #adminIconBtn img {
      width: 100%; /* Make the image fill the button */
      height: 100%;
      object-fit: cover; /* Ensure the image covers the area without distortion */
      pointer-events: none; /* Prevent image from interfering with click */
      border-radius: 50%; /* Keep it circular */
    }

    /* Apple glass leaderboard */
    .leaderboard {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(31,33,36,0.46);
      border: none;
      box-shadow: 0 12px 60px #abc9ef25, 0 2px 8px #8390b51a;
      backdrop-filter: blur(24px) brightness(1.10);
      -webkit-backdrop-filter: blur(24px) brightness(1.10);
    }
    .lb-group {
      width: 92%;
      border-radius: 20px;
      padding: 1.05rem 1.25rem .85rem 1.25rem;
      margin-bottom: 1.2rem;
      background: rgba(10,14,23,0.76);
      box-shadow: 0 6px 40px #cfdef755;
      border: 2px solid rgba(140,145,170,0.13);
      transition: box-shadow .19s, transform .16s;
    }
    .offenseBox {
      border: 2px solid #fc718c;
      box-shadow: 0 0 0 transparent;
      margin-bottom: 1.0rem;
    }
    .defenseBox {
      border: 2px solid #53a4ff;
      box-shadow: 0 0 0 transparent;
      margin-bottom: 0;
    }
    .lb-group:hover {
      transform: translateY(-3px) scale(1.017);
      box-shadow: 0 8px 32px #ffe0ec90, 0 1.5px 8px #f48ca888;
      z-index: 2;
    }
    .offenseBox:hover { box-shadow: 0 8px 38px #ff436899, 0 1.5px 8px #f48ca8bb; }
    .defenseBox:hover { box-shadow: 0 8px 38px #32a7ff99, 0 1.5px 8px #86caffbb; }

    .sectionTitle {
      display: flex; align-items: center;
      font-size: 1.13rem; font-weight: 700;
      margin-bottom: .7rem; margin-top: -.1rem;
    }
    .sectionTitle img.icon {
      width: 27px; height: 27px; margin-right: .6rem; filter: drop-shadow(0 2px 6px #181c2c33);
    }
    .offenseBox .sectionTitle {
      color: #fc718c;
      text-shadow: 0 2px 10px #ff7c9951;
    }
    .defenseBox .sectionTitle {
      color: #4ba7ff;
      text-shadow: 0 2px 10px #1a7cda77;
    }
    .leaderboard ul {
      list-style: none; padding: 0; margin: 0;
    }
    .leaderboard li {
      display: flex; /* Ensure li is a flex container */
      align-items: center; /* Vertically center items */
      /* Removed padding and border-bottom from li */
      margin-bottom: 8px; /* Consistent spacing between list items */
      font-size: 1.01rem;
      transition: background .13s, color .14s;
      border-radius: 7px;
    }
    .leaderboard li:last-child { margin-bottom: 0; } /* No margin after the last item */
    .first-place .name {
      background: linear-gradient(45deg,#ffe484,#ffc93a 80%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 2.07rem;
      font-weight: 800;
    }
    .second-place .name {
      background: linear-gradient(45deg,#dbe8fc,#8e9cae 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.37rem;
      font-weight: 700;
    }
    .third-place .name {
      background: linear-gradient(45deg,#fbc28b,#c38348 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.09rem;
      font-weight: 700;
    }
    .name, .count { display: inline-block; }
    .name { transition: font-size 0.3s; }
    .count { font-weight: 600; font-size: 1.09rem; margin-left: auto; /* Push count to the right */ color: #fff; padding-right: 5px; /* Add some padding to prevent falling out */ }
    .leaderboard li:not(.first-place):not(.second-place):not(.third-place) .name {
      color: #e8ebfc;
      font-size: 1.06rem;
      background: none;
      font-weight: 600;
    }
    /* Ensure all list view avatars are the same size */
    .leaderboard li .avatar-small {
      width: 28px; /* Consistent size */
      height: 28px; /* Consistent size */
      border-radius: 50%;
      object-fit: cover;
      /* margin-right: 8px; */ /* Removed this as gap on parent handles spacing */
      border: 1.5px solid rgba(255,255,255,0.7);
    }
    /* Base styling for all list items to act as consistent containers */
    .leaderboard li .list-item-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.6rem 1.25rem; /* Consistent padding */
      border-radius: 12px; /* Rounded corners */
      background: rgba(255,255,255,0.05); /* Subtle background for all */
      box-shadow: 0 1px 4px rgba(0,0,0,0.1); /* Subtle shadow */
      transition: all 0.2s ease;
      box-sizing: border-box; /* Include padding in width/height calculation */
    }
    .leaderboard li:hover .list-item-content {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    /* Top 3 styling for list items - applies only if not diamond */
    .leaderboard li.first-place:not(.diamond-member-entry) .list-item-content,
    .leaderboard li.second-place:not(.diamond-member-entry) .list-item-content,
    .leaderboard li.third-place:not(.diamond-member-entry) .list-item-content {
        background: rgba(255,255,255,0.08); /* Slightly more prominent background for top 3 */
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* Specific styling for diamond-member-entry in list view */
    .leaderboard li.diamond-member-entry .list-item-content {
        background: var(--custom-gradient-bg); /* Apply custom gradient */
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        border: none; /* Remove default border */
    }
    .leaderboard li.diamond-member-entry .background-banner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        background-position: center;
        opacity: 0.15;
        z-index: 0;
        border-radius: 12px; /* Match container border-radius */
    }
    /* Ensure name and avatar are always aligned and spaced */
    .name-and-avatar {
        display: flex;
        align-items: center;
        gap: 8px; /* Provides consistent spacing between avatar and name */
    }
    .leaderboard li.diamond-member-entry .avatar-small {
        width: 32px; /* Slightly larger for diamond list entries */
        height: 32px;
        border: 2px solid rgba(255,255,255,0.8);
    }
    .leaderboard li.diamond-member-entry .name {
        font-weight: 700;
        font-size: 1.1em;
    }
    .leaderboard li.diamond-member-entry .count {
        font-weight: 600;
        font-size: 1.1em;
        margin-left: auto; /* Ensure it stays right */
        padding-right: 0; /* Remove extra padding */
        position: relative; /* For z-index */
        z-index: 1;
    }


    #leaderboardContainer { width: 100%; }
    #leaderboardContent { display: block; } /* Default view */
    #podiumContent, #tilesContent { display: none; } /* Hidden by default */
    #leaderboardOffMessage { display: none; text-align: center; padding: 2rem 1rem; }
    .offMessage { color: #fff; text-shadow: 0 0 10px #fff8; font-size: 1.28rem; font-weight: 600; }
    .offSubtitle { color: #fff; font-style: italic; margin-top: 0.5rem; font-size: 1rem; }

    #eventRating {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 380px;
      margin: 0 auto 2.3rem auto;
      text-align: center;
      font-size: 1.17rem;
      background: rgba(17,18,25,0.57);
      border-radius: 16px;
      padding: 1.03rem 0 .9rem 0;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #fff;
      box-shadow: 0 4px 20px #c6dbef18;
      position: relative;
      z-index: 10;
    }
    #eventRating span {
      font-size: 1.15em;
      color: #ffe484;
      font-weight: 700;
      margin: 0 .14em 0 .1em;
      letter-spacing: .01em;
    }
    /* Apple modal */
    #adminModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 9000;
      background: rgba(24, 27, 38, 0.47);
      align-items: center;
      justify-content: center;
      transition: opacity .18s;
    }
    #adminModal.active { display: flex; }
    #adminModalContent {
      min-width: 360px;
      max-width: 97vw;
      max-height: 80vh;
      overflow-y: auto;
      background: rgba(255,255,255,0.91);
      border-radius: 24px;
      box-shadow: 0 8px 64px #c9e6ff99;
      padding: 2rem 1.4rem 1.5rem 1.4rem;
      position: relative;
      color: #181b29;
      font-family: 'Poppins',sans-serif;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      animation: modalIn .18s cubic-bezier(.62,1.51,.5,1) 1;
    }
    @keyframes modalIn {
      from { transform: translateY(32px) scale(.98); opacity: 0; }
      to  { transform: none; opacity: 1; }
    }
    #adminModalContent h3 {
      margin-top: 0; margin-bottom: 1.1rem;
      font-size: 1.36rem; font-weight: 700; color: #19213b;
    }
    #adminClose {
      position: absolute; top: 18px; right: 18px;
      background: #e5e5f7; border-radius: 100px;
      font-size: 1.13em; border: none; color: #6c718c;
      font-weight: 700; padding: .25em .75em;
      cursor: pointer; box-shadow: 0 2px 8px #cbe6ff44;
      transition: background .14s;
    }
    #adminClose:hover { background: #e4eaff; color: #21314e; }
    #adminTableContainer {
      max-height: 30vh; overflow: auto; border-radius: 14px; width: 100%;
      margin: .7rem 0 .3rem 0; border: 1.2px solid #dde6f3;
      background: #fafcff;
      box-shadow: 0 2px 13px #bed0ec25;
    }
    #adminTableContainer table { width: 100%; border-collapse: collapse; }
    #adminTableContainer th, #adminTableContainer td {
      padding: .62rem .35rem;
      font-size: .97rem;
      text-align: left;
      color: #181b29;
      border-bottom: 1px solid #dde3ef;
    }
    #adminTableContainer th {
      background: #e9f2fe;
      font-weight: 700;
    }
    #adminTableContainer tr:last-child td { border-bottom: none; }
    .delBtn {
      background: #fd5976;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: .37rem .97rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.05em;
      transition: background .12s;
      box-shadow: 0 1px 5px #fd597655;
    }
    .delBtn:hover { background: #c42a49; }
    #adminControls { margin:1.3rem 0 1.4rem 0; }
    #unlockBtn {
      width: auto;
      padding: .54rem 1.3rem;
      border-radius: 8px;
      background: linear-gradient(90deg,#7ed2fa 0%,#8be3c2 100%);
      color: #16343b; font-weight: 700;
      font-size: 1.07em;
      margin-top: .3rem;
    }
    #unlockBtn:hover {
      background: linear-gradient(90deg,#c1f7f8 0%,#c9d2fa 100%);
      color: #181b29;
    }
    #resetBtn {
      background: #e04f69; color: #fff; font-weight: 700;
      border-radius: 10px; font-size: 1.05em;
      margin-top: 1.1rem;
    }
    #resetBtn:hover { background: #a92638; }
    #adminPass {
      background: #f3f8fc; color: #233046;
      border-radius: 9px; font-weight: 600;
      margin-bottom: .7rem;
      margin-top: .3rem;
      width: 100%;
      font-size: 1.1em;
      border: 1.2px solid #d3d8ef;
      letter-spacing: 0.04em;
    }
    /* Modal Overlay Z */
    #alertModal { z-index: 9100; }
    @media (max-width: 950px) {
      .grid-container { flex-direction: column; gap: 1.3rem; }
      .panel, .leaderboard { width: 97vw; min-width: 0; max-width: 99vw; }
      #eventRating { width: 99vw; }
      #adminModalContent { min-width: 92vw; }
    }
    @media (max-width: 670px) {
      .panel, .leaderboard { padding: 1.1rem .4rem; }
      .lb-group { padding: .6rem .45rem; }
      #eventRating { font-size: .98rem; }
    }
    #alertModal {
      display: none; /* or flex when active */
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.28);  /* Or .45, whatever you use for frosted glass */
      align-items: center;
      justify-content: center;
      z-index: 9999;  /* ensure it's above everything */
    }

    #alertContent {
      background: #fff;
      color: #233046;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 3px 34px #c9defb65;
      max-width: 320px;
      width: 90%;
      font-size: 1.13em;
      padding: 1.5rem 1rem 1.2rem 1rem;
    }

    select, select option {
      color: #222 !important;
      background: #fff !important;
    }
    #alertModal {
      display: none; /* or flex when active */
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.28);  /* Or .45, whatever you use for frosted glass */
      align-items: center;
      justify-content: center;
      z-index: 9999;  /* ensure it's above everything */
    }

    #alertContent {
      background: #fff;
      color: #233046;
      border-radius: 18px;
      text-align: center;
      box-shadow: 0 3px 34px #c9defb65;
      max-width: 320px;
      width: 90%;
      font-size: 1.13em;
      padding: 1.5rem 1rem 1.2rem 1rem;
    }

    /* Styles for the new dropdown view selector */
    .view-selector-container {
      display: flex;
      align-items: center;
      justify-content: center; /* Center the view selector */
      gap: 10px;
      margin-bottom: 1rem;
      width: 92%; /* Match lb-group width */
    }
    .view-mode-display {
        background: rgba(252,252,255,0.15);
        border-radius: 12px;
        padding: 0.5rem 1rem;
        color: #fff;
        font-size: 1.1em;
        font-weight: 600;
        min-width: 100px; /* Ensure consistent width */
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: background 0.3s ease, transform 0.3s ease;
        position: relative;
        overflow: hidden; /* For animation */
    }
    .view-mode-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    .view-mode-display.animate::before {
        left: 100%;
    }
    .view-selector-arrow {
        background: rgba(252,252,255,0.1);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        color: #fff;
        font-size: 1.5em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease, transform 0.2s ease;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .view-selector-arrow:hover {
        background: rgba(252,252,255,0.2);
        transform: scale(1.1);
    }
    .view-selector-arrow:active {
        transform: scale(0.9);
    }


    /* Styles for the new podium view */
    #podiumContent {
      width: 100%;
      display: flex; /* Ensure it's a flex container */
      flex-direction: column; /* Stack offense and defense vertically */
      gap: 1.2rem; /* Space between the two podium sections */
    }
    .offensePodium, .defensePodium {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      padding: 1.5rem 0;
    }
    .podium-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative; /* For avatar positioning */
    }
    .podium-item .avatar-small {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 5px;
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .podium-item .name {
      font-size: 1.2rem;
      font-weight: 700;
      margin-top: 5px;
    }
    /* Hide count in podium view */
    .podium-item .count {
      display: none;  
    }
    .podium-item .name, .podium-item .count {
      text-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }
    .podium-item.gold .name {
      background: linear-gradient(45deg,#ffe484,#ffc93a 80%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 2.2rem;
    }
    .podium-item.silver .name {
      background: linear-gradient(45deg,#dbe8fc,#8e9cae 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.6rem;
    }
    .podium-item.bronze .name {
      background: linear-gradient(45deg,#fbc28b,#c38348 85%);
      -webkit-background-clip: text;
      color: transparent;
      font-size: 1.3rem;
    }

    .podium-stand {
      background: linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.2));
      border-radius: 10px;
      width: 80px;
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      position: relative;
      top: 10px;
      transition: all 0.3s ease, box-shadow 0.3s ease; /* Add box-shadow to transition */
    }

    .podium-stand.gold {
      height: 140px;
      width: 100px;
      background: linear-gradient(135deg, #FFD700, #b8860b);
      box-shadow: 0 6px 16px rgba(255,215,0,0.5);
    }
    .podium-stand.silver {
      height: 110px;
      width: 90px;
      background: linear-gradient(135deg, #C0C0C0, #a0a0a0);
      box-shadow: 0 4px 12px rgba(192,192,192,0.5);
    }
    .podium-stand.bronze {
      height: 80px;
      width: 80px;
      background: linear-gradient(135deg, #CD7F32, #8B4513);
      box-shadow: 0 4px 12px rgba(205,127,50,0.5);
    }
    /* Custom gradient for podium stand if user has diamond customization */
    .podium-stand.custom-gradient {
        background-image: var(--custom-podium-gradient, linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.2)));
        box-shadow: 0 4px 12px var(--custom-podium-shadow-color, rgba(0,0,0,0.2));
    }

    .podium-stand span {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .podium-stand.gold span { font-size: 2rem; }
    .podium-stand.silver span { font-size: 1.7rem; }
    .podium-stand.bronze span { font-size: 1.5rem; }

    /* Podium hover glow */
    .podium-stand.gold:hover { box-shadow: 0 0 25px #ffd700, 0 0 40px #ffd700; }
    .podium-stand.silver:hover { box-shadow: 0 0 25px #C0C0C0, 0 0 40px #C0C0C0; }
    .podium-stand.bronze:hover { box-shadow: 0 0 25px #CD7F32, 0 0 40px #CD7F32; }
    .podium-stand.custom-gradient:hover {
        box-shadow: 0 0 25px var(--custom-podium-glow-color, #fff), 0 0 40px var(--custom-podium-glow-color, #fff);
    }


    /* Styles for the new tiles view */
    .tiles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      padding: 1rem 0;
      justify-content: center;
    }
    .tile-item {
      background: rgba(255,255,255,0.08);
      border-radius: 15px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative; /* For avatar positioning */
      display: flex; /* Use flex for internal alignment */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      /* Ensure consistent sizing for all tiles */
      min-height: 120px;  
      box-sizing: border-box; /* Include padding in height calculation */
    }
    .tile-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .tile-item .avatar-small {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 8px auto;
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .tile-item .name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 5px;
      text-align: center; /* Center name */
    }
    .tile-item .count {
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff; /* White for better contrast on pill */
      background: rgba(0,0,0,0.3); /* Pill background */
      border-radius: 15px; /* Pill shape */
      padding: 4px 10px;
      margin-top: 5px;
      display: inline-block; /* To apply padding/border-radius */
    }
    /* Diamond member custom styling for tiles and list */
    .diamond-member-entry {
        /* This class is now applied directly to the .tile-item or <li> */
        /* Removed padding and margin-bottom from here for list view, now handled by li */
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        position: relative;
        overflow: hidden; /* For banner */
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        /* Ensure it matches the overall tile/list item sizing */
        box-sizing: border-box;
        min-height: 120px; /* For tiles */
        /* IMPORTANT: No direct background or background-image here for tiles */
        background: none; /* Ensure no default background interferes */
    }
    .diamond-member-entry .background-banner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 25%; /* Top 1/4th of the tile */
        background-size: cover;
        background-position: center;
        opacity: 0.15; /* Subtle overlay */
        z-index: 0;
        border-radius: 15px 15px 0 0; /* Match tile top corners */
    }
    /* NEW: Gradient area for tiles */
    .tile-item.diamond-member-entry .gradient-area {
        position: absolute;
        top: 25%; /* Starts below the banner */
        left: 0;
        width: 100%;
        height: 75%; /* Fills the rest of the tile */
        z-index: 0; /* Same z-index as banner, but below content */
        border-radius: 0 0 15px 15px; /* Match tile bottom corners */
    }

    .diamond-member-entry .content-wrapper {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column; /* Stack avatar/name and count vertically for tiles */
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%; /* Ensure it fills the tile */
    }
    /* Specific adjustments for diamond-member-entry in list view */
    .leaderboard li.diamond-member-entry {
        flex-direction: row; /* Keep row for list view */
        justify-content: flex-start;
        align-items: center;
        min-height: auto; /* Allow height to adjust */
        /* No padding or margin-bottom here, handled by .list-item-content and .leaderboard li */
    }
    .leaderboard li.diamond-member-entry .content-wrapper {
        flex-direction: row; /* Keep row for list view content */
        justify-content: space-between; /* Space out name/avatar and count */
        align-items: center;
        width: 100%;
        height: auto;
    }

    .diamond-member-entry .name-and-avatar {
        display: flex;
        flex-direction: row; /* Keep row for list view */
        align-items: center;
        gap: 8px;
    }
    .diamond-member-entry .avatar-small {
        width: 50px; /* Consistent with other tiles */
        height: 50px; /* Consistent with other tiles */
        border-radius: 50%;
        object-fit: cover;
        border: 1.5px solid rgba(255,255,255,0.7);
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        margin: 0; /* Remove margin auto for list view */
    }
    .diamond-member-entry .name {
        font-weight: 700;
        font-size: 1.1em;
    }
    .diamond-member-entry .count {
        font-weight: 600;
        font-size: 1.1em;
        margin-top: 0; /* Remove margin for list view */
    }


    /* Responsive styles for podium */
    @media (max-width: 670px) {
      .leaderboard .offensePodium, .leaderboard .defensePodium {
        flex-direction: column; /* Stack vertically on small screens */
        align-items: center;
      }
      .podium-item { margin-bottom: 15px; } /* Add space between stacked items */
      .podium-stand.gold { width: 80px; height: 110px; }
      .podium-stand.silver { width: 70px; height: 90px; }
      .podium-stand.bronze { width: 60px; height: 70px; }
    }

    /* New styles for the voted user profile card */
    .voted-profile-card {
        width: 100%;
        min-height: 200px;
        border-radius: 20px;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.1); /* Default transparent background */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        overflow: hidden;
        color: #fff;
        text-align: center;
        box-sizing: border-box;
    }

    .voted-profile-banner {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 80px; /* Adjust height as needed */
        background-size: cover;
        background-position: center;
        border-radius: 20px 20px 0 0;
        opacity: 0.2;
        z-index: 0;
    }

    .voted-profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        margin-top: 20px; /* Push down from banner */
        position: relative;
        z-index: 1;
    }

    .voted-profile-username {
        font-size: 1.6rem;
        font-weight: 700;
        margin-top: 10px;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        /* Default color, overridden by customization */
        color: #fff;
    }

    .voted-profile-stats {
        display: flex;
        justify-content: space-around;
        width: 100%;
        margin-top: 10px;
        position: relative;
        z-index: 1;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #e0e0e0;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 800;
        color: #ffd700; /* Gold color for values */
        margin-top: 5px;
        text-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    }
  </style>
</head>
<body>
  <!-- ALERT / CONFIRM OVERLAY -->
  <div id="alertModal">
    <div id="alertContent">
      <strong>KC Event says</strong>
      <p id="alertMsg"></p>
      <div id="confirmBtns" class="confirmButtons" style="display:none;">
        <button class="no">Cancel</button>
        <button class="yes">OK</button>
      </div>
      <button id="alertOK">OK</button>
    </div>
  </div>

  <!-- Apple-style Admin Modal -->
  <div id="adminModal">
    <div id="adminModalContent">
      <button id="adminClose">×</button>
      <h3>KC Admin Panel</h3>
      <label>Enter admin password</label>
      <input type="password" id="adminPass"/>
      <button id="unlockBtn">Unlock Admin</button>
      <div id="adminControls"></div>
      <div id="adminTableContainer">
        <table id="adminTable"></table>
      </div>
      <button id="resetBtn">Reset Votes</button>
    </div>
  </div>

  <!-- Main grid: 2x2 voting + leaderboard -->
  <div class="grid-container">
    <div class="panel">
      <h2>KC Event Voting</h2>
      <div id="voteContainer"><p>Loading…</p></div>
      <!-- Admin button as a circular icon -->
      <button id="adminIconBtn">
        <img src="https://github.com/kevinmidnight7-sudo/messageboardkc/blob/main/Admin.png?raw=true" alt="Admin Icon"/>
      </button>
    </div>
    <div class="leaderboard">
      <h3>Live Scores:</h3>
      <div class="view-selector-container">
        <button id="viewLeftArrow" class="view-selector-arrow">&lt;</button>
        <div id="viewModeDisplay" class="view-mode-display">List</div>
        <button id="viewRightArrow" class="view-selector-arrow">&gt;</button>
      </div>
      <div id="leaderboardContainer">
        <!-- Podium View -->
        <div id="podiumContent">
          <div class="lb-group offenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png" class="icon" alt="Offense Icon"/>
              <strong>Best Offence Podium</strong>
            </div>
            <div id="offensePodium" class="offensePodium"></div>
          </div>
          <div class="lb-group defenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png" class="icon" alt="Defense Icon"/>
              <strong>Best Defence Podium</strong>
            </div>
            <div id="defensePodium" class="defensePodium"></div>
          </div>
        </div>

        <!-- Tiles View -->
        <div id="tilesContent">
          <div class="lb-group offenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png" class="icon" alt="Offense Icon"/>
              <strong>Best Offence Tiles</strong>
            </div>
            <div id="offenseTiles" class="tiles-grid"></div>
          </div>
          <div class="lb-group defenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png" class="icon" alt="Defense Icon"/>
              <strong>Best Defence Tiles</strong>
            </div>
            <div id="defenseTiles" class="tiles-grid"></div>
          </div>
        </div>

        <!-- List View (Default) -->
        <div id="leaderboardContent">
          <div class="lb-group offenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/red.png" class="icon" alt="Offense Icon"/>
              <strong>Best Offence</strong>
            </div>
            <ul id="offenseScores"><li>Loading…</li></ul>
          </div>
          <div class="lb-group defenseBox">
            <div class="sectionTitle">
              <img src="https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png" class="icon" alt="Defense Icon"/>
              <strong>Best Defence</strong>
            </div>
            <ul id="defenseScores"><li>Loading…</li></ul>
          </div>
        </div>

        <div id="leaderboardOffMessage">
          <div class="offMessage">The Live Leaderboard is currently offline.</div>
          <div class="offSubtitle">You can still vote! The leaderboard will be reactivated when the host decides.</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Centered event rating under grid -->
  <div id="eventRating">
    Overall Event Rating: <span id="avgRatingNum">–</span>/5 ⭐
  </div>
  <script>
    // Modal helpers
    const alertModal = document.getElementById('alertModal'),
          alertMsg   = document.getElementById('alertMsg'),
          alertOK    = document.getElementById('alertOK'),
          confirmBtns= document.getElementById('confirmBtns');
    function kcAlert(msg){
      confirmBtns.style.display  = 'none';
      alertOK.style.display      = 'inline-block';
      alertMsg.textContent       = msg;
      alertModal.style.display   = 'flex';
    }
    function kcConfirm(msg){
      return new Promise(resolve=>{
        alertMsg.textContent       = msg;
        alertOK.style.display      = 'none';
        confirmBtns.style.display  = 'flex';
        alertModal.style.display   = 'flex';
        confirmBtns.querySelector('.no').onclick  = ()=>{ alertModal.style.display='none'; resolve(false); };
        confirmBtns.querySelector('.yes').onclick = ()=>{ alertModal.style.display='none'; resolve(true); };
      });
    }
    alertOK.onclick = ()=> alertModal.style.display='none';

    // Admin Modal
    const adminIconBtn = document.getElementById('adminIconBtn'), // Changed from showAdminBtn
          adminModal   = document.getElementById('adminModal'),
          adminClose   = document.getElementById('adminClose'),
          adminPass    = document.getElementById('adminPass'),
          unlockBtn    = document.getElementById('unlockBtn'),
          adminControls= document.getElementById('adminControls'),
          adminTable   = document.getElementById('adminTable'),
          resetBtn     = document.getElementById('resetBtn'),
          adminTableContainer = document.getElementById('adminTableContainer');
    adminIconBtn.onclick = () => { adminModal.classList.add('active'); }; // Updated click handler
    adminClose.onclick = () => { adminModal.classList.remove('active'); };

    // Firebase init
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebaseapp.com",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth        = firebase.auth(),
          votesRef    = firebase.database().ref('votes'),
          configRef   = firebase.database().ref('config/liveLeaderboardEnabled'),
          usersRef    = firebase.database().ref('users'),
          badgesRef   = firebase.database().ref('badges'); // Added reference to badges

    // DOM refs for voting form
    const voteContainer = document.getElementById('voteContainer');
    // Normalize helper
    // Updated normalize function to handle case-insensitivity and ensure consistent keys
    function normalize(name){
      if (!name) return '';
      // Remove non-alphanumeric characters and convert to lowercase
      return name.toLowerCase().replace(/[^a-z0-9]/g,'');
    }

    // Leaderboard DOM references for different views
    const viewModeDisplay = document.getElementById('viewModeDisplay'); // New display for current mode
    const viewLeftArrow = document.getElementById('viewLeftArrow');
    const viewRightArrow = document.getElementById('viewRightArrow');

    const leaderboardContent = document.getElementById('leaderboardContent');
    const podiumContent = document.getElementById('podiumContent');
    const tilesContent = document.getElementById('tilesContent');

    const viewModes = ['list', 'podium', 'tiles'];
    let currentViewIndex = 0; // Start with 'list'

    // Function to show the selected leaderboard view
    function showLeaderboardView(view) {
      leaderboardContent.style.display = 'none';
      podiumContent.style.display = 'none';
      tilesContent.style.display = 'none';

      if (view === 'list') {
        leaderboardContent.style.display = 'block';
        viewModeDisplay.textContent = 'List';
      } else if (view === 'podium') {
        podiumContent.style.display = 'flex'; // Use flex for podium layout
        viewModeDisplay.textContent = 'Podium';
      } else if (view === 'tiles') {
        tilesContent.style.display = 'block';
        viewModeDisplay.textContent = 'Tiles';
      }
      // Trigger animation
      viewModeDisplay.classList.remove('animate');
      void viewModeDisplay.offsetWidth; // Trigger reflow
      viewModeDisplay.classList.add('animate');

      // Update currentViewIndex
      currentViewIndex = viewModes.indexOf(view);
    }

    // Arrow button functionality
    viewLeftArrow.onclick = () => {
        currentViewIndex = (currentViewIndex - 1 + viewModes.length) % viewModes.length;
        showLeaderboardView(viewModes[currentViewIndex]);
    };

    viewRightArrow.onclick = () => {
        currentViewIndex = (currentViewIndex + 1) % viewModes.length;
        showLeaderboardView(viewModes[currentViewIndex]);
    };


    // Leaderboard update function
    async function updateLeaderboard(){
      const [votesSnap, usersSnap, badgesSnap] = await Promise.all([
        votesRef.once('value'),
        usersRef.once('value'),
        badgesRef.once('value') // Fetch badges data
      ]);
      const allVotes = votesSnap.val() || {};
      const allUsers = usersSnap.val() || {};
      const allBadges = badgesSnap.val() || {}; // All badges data

      // Build nameKey (normalized displayName/email) => UID map for all registered users
      // Use the actual displayName or email from Firebase as the key for matching
      const nameToUidMap = {};
      const normalizedNameToOriginalNameMap = {}; // To map normalized name back to original display name
      for (const uid in allUsers) {
        const user = allUsers[uid];
        const originalName = user.displayName || user.email || '';
        const nameKey = normalize(originalName);
        if (nameKey) { // Ensure nameKey is not empty
          nameToUidMap[nameKey] = uid;
          normalizedNameToOriginalNameMap[nameKey] = originalName;
        }
      }

      const off = {}, def = {};
      
      // Group votes by normalized name and collect all UIDs that voted for that name
      for (const voteKey in allVotes) {
        const v = allVotes[voteKey];
        const o = normalize(v.bestOffence || '');
        const d = normalize(v.bestDefence || '');
        
        if (o) {
          if (!off[o]) {
            off[o] = { count: 0, voterUids: new Set() }; // Renamed uids to voterUids for clarity
          }
          off[o].count++;
          if (v.uid) off[o].voterUids.add(v.uid);
        }
        if (d) {
          if (!def[d]) {
            def[d] = { count: 0, voterUids: new Set() }; // Renamed uids to voterUids for clarity
          }
          def[d].count++;
          if (v.uid) def[d].voterUids.add(v.uid);
        }
      }

      // Convert counts to entries and sort, associating with the correct player's user data
      const processEntries = (entriesMap) => {
        return Object.entries(entriesMap).map(([normalizedName, data]) => {
          const votedForUid = nameToUidMap[normalizedName]; // Get the UID of the *voted-for player*
          const representativeUser = votedForUid ? allUsers[votedForUid] : null; // Get their actual user object
          const originalDisplayName = normalizedNameToOriginalNameMap[normalizedName] || normalizedName; // Use original name for display

          return { name: originalDisplayName, count: data.count, user: representativeUser, uid: votedForUid }; // Added uid
        }).sort((a, b) => b.count - a.count);
      };

      const offenseEntries = processEntries(off);
      const defenseEntries = processEntries(def);

      renderList('offenseScores', offenseEntries);
      renderList('defenseScores', defenseEntries);
      renderPodium('offensePodium', offenseEntries);
      renderPodium('defensePodium', defenseEntries);
      renderTiles('offenseTiles', offenseEntries);
      renderTiles('defenseTiles', defenseEntries);

      // Store processed data globally for voted user profile display
      window.leaderboardData = { allVotes, allUsers, allBadges, normalizedNameToOriginalNameMap };
    }

    // Default profile picture URL
    const DEFAULT_AVATAR_URL = 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';

    function renderList(id, entries){
      const ul=document.getElementById(id);
      ul.innerHTML='';
      if(!entries.length){ ul.innerHTML='<li>No votes yet.</li>'; return; }
      entries.forEach((data,i)=>{
        const { name, count, user } = data;
        const li=document.createElement('li');
        
        let isDiamond = false;
        let customGradient = null;
        let customBanner = null;
        let customNameColor = null;

        // Check if the user object exists and has profile customization unlocked
        if (user && user.profileCustomizationUnlocked) {
            const codesUnlocked = user.codesUnlocked || {};
            // Check if the user has the 'diamond' code unlocked
            if (codesUnlocked.diamond) {
                isDiamond = true;
                const custom = user.profileCustomization || {};
                customGradient = custom.gradient;
                customBanner = custom.banner;
                customNameColor = custom.nameColor;
            }
        }

        const listItemContent = document.createElement('div');
        listItemContent.className = 'list-item-content';

        const nameAndAvatar = document.createElement('div');
        nameAndAvatar.className = 'name-and-avatar';

        const avatar = document.createElement('img');
        avatar.src = user && user.avatar ? user.avatar : DEFAULT_AVATAR_URL;
        avatar.className = 'avatar-small';
        // All avatars in list view are 28px, unless diamond then 32px
        // Their sizing is now handled by CSS rules for .avatar-small and .diamond-member-entry .avatar-small
        nameAndAvatar.appendChild(avatar);
        
        const n = document.createElement('span');
        n.className = 'name';
        n.textContent = name;
        nameAndAvatar.appendChild(n);

        listItemContent.appendChild(nameAndAvatar);

        const c = document.createElement('span');
        c.className = 'count';
        c.textContent = count;
        listItemContent.appendChild(c);

        li.appendChild(listItemContent);

        // Apply custom styling if diamond (for all diamond members in list view)
        // Also apply custom styling if top 3 and diamond
        if (isDiamond) {  
            li.classList.add('diamond-member-entry');
            // Set CSS variables for custom gradient and banner
            if (customGradient) listItemContent.style.setProperty('--custom-gradient-bg', customGradient);
            if (customBanner) {
                const bannerDiv = document.createElement('div');
                bannerDiv.className = 'background-banner';
                bannerDiv.style.backgroundImage = `url('${customBanner}')`;
                listItemContent.appendChild(bannerDiv);
            }
            if (customNameColor) n.style.color = customNameColor;
            // Avatar size for diamond members is handled by .leaderboard li.diamond-member-entry .avatar-small
        } else { // Standard styling for non-diamond members
            // Apply top 3 name styling if applicable
            if(i===0) n.classList.add('first-place');
            else if(i===1) n.classList.add('second-place');
            else if(i===2) n.classList.add('third-place');
            else {
                n.style.color = '#e8ebfc'; /* Default color for non-top3, non-diamond */
                n.style.fontSize = '1.06rem';
                n.style.background = 'none';
                n.style.fontWeight = '600';
            }
        }
        ul.append(li);
      });
    }

    // Function to render the podium view
    function renderPodium(id, entries) {
      const podiumDiv = document.getElementById(id);
      podiumDiv.innerHTML = '';
      if (!entries.length) {
        podiumDiv.innerHTML = '<p>No votes yet.</p>';
        return;
      }

      // Get top 3 entries for the podium
      const topEntries = entries.slice(0, 3);

      // Create a temporary array to hold podium items in the correct order (2nd, 1st, 3rd)
      let orderedPodium = [];
      if (topEntries.length >= 2) {
        orderedPodium[1] = topEntries[0]; // 1st place
        orderedPodium[0] = topEntries[1]; // 2nd place
        if (topEntries.length >= 3) {
          orderedPodium[2] = topEntries[2]; // 3rd place
        }
      } else if (topEntries.length === 1) {
        orderedPodium[1] = topEntries[0]; // Only 1st place
      }

      const ranks = ['silver', 'gold', 'bronze'];
      const rankNumbers = ['2', '1', '3']; // For the stand numbers

      const podiumHTML = orderedPodium.map((data, index) => {
        if (!data) return ''; // Handle cases where there aren't enough entries for all 3 spots
        const { name, count, user } = data;
        const rankClass = ranks[index];
        const rankNum = rankNumbers[index];
        
        let avatarHtml = '';
        const avatarSrc = user && user.avatar ? user.avatar : DEFAULT_AVATAR_URL;
        avatarHtml = `<img src="${avatarSrc}" class="avatar-small" alt="${name}'s Avatar">`;
        
        let podiumStandStyle = '';
        let podiumStandClass = '';
        let glowColor = '';

        // Apply custom gradient to podium bar if user is diamond
        if (user && user.profileCustomizationUnlocked && user.codesUnlocked && user.codesUnlocked.diamond && user.profileCustomization && user.profileCustomization.gradient) {
            podiumStandStyle = `background: ${user.profileCustomization.gradient};`;
            podiumStandClass = 'custom-gradient';
            // Extract a color from the gradient for the glow effect
            const gradientMatch = user.profileCustomization.gradient.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (gradientMatch) {
                glowColor = `rgba(${gradientMatch[1]}, ${gradientMatch[2]}, ${gradientMatch[3]}, 0.8)`;
            } else {
                glowColor = '#fff'; // Fallback
            }
        } else {
            // Default podium stand gradients based on rank
            if (rankClass === 'gold') podiumStandStyle = 'background: linear-gradient(135deg, #FFD700, #b8860b);';
            else if (rankClass === 'silver') podiumStandStyle = 'background: linear-gradient(135deg, #C0C0C0, #a0a0a0);';
            else if (rankClass === 'bronze') podiumStandStyle = 'background: linear-gradient(135deg, #CD7F32, #8B4513);';
        }


        return `
          <div class="podium-item ${rankClass}">
            ${avatarHtml}
            <span class="name">${name}</span>
            <div class="podium-stand ${rankClass} ${podiumStandClass}" style="${podiumStandStyle}; --custom-podium-gradient: ${podiumStandStyle}; --custom-podium-glow-color: ${glowColor}; --custom-podium-shadow-color: ${glowColor};"><span>${rankNum}</span></div>
            </div>
        `;
      }).join('');
      podiumDiv.innerHTML = podiumHTML;
    }

    // Function to render the tiles view
    function renderTiles(id, entries) {
      const tilesDiv = document.getElementById(id);
      tilesDiv.innerHTML = '';
      if (!entries.length) {
        tilesDiv.innerHTML = '<p>No votes yet.</p>';
        return;
      }
      const tilesHTML = entries.map((data, i) => {
        const { name, count, user } = data;
        let avatarHtml = '';
        const avatarSrc = user && user.avatar ? user.avatar : DEFAULT_AVATAR_URL;
        avatarHtml = `<img src="${avatarSrc}" class="avatar-small" alt="${name}'s Avatar">`;
        

        let isDiamond = false;
        let customGradient = null;
        let customBanner = null;
        let customNameColor = null;

        // Check if the user object exists and has profile customization unlocked
        if (user && user.profileCustomizationUnlocked) {
            const codesUnlocked = user.codesUnlocked || {};
            // Check if the user has the 'diamond' code unlocked
            if (codesUnlocked.diamond) {
                isDiamond = true;
                const custom = user.profileCustomization || {};
                customGradient = custom.gradient;
                customBanner = custom.banner;
                customNameColor = custom.nameColor;
            }
        }

        let backgroundBannerHtml = '';
        let gradientAreaHtml = ''; // New variable for the gradient div
        let nameStyle = '';

        // Apply custom styling if diamond (for all ranks in tiles view)
        if (isDiamond) {  
            if (customBanner) {
                backgroundBannerHtml = `<div class="background-banner" style="background-image: url('${customBanner}');"></div>`;
            }
            if (customGradient) {
                gradientAreaHtml = `<div class="gradient-area" style="background: ${customGradient};"></div>`;
            }
            nameStyle = customNameColor ? `color: ${customNameColor};` : '';
            
            // For diamond members, the entire tile-item should have the gradient
            return `
              <div class="tile-item diamond-member-entry">
                ${backgroundBannerHtml}
                ${gradientAreaHtml} <!-- Inject the new gradient area -->
                <div class="content-wrapper">
                    ${avatarHtml}
                    <div class="name" style="${nameStyle}">${name}</div>
                    <div class="count">${count}</div>
                </div>
              </div>
            `;

        } else { // Standard rendering for non-diamond members
            return `
              <div class="tile-item">
                ${avatarHtml}
                <div class="name">${name}</div>
                <div class="count">${count}</div>
              </div>
            `;
        }
      }).join('');
      tilesDiv.innerHTML = tilesHTML;
    }

    // Function to render the user's profile and stats after voting
    async function renderVotedUserProfile(currentUser, allVotes, allUsers, allBadges, normalizedNameToOriginalNameMap) {
        const uid = currentUser.uid;
        const userData = allUsers[uid] || {};
        const userBadges = allBadges[uid] || {};

        const avatarSrc = userData.avatar || DEFAULT_AVATAR_URL;
        const username = userData.username || currentUser.displayName || currentUser.email || 'Guest';
        const profileCustomization = userData.profileCustomization || {};
        const isDiamond = userData.profileCustomizationUnlocked && userData.codesUnlocked && userData.codesUnlocked.diamond;

        let bannerStyle = '';
        if (isDiamond && profileCustomization.banner) {
            bannerStyle = `background-image: url('${profileCustomization.banner}');`;
        }

        let cardStyle = '';
        if (isDiamond && profileCustomization.gradient) {
            cardStyle = `background: ${profileCustomization.gradient};`;
        } else {
            cardStyle = `background: rgba(36,40,48,0.65);`; // Default panel background
        }

        let usernameColor = '#fff'; // Default text color
        if (isDiamond && profileCustomization.nameColor) {
            usernameColor = profileCustomization.nameColor;
        }

        // Calculate Rank
        let offenseRank = 'N/A';
        let defenseRank = 'N/A';

        const offenseCounts = {};
        const defenseCounts = {};

        // Count votes for all players
        for (const voteKey in allVotes) {
            const vote = allVotes[voteKey];
            const offensePlayer = normalize(vote.bestOffence || '');
            const defensePlayer = normalize(vote.bestDefence || '');

            if (offensePlayer) {
                offenseCounts[offensePlayer] = (offenseCounts[offensePlayer] || 0) + 1;
            }
            if (defensePlayer) {
                defenseCounts[defensePlayer] = (defenseCounts[defensePlayer] || 0) + 1;
            }
        }

        // Sort players by votes to determine rank
        const sortedOffense = Object.entries(offenseCounts).sort(([, countA], [, countB]) => countB - countA);
        const sortedDefense = Object.entries(defenseCounts).sort(([, countA], [, countB]) => countB - countA);

        // Use the normalized version of the current user's name for matching against vote counts
        const normalizedCurrentUserDisplayName = normalize(currentUser.displayName || currentUser.email);

        const findRank = (sortedEntries, targetNormalizedName) => {
            for (let i = 0; i < sortedEntries.length; i++) {
                if (sortedEntries[i][0] === targetNormalizedName) {
                    return `#${i + 1}`;
                }
            }
            return 'N/A';
        };

        offenseRank = findRank(sortedOffense, normalizedCurrentUserDisplayName);
        defenseRank = findRank(sortedDefense, normalizedCurrentUserDisplayName);

        // Display the higher rank if available, otherwise "N/A"
        let overallRank = 'N/A';
        if (offenseRank !== 'N/A' && defenseRank !== 'N/A') {
            const offenseNum = parseInt(offenseRank.substring(1));
            const defenseNum = parseInt(defenseRank.substring(1));
            overallRank = `#${Math.min(offenseNum, defenseNum)}`;
        } else if (offenseRank !== 'N/A') {
            overallRank = offenseRank;
        } else if (defenseRank !== 'N/A') {
            overallRank = defenseRank;
        }

        // Calculate Votes Received
        let votesReceived = 0;
        if (offenseCounts[normalizedCurrentUserDisplayName]) {
            votesReceived += offenseCounts[normalizedCurrentUserDisplayName];
        }
        if (defenseCounts[normalizedCurrentUserDisplayName]) {
            votesReceived += defenseCounts[normalizedCurrentUserDisplayName];
        }

        // Calculate Wins (from badges)
        const wins = (userBadges.offence || 0) + (userBadges.defence || 0);

        voteContainer.innerHTML = `
            <div class="voted-profile-card" style="${cardStyle}">
                <div class="voted-profile-banner" style="${bannerStyle}"></div>
                <img src="${avatarSrc}" alt="Your Avatar" class="voted-profile-avatar"/>
                <div class="voted-profile-username" style="color: ${usernameColor};">${username}</div>
                <div class="voted-profile-stats">
                    <div class="stat-item">
                        Rank: <span class="stat-value">${overallRank}</span>
                    </div>
                    <div class="stat-item">
                        Votes: <span class="stat-value">${votesReceived}</span>
                    </div>
                    <div class="stat-item">
                        Wins: <span class="stat-value">${wins}</span>
                    </div>
                </div>
            </div>
        `;
    }

    // Average rating
    function updateAverageRating(){
      votesRef.once('value').then(snap=>{
        let sum=0,n=0;
        snap.forEach(c=>{
          const r=c.val().rating;
          if(typeof r==='number'&&r>0){ sum+=r; n++; }
        });
        document.getElementById('avgRatingNum').textContent = n? (sum/n).toFixed(2): '–';
      });
    }
    // Render voting form
    function renderForm(user, opts){
      voteContainer.innerHTML=`
        <label>Your Username</label>
        <input readonly id="username" value="${user.displayName||user.email||''}"/>
        <div class="hint">Pick the name you played under.</div>
        <label>Best offence</label>
        <select id="offence">${opts}</select>
        <div class="hint">Choose from registered players.</div>
        <label>Best defence</label>
        <select id="defence">${opts}</select>
        <div class="hint">Choose from registered players.</div>
        <label>Rate today's event</label>
        <div class="stars" id="starContainer">
          <span data-value="1">★</span><span data-value="2">★</span>
          <span data-value="3">★</span><span data-value="4">★</span>
          <span data-value="5">★</span>
        </div>
        <button id="submitBtn" disabled>Submit Vote</button>`;
      const off=document.getElementById('offence'),
            def=document.getElementById('defence'),
            stars=document.getElementById('starContainer').children,
            sub=document.getElementById('submitBtn');
      let rating=0;
      function updateBtn(){ sub.disabled=!(off.value&&def.value&&rating>0); }
      Array.from(stars).forEach(s=>{
        s.onclick=()=>{
          rating=+s.dataset.value;
          Array.from(stars).forEach(x=>x.classList.toggle('filled',+x.dataset.value<=rating));
          updateBtn();
        };
      });
      off.onchange=updateBtn;
      def.onchange=updateBtn;
      votesRef.orderByChild('uid').equalTo(user.uid).once('value').then(async snap=>{
        if(snap.exists()){
          // User has already voted, display their profile and stats
          // Ensure leaderboardData is available before calling renderVotedUserProfile
          if (window.leaderboardData) {
            renderVotedUserProfile(user, window.leaderboardData.allVotes, window.leaderboardData.allUsers, window.leaderboardData.allBadges, window.leaderboardData.normalizedNameToOriginalNameMap);
          } else {
            // If leaderboardData isn't ready, fetch it
            const [votesSnap, usersSnap, badgesSnap] = await Promise.all([
                votesRef.once('value'),
                usersRef.once('value'),
                badgesRef.once('value')
            ]);
            // Re-build normalizedNameToOriginalNameMap here as well
            const normalizedNameToOriginalNameMap = {};
            const allUsersLocal = usersSnap.val() || {};
            for (const uid in allUsersLocal) {
                const userData = allUsersLocal[uid];
                const originalName = userData.displayName || userData.email || '';
                const nameKey = normalize(originalName);
                if (nameKey) {
                    normalizedNameToOriginalNameMap[nameKey] = originalName;
                }
            }

            window.leaderboardData = {
                allVotes: votesSnap.val() || {},
                allUsers: usersSnap.val() || {},
                allBadges: badgesSnap.val() || {},
                normalizedNameToOriginalNameMap: normalizedNameToOriginalNameMap
            };
            renderVotedUserProfile(user, window.leaderboardData.allVotes, window.leaderboardData.allUsers, window.leaderboardData.allBadges, window.leaderboardData.normalizedNameToOriginalNameMap);
          }
        }
      });
      sub.onclick=()=>{
        sub.disabled=true;
        votesRef.push({
          uid:user.uid,
          username:user.displayName||user.email,
          bestOffence:off.value,
          bestDefence:def.value,
          rating,
          time:firebase.database.ServerValue.TIMESTAMP
        })
        .then(()=>{ kcAlert('Thanks for voting!'); updateLeaderboard(); updateAverageRating(); })
        .catch(e=>kcAlert('Error submitting: '+e.message))
        .finally(()=>renderForm(user,opts));
      };
    }
    // Auth listener
    auth.onAuthStateChanged(u=>{
      if(!u){
        voteContainer.innerHTML =
          `<p>Please <a href="https://kcevents.uk/#loginpage" target="_blank" rel="noopener">log in</a> to vote.</p>`;
        return;
      }
      // sync profile + emailVerified
      usersRef.child(u.uid).update({
        displayName: u.displayName||null,
        email:       u.email        ||null,
        joined:      firebase.database.ServerValue.TIMESTAMP,
        emailVerified: u.emailVerified
      });
      // block unverified
      if(!u.emailVerified){
        kcAlert('Please verify your email before voting.');
        voteContainer.innerHTML =
          `<p>Verify your email to vote. <a href="https://kcevents.uk/#loginpage" target="_blank" rel="noopener">Resend verification</a></p>`;
        return;
      }
      // fetch all users, filter client-side on emailVerified
      usersRef.once('value').then(snap=>{
        let opts='<option value="" disabled selected>– Select a player –</option>';
        snap.forEach(c=>{
          const userVal=c.val();
          if(userVal.emailVerified){
            const name=userVal.displayName||userVal.email||'(unknown)',
                  esc=name.replace(/"/g,'&quot;');
            opts+=`<option value="${esc}">${esc}</option>`;
          }
        });
        renderForm(u,opts);
      });
    });
    // Admin unlock logic in modal
    unlockBtn.onclick = ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      if(!document.getElementById('toggleLeaderboard')){
        const lbl=document.createElement('label');
        lbl.innerHTML=`<input type="checkbox" id="toggleLeaderboard"/> Enable Live Leaderboard`;
        adminControls.appendChild(lbl);
        const chk=document.getElementById('toggleLeaderboard');
        configRef.once('value').then(s=> chk.checked=s.val()!==false);
        const save=document.createElement('button');
        save.textContent='Save Leaderboard Setting';
        save.style.marginTop='.5rem';
        adminControls.appendChild(save);
        save.onclick=()=>{
          configRef.set(chk.checked)
            .then(()=>kcAlert('Live leaderboard setting saved.'))
            .catch(e=>kcAlert('Save failed: '+e.message));
        };
      }
      // populate table
      votesRef.orderByChild('time').once('value').then(snap=>{
        let html=`<tr><th>Date</th><th>User</th><th>Offence</th><th>Defence</th><th>Rating</th><th>Delete</th></tr>`;
        snap.forEach(c=>{
          const v=c.val(), d=new Date(v.time).toLocaleString();
          html+=`<tr data-key="${c.key}"><td>${d}</td><td>${v.username}</td>
                  <td>${v.bestOffence}</td><td>${v.bestDefence}</td>
                  <td>${v.rating}/5</td>
                  <td><button class="delBtn">Delete</button></td></tr>`;
        });
        adminTable.innerHTML=html;
        updateLeaderboard(); updateAverageRating();
      });
    };
    adminTable.addEventListener('click',async e=>{
      if(!e.target.matches('.delBtn')) return;
      const key=e.target.closest('tr').dataset.key;
      if(!await kcConfirm('Delete this vote?')) return;
      votesRef.child(key).remove()
        .then(()=>{ kcAlert('Vote deleted.'); updateLeaderboard(); updateAverageRating(); })
        .catch(err=>kcAlert('Delete failed: '+err.message));
    });
    resetBtn.onclick=async ()=>{
      if(adminPass.value!=='events2025KC') return kcAlert('Incorrect password.');
      if(!await kcConfirm('Reset all votes? This cannot be undone.')) return;
      const snap=await votesRef.once('value'), tasks=[];
      snap.forEach(c=>tasks.push(votesRef.child(c.key).remove()));
      Promise.all(tasks)
        .then(()=>{ adminTable.innerHTML=''; kcAlert('All votes have been reset.'); updateLeaderboard(); updateAverageRating(); })
        .catch(err=>kcAlert('Reset failed: '+err.message));
    };

    // Live toggle & init
    configRef.on('value',snap=>{
      const on=snap.val()!==false;
      if (on) {
        document.getElementById('leaderboardOffMessage').style.display = 'none';
        showLeaderboardView(viewModes[currentViewIndex]); // Show the currently selected view
        document.querySelector('.view-selector-container').style.display = 'flex'; // Show new selector
      } else {
        leaderboardContent.style.display = 'none';
        podiumContent.style.display = 'none';
        tilesContent.style.display = 'none';
        document.getElementById('leaderboardOffMessage').style.display = 'block';
        document.querySelector('.view-selector-container').style.display = 'none'; // Hide new selector
      }
      if(on) updateLeaderboard();
    });

    // Initial load
    updateLeaderboard();
    updateAverageRating();
    showLeaderboardView(viewModes[currentViewIndex]); // Set initial view based on current index
  </script>
</body>
</html>
