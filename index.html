<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin:0; padding:1rem;
      font-family:'Poppins',sans-serif;
      color:#fff;
      background:transparent;
    }
    .container { display:flex; gap:1rem; flex-wrap:wrap; }
    .panel {
      background:rgba(0,0,0,0.6);
      border-radius:12px;
      padding:1rem;
      flex:1 1 240px;
      max-width:300px;
      box-sizing:border-box;
    }
    .chat {
      flex:2 1 400px;
      max-width:600px;
      overflow-y:auto;
      max-height:600px;
    }
    h3 { margin-top:0; }
    textarea, input[type=text] {
      width:100%; padding:.5rem;
      border:none; border-radius:6px;
      margin-top:.3rem; box-sizing:border-box;
      resize:none;
    }
    textarea { height:100px; }
    .colors {
      display:flex; gap:.5rem; margin:1rem 0;
    }
    .colors div {
      width:32px; height:32px; border-radius:6px;
      cursor:pointer;
      border:2px solid transparent;
    }
    .colors .sel { border-color:#fff; }
    #sendBtn, #saveProfile, #signOut {
      width:100%; padding:.6rem;
      border:none; border-radius:6px;
      font-weight:600; cursor:pointer;
      margin-top:.8rem;
    }
    #sendBtn { background:#22c55e; color:#fff; }
    #saveProfile { background:#22c55e; color:#fff; }
    #signOut { background:#ef4444; color:#fff; }
    .msg {
      background:rgba(255,255,255,0.1);
      border-radius:8px;
      padding:.6rem;
      margin-bottom:.5rem;
      position:relative;
    }
    .msg .header {
      display:flex; align-items:center; gap:.6rem;
    }
    .msg .username { font-weight:600; }
    .msg .time { font-size:.75rem; color:#ccc; margin-left:auto;}
    .msg .text { margin:.5rem 0; }
    .msg .actions {
      display:flex; gap:.5rem; font-size:.9rem;
    }
    .msg .actions button {
      background:rgba(255,255,255,0.1); border:none;
      border-radius:6px; padding:.2rem .5rem;
      cursor:pointer; color:#fff;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- PROFILE PANEL -->
    <div class="panel">
      <h3>Your KC Events Account:</h3>
      <textarea id="aboutMe" placeholder="Your About Meâ€¦"></textarea>
      <h4>Pick a colour to express yourself!</h4>
      <div class="colors" id="colorPicker">
        <div data-color="#f87171" style="background:#f87171"></div>
        <div data-color="#60a5fa" style="background:#60a5fa"></div>
        <div data-color="#4ade80" style="background:#4ade80"></div>
        <div data-color="#fbbf24" style="background:#fbbf24"></div>
        <div data-color="#a78bfa" style="background:#a78bfa"></div>
      </div>
      <button id="saveProfile">Save Profile</button>
      <button id="signOut">Sign Out</button>
    </div>

    <!-- CHAT PANEL -->
    <div class="panel chat">
      <h3>Pick an emoji!</h3>
      <div id="emojiPicker" style="display:flex;gap:.5rem;flex-wrap:wrap;"></div>
      <input type="text" id="msgInput" placeholder="Your message"/>
      <button id="sendBtn">Send</button>
      <div id="msgs"></div>
    </div>

  </div>

  <script>
    // "Notification" modal
    function kcAlert(msg) {
      alert(`Notification\n\n${msg}`);
    }

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(),
          dbMsg = firebase.database().ref('messages'),
          dbUsers = firebase.database().ref('users');

    // DOM refs
    const aboutMe     = document.getElementById('aboutMe'),
          colorPicker = document.getElementById('colorPicker'),
          saveProfile = document.getElementById('saveProfile'),
          signOutBtn  = document.getElementById('signOut'),
          emojiPicker = document.getElementById('emojiPicker'),
          msgInput    = document.getElementById('msgInput'),
          sendBtn     = document.getElementById('sendBtn'),
          msgsDiv     = document.getElementById('msgs');

    // emoji list & selection
    const EMOJIS = ['ðŸ˜€','ðŸ˜Ž','ðŸ˜‚','ðŸ˜','ðŸ‘','ðŸ™Œ','ðŸ˜‰','ðŸ˜','ðŸ˜¢','ðŸ˜®','ðŸ˜¡','ðŸŽ‰'];
    let selectedEmoji = null;

    // build emoji picker
    EMOJIS.forEach(e => {
      const btn = document.createElement('button');
      btn.textContent = e;
      btn.style.fontSize = '1.5rem';
      btn.onclick = () => {
        selectedEmoji = e;
        Array.from(emojiPicker.children)
             .forEach(x=>x.style.border='none');
        btn.style.border='2px solid #fff';
      };
      emojiPicker.appendChild(btn);
    });

    let currentUser=null, profiles={};

    // render messages
    function renderMsgs() {
      msgsDiv.innerHTML = '';
      dbMsg.orderByChild('time')
           .once('value', snap => {
        profiles = profiles; // already loaded
        snap.forEach(ch => {
          const m = ch.val(), key = ch.key;
          const prof = profiles[m.uid]||{};
          const color = prof.color||'#fff';
          const about = prof.about||'';

          const div = document.createElement('div');
          div.className='msg';
          div.style.borderLeft=`4px solid ${color}`;

          // header
          const hd = document.createElement('div');
          hd.className='header';
          hd.innerHTML = `
            <span class="emoji">${m.emoji||''}</span>
            <span class="username" style="color:${color}">${m.user}</span>
            <span class="time">
              ${new Date(m.time).toLocaleString('en-GB',{
                day:'2-digit',month:'2-digit',year:'2-digit',
                hour:'2-digit',minute:'2-digit'
              })} GMT
            </span>
          `;
          if(about){
            hd.querySelector('.username').title = about;
          }
          div.appendChild(hd);

          // text
          const txt = document.createElement('div');
          txt.className='text';
          txt.textContent = m.text;
          div.appendChild(txt);

          // actions
          const act = document.createElement('div');
          act.className='actions';
          // like
          const likeBtn = document.createElement('button');
          likeBtn.textContent = `â¤ï¸ ${m.likesCount||0}`;
          likeBtn.onclick = () => {
            if(!currentUser) return kcAlert('Log in first!');
            const lk = ch.ref.child('likes/'+currentUser.uid);
            lk.once('value',s=>{
              if(s.exists()) return kcAlert('You already liked!');
              lk.set(true).then(()=>{
                ch.ref.child('likes').once('value',ss=>{
                  ch.ref.child('likesCount').set(ss.numChildren())
                    .then(renderMsgs);
                });
              });
            });
          };
          act.appendChild(likeBtn);
          // reply (placeholder)
          const repBtn = document.createElement('button');
          repBtn.textContent='â†©ï¸ Reply';
          repBtn.onclick = ()=>kcAlert('Reply feature still in progress');
          act.appendChild(repBtn);
          // delete if owner
          if(currentUser && m.uid===currentUser.uid){
            const del = document.createElement('button');
            del.textContent='ðŸ—‘ï¸';
            del.onclick = ()=> ch.ref.remove().then(renderMsgs);
            act.appendChild(del);
          }
          div.appendChild(act);
          msgsDiv.appendChild(div);
        });
      });
    }

    // load all profiles
    function loadProfiles(cb){
      dbUsers.once('value',snap=>{
        profiles = snap.val()||{};
        cb();
      });
    }

    // save profile
    saveProfile.onclick = ()=>{
      if(!currentUser) return kcAlert('Log in first');
      const about = aboutMe.value.trim();
      const color = colorPicker.querySelector('.sel')
                     ?.dataset.color||null;
      dbUsers.child(currentUser.uid)
             .set({about,color})
             .then(()=>kcAlert('Profile saved'))
             .then(()=>loadProfiles(renderMsgs))
             .catch(e=>kcAlert('Save failed'));
    };

    // color pick
    colorPicker.querySelectorAll('div').forEach(div=>{
      div.onclick = ()=>{
        colorPicker.querySelectorAll('div')
                   .forEach(x=>x.classList.remove('sel'));
        div.classList.add('sel');
      };
    });

    // send message
    sendBtn.onclick = ()=>{
      if(!currentUser) return kcAlert('Log in first');
      const text = msgInput.value.trim();
      if(!selectedEmoji||!text) return kcAlert('Emoji & text required');
      dbMsg.push({
        uid: currentUser.uid,
        user: currentUser.displayName||currentUser.email,
        emoji: selectedEmoji,
        text,
        time: firebase.database.ServerValue.TIMESTAMP
      })
      .then(()=>{ msgInput.value=''; renderMsgs(); })
      .catch(e=>kcAlert('Send failed'));
    };

    // auth state observer
    auth.onAuthStateChanged(u=>{
      currentUser=u;
      if(!u){
        kcAlert('Please log in via the KC Events embed');
      } else {
        // preload profile
        dbUsers.child(u.uid).once('value',s=>{
          const p = s.val()||{};
          aboutMe.value = p.about||'';
          if(p.color){
            const d = colorPicker.querySelector(
              `[data-color="${p.color}"]`);
            if(d) d.classList.add('sel');
          }
        });
        loadProfiles(renderMsgs);
      }
    });

    // sign out
    signOutBtn.onclick = ()=>auth.signOut();

  </script>
</body>
</html>
