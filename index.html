<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Board w/ Sort & Reactions</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    * { box-sizing:border-box }
    html,body {
      margin:0; padding:0;
      width:100vw; height:100vh;
      font-family:'Poppins',sans-serif;
      display:flex; background:transparent; color:#fff;
    }
    #msgBoard { display:flex; flex:1; gap:1rem; padding:1rem; }

    /* LEFT PANEL */
    #authContainer {
      flex:1;
      background:rgba(0,0,0,0.4);
      border-radius:12px;
      padding:1rem;
      display:flex; flex-direction:column;
      gap:1rem;
    }
    #authContainer h2 { margin:0 0 .5rem; text-align:center }
    #authContainer input, #authContainer button {
      width:100%; padding:.6rem; margin:.3rem 0;
      border:none; border-radius:6px;
    }
    #authContainer input { background:#fff; color:#000 }
    #authContainer button {
      background:#28a745; color:#fff; font-weight:600;
      cursor:pointer;
    }
    #authContainer button:hover { background:#218838 }

    /* logout red override */
    #logoutBtn{
      background:#dc3545!important; margin-top:auto;
    }
    #logoutBtn:hover{ background:#c82333!important }

    /* emoji picker */
    #emojiPicker, #gradientPicker {
      background:rgba(255,255,255,0.1);
      border-radius:8px; padding:.5rem;
      text-align:center;
    }
    #emojiPicker p, #gradientPicker p { margin:0 0 .5rem; font-weight:600 }
    .emoji { font-size:1.5rem; margin:.3rem; cursor:pointer; opacity:.7;
             display:inline-block; border:1px solid #fff; border-radius:6px; padding:2px 4px;
             transition:.15s }
    .emoji.selected { opacity:1; transform:scale(1.2) }
    .grad {
      display:inline-block; width:32px; height:32px; margin:.3rem;
      border:2px solid transparent; border-radius:6px; cursor:pointer;
      background-size:cover;
      transition:.15s
    }
    .grad.selected { border-color:#fff }

    /* message input */
    #messageInput {
      flex:0 0 auto;
      padding:.6rem; border:none; border-radius:8px;
      width:100%; margin-top:auto;
      background:rgba(255,255,255,0.9); color:#000;
    }
    #postBtn {
      width:100%; margin-top:.3rem;
      padding:.6rem; border:none; border-radius:8px;
      background:#28a745; color:#fff; font-weight:600;
      cursor:pointer;
    }
    #postBtn:disabled { background:#555; cursor:not-allowed }

    /* RIGHT PANEL */
    #messageContainer {
      flex:2;
      display:flex; flex-direction:column;
      background:rgba(0,0,0,0.4);
      border-radius:12px;
      padding:.5rem;
      overflow-y:auto;
    }
    #sortControls { text-align:right; margin-bottom:.5rem }
    #sortSelect {
      background:rgba(255,255,255,0.1);
      color:#fff; border:none; padding:.3rem; border-radius:4px;
    }
    #msgList { list-style:none; padding:0; margin:0; flex:1 }

    .message, .reply {
      display:flex; gap:.5rem; align-items:flex-start;
      padding:.5rem; border-bottom:1px solid rgba(255,255,255,0.2);
    }
    .emojiCell { width:1.5em; text-align:center }
    .content { flex:1 }
    .username {
      font-weight:600; cursor:pointer;
      background-clip:text; -webkit-background-clip:text;
      color:transparent;
    }
    .timestamp {
      display:block; font-size:.75rem;
      color:rgba(255,255,255,0.7); margin-top:.2rem;
    }
    .actions { display:flex; flex-direction:column; gap:.3rem }
    .likeBtn, .replyBtn, .deleteBtn {
      background:transparent; color:#fff; border:1px solid #fff;
      border-radius:6px; padding:2px 6px; cursor:pointer;
      display:flex; align-items:center; gap:.3rem; font-size:.9rem;
    }
    .likeBtn:hover, .replyBtn:hover, .deleteBtn:hover {
      background:rgba(255,255,255,0.1)
    }
    .reactions { display:flex; gap:.3rem; margin-top:.3rem }
    .reactBtn {
      display:flex; align-items:center; gap:.2rem; font-size:.9rem;
      background:rgba(255,255,255,0.1); border-radius:4px;
      padding:2px 4px; cursor:pointer;
    }
    .reactBtn:hover { background:rgba(255,255,255,0.2) }
    .addBtn {
      background:rgba(255,255,255,0.1); color:#fff;
      border-radius:4px; padding:2px 6px;
      cursor:pointer; font-size:.9rem;
      display:inline-flex; align-items:center;
    }
    .addBtn:hover { background:rgba(255,255,255,0.2) }
    .replies { list-style:none; padding:0; margin:0 0 0 2em }
    .toggleReplies {
      margin-top:.5rem; background:transparent; border:none;
      color:#4ade80; cursor:pointer; font-size:.9rem;
    }

    /* Alert overlay (unchanged) */
    #alertModal {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.5);
      align-items:center; justify-content:center; z-index:1000;
    }
    #alertContent {
      background:#fff; color:#000; padding:1rem;
      border-radius:8px; text-align:center; max-width:300px; width:90%;
    }
    #alertContent button {
      margin-top:.5rem; padding:.5rem 1rem;
      background:#28a745; border:none; color:#fff; border-radius:4px;
      cursor:pointer;
    }
  </style>
</head>
<body>

  <!-- ALERT -->
  <div id="alertModal">
    <div id="alertContent">
      <strong>Notification</strong>
      <p id="alertMsg"></p>
      <button id="alertOK">OK</button>
    </div>
  </div>

  <div id="msgBoard">
    <!-- LEFT PANEL -->
    <div id="authContainer">
      <h2>KC Events Account</h2>

      <!-- register / login -->
      <div id="registerForm">
        <input id="regName" placeholder="Display Name"/>
        <input id="regEmail" type="email" placeholder="Email"/>
        <input id="regPass" type="password" placeholder="Password"/>
        <button id="registerBtn">Create Account</button>
        <p style="text-align:center;color:#ccc">
          or <a href="#" id="showLogin" style="color:#4ade80">Log¬†In</a>
        </p>
      </div>
      <div id="loginForm" style="display:none">
        <input id="loginEmail" type="email" placeholder="Email"/>
        <input id="loginPass" type="password" placeholder="Password"/>
        <button id="loginBtn">Log¬†In</button>
        <p style="text-align:center;color:#ccc">
          or <a href="#" id="showRegister" style="color:#4ade80">Create¬†Account</a>
        </p>
      </div>

      <!-- emoji picker -->
      <div id="emojiPicker">
        <p>Pick an emoji!</p>
        <span class="emoji" data-emoji="üòÄ">üòÄ</span>
        <span class="emoji" data-emoji="üòé">üòé</span>
        <span class="emoji" data-emoji="üòÇ">üòÇ</span>
        <span class="emoji" data-emoji="üòç">üòç</span>
        <span class="emoji" data-emoji="üëç">üëç</span>
        <span class="emoji" data-emoji="üôå">üôå</span>
        <span class="emoji" data-emoji="üòâ">üòâ</span>
        <span class="emoji" data-emoji="üòÅ">üòÅ</span>
        <span class="emoji" data-emoji="üò¢">üò¢</span>
        <span class="emoji" data-emoji="üòÆ">üòÆ</span>
        <span class="emoji" data-emoji="üò°">üò°</span>
        <span class="emoji" data-emoji="üéâ">üéâ</span>
      </div>

      <!-- gradient picker -->
      <div id="gradientPicker">
        <p>Pick a gradient!</p>
        <span class="grad" data-grad="linear-gradient(45deg,#ff6b6b,#f06595)"
              style="background:linear-gradient(45deg,#ff6b6b,#f06595)"></span>
        <span class="grad" data-grad="linear-gradient(45deg,#74c0fc,#4dabf7)"
              style="background:linear-gradient(45deg,#74c0fc,#4dabf7)"></span>
        <span class="grad" data-grad="linear-gradient(45deg,#51cf66,#2f9e44)"
              style="background:linear-gradient(45deg,#51cf66,#2f9e44)"></span>
        <span class="grad" data-grad="linear-gradient(45deg,#f9c74f,#f9844a)"
              style="background:linear-gradient(45deg,#f9c74f,#f9844a)"></span>
        <span class="grad" data-grad="linear-gradient(45deg,#845ef7,#5c7cfa)"
              style="background:linear-gradient(45deg,#845ef7,#5c7cfa)"></span>
      </div>

      <!-- message input -->
      <textarea id="messageInput" placeholder="Your message" rows="3"></textarea>
      <button id="postBtn" disabled>Send</button>

      <button id="logoutBtn" style="display:none">Sign¬†Out</button>
    </div>

    <!-- RIGHT PANEL -->
    <div id="messageContainer">
      <div id="sortControls">
        Sort by:
        <select id="sortSelect">
          <option value="recent">Most Recent</option>
          <option value="liked">Most Liked</option>
        </select>
      </div>
      <ul id="msgList">
        <li style="font-style:italic; opacity:.7">Loading‚Ä¶</li>
      </ul>
    </div>
  </div>

  <script>
    // overlay alert
    const alertModal = document.getElementById('alertModal'),
          alertMsg   = document.getElementById('alertMsg'),
          alertOK    = document.getElementById('alertOK');
    function kcAlert(txt){
      alertMsg.textContent = txt;
      alertModal.style.display = 'flex';
    }
    alertOK.onclick = ()=> alertModal.style.display='none';

    // Firebase init
    const cfg = {
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth(),
          db   = firebase.database(),
          msgs = db.ref('messages');

    // profanity
    let badWords = [];
    fetch('https://raw.githubusercontent.com/zacanger/profane-words/master/words.json')
      .then(r=>r.json()).then(list=>badWords=list)
      .catch(_=> kcAlert('Failed loading bad‚Äëwords.'));
    function containsBadWord(s){
      return badWords.some(w=>new RegExp('\\b'+w+'\\b','i').test(s));
    }

    // UI refs
    const registerForm  = document.getElementById('registerForm'),
          loginForm     = document.getElementById('loginForm'),
          showLogin     = document.getElementById('showLogin'),
          showRegister  = document.getElementById('showRegister'),
          regName       = document.getElementById('regName'),
          regEmail      = document.getElementById('regEmail'),
          regPass       = document.getElementById('regPass'),
          registerBtn   = document.getElementById('registerBtn'),
          loginEmail    = document.getElementById('loginEmail'),
          loginPass     = document.getElementById('loginPass'),
          loginBtn      = document.getElementById('loginBtn'),
          logoutBtn     = document.getElementById('logoutBtn'),
          emojiEls      = Array.from(document.querySelectorAll('.emoji')),
          gradEls       = Array.from(document.querySelectorAll('.grad')),
          messageInput  = document.getElementById('messageInput'),
          postBtn       = document.getElementById('postBtn'),
          sortSelect    = document.getElementById('sortSelect'),
          msgList       = document.getElementById('msgList');

    let selectedEmoji    = null,
        selectedGradient = null,
        lastSnap         = null,
        sortMode         = 'recent';

    // toggle forms
    showLogin.onclick = e=>{ e.preventDefault(); registerForm.style.display='none'; loginForm.style.display='block'; }
    showRegister.onclick = e=>{ e.preventDefault(); loginForm.style.display='none'; registerForm.style.display='block'; }

    // register
    registerBtn.onclick = ()=>{
      const n=regName.value.trim(), e=regEmail.value.trim(), p=regPass.value;
      if(!n||!e||!p) return kcAlert('Fill all fields.');
      auth.createUserWithEmailAndPassword(e,p)
          .then(u=> u.user.updateProfile({displayName:n}) )
          .then(()=> msgs.root.child(`users/${auth.currentUser.uid}`)
                          .set({ displayName:n }) )
          .catch(e=>kcAlert(e.message));
    };

    // login
    loginBtn.onclick = ()=>{
      const e=loginEmail.value.trim(), p=loginPass.value;
      if(!e||!p) return kcAlert('Fill both fields.');
      auth.signInWithEmailAndPassword(e,p).catch(e=>kcAlert(e.message));
    };

    // logout
    logoutBtn.onclick = ()=> auth.signOut();

    // pick emoji
    emojiEls.forEach(el=>{
      el.onclick = ()=>{
        emojiEls.forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        selectedEmoji = el.dataset.emoji;
        validatePost();
      };
    });

    // pick gradient
    gradEls.forEach(el=>{
      el.onclick = ()=>{
        gradEls.forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        selectedGradient = el.dataset.grad;
        validatePost();
      };
    });

    // enable post button
    messageInput.oninput = validatePost;
    function validatePost(){
      postBtn.disabled = !(
        auth.currentUser &&
        selectedEmoji &&
        selectedGradient &&
        messageInput.value.trim()
      );
    }

    // render messages
    function render(){
      if(!lastSnap) return;
      msgList.innerHTML = '';
      let arr = [];
      lastSnap.forEach(c=>{
        const v = c.val(); v.key=c.key;
        arr.push(v);
      });
      if(sortMode==='liked')
        arr.sort((a,b)=>(b.likes||0)-(a.likes||0));
      else
        arr.sort((a,b)=>b.time - a.time);

      if(!arr.length){
        const li=document.createElement('li');
        li.style.fontStyle='italic'; li.style.opacity='.7';
        li.textContent='No messages yet.';
        return msgList.appendChild(li);
      }

      arr.forEach(v=>{
        if(containsBadWord(v.user)||containsBadWord(v.text)) return;
        const d=new Date(v.time),
              ts=`${d.getUTCDate().toString().padStart(2,'0')}/`+
                 `${(d.getUTCMonth()+1).toString().padStart(2,'0')}/`+
                 `${d.getUTCFullYear().toString().slice(-2)} `+
                 `${d.getUTCHours().toString().padStart(2,'0')}:`+
                 `${d.getUTCMinutes().toString().padStart(2,'0')} GMT`;

        // build LI
        const li=document.createElement('li');
        li.className='message';
        li.dataset.path=`messages/${v.key}`;
        li.innerHTML=`
          <div class="emojiCell">${v.emoji}</div>
          <div class="content">
            <span class="username">${v.user}</span>
            : ${v.text}
            <span class="timestamp">${ts}</span>
            <button class="toggleReplies">${v.replies?'Show Replies':'No Replies'}</button>
            <ul class="replies"></ul>
            <div class="reactions"></div>
          </div>
          <div class="actions">
            <button class="likeBtn">‚ù§Ô∏è ${v.likes||0}</button>
            <button class="replyBtn">‚Ü©Ô∏è Reply</button>
            ${auth.currentUser&&auth.currentUser.uid===v.uid
               ?'<button class="deleteBtn">üóëÔ∏è Delete</button>':''
            }
          </div>
        `;

        // gradient or white
        let nm=li.querySelector('.username');
        if(v.gradient){
          nm.style.backgroundImage=v.gradient;
          nm.style.webkitBackgroundClip=nm.style.backgroundClip='text';
        } else {
          nm.style.backgroundImage='';
          nm.style.color='#fff';
        }

        msgList.appendChild(li);

        // reactions
        let bar=li.querySelector('.reactions'),
            existing=v.reactions||{};
        Object.keys(existing).forEach(emo=>{
          let cnt=Object.keys(existing[emo]||{}).length,
              btn=document.createElement('div');
          btn.className='reactBtn';
          btn.dataset.path=`${li.dataset.path}/reactions/${emo}`;
          btn.dataset.emo=emo;
          btn.innerHTML=`${emo}<span>${cnt}</span>`;
          bar.appendChild(btn);
        });
        let add=document.createElement('div');
        add.className='addBtn'; add.textContent='‚ûï Add';
        bar.appendChild(add);

        // render nested replies
        if(v.replies){
          let replUL=li.querySelector('.replies');
          replUL.style.display='none';
          recurseReplies(v.replies,replUL,`messages/${v.key}`);
        }

      });
    }

    // recursive replies
    function recurseReplies(obj, ul, base){
      Object.entries(obj).forEach(([k,rv])=>{
        if(containsBadWord(rv.user)||containsBadWord(rv.text)) return;
        let d=new Date(rv.time),
            ts=`${d.getUTCDate().toString().padStart(2,'0')}/`+
               `${(d.getUTCMonth()+1).toString().padStart(2,'0')}/`+
               `${d.getUTCFullYear().toString().slice(-2)} `+
               `${d.getUTCHours().toString().padStart(2,'0')}:`+
               `${d.getUTCMinutes().toString().padStart(2,'0')} GMT`;

        let li=document.createElement('li');
        li.className='reply';
        li.dataset.path=`${base}/replies/${k}`;
        li.innerHTML=`
          <div class="emojiCell">${rv.emoji}</div>
          <div class="content">
            <span class="username">${rv.user}</span>
            : ${rv.text}
            <span class="timestamp">${ts}</span>
            <button class="toggleReplies">${rv.replies?'Show Replies':''}</button>
            <ul class="replies"></ul>
          </div>
        `;
        let nm=li.querySelector('.username');
        if(rv.gradient){
          nm.style.backgroundImage=rv.gradient;
          nm.style.webkitBackgroundClip=nm.style.backgroundClip='text';
        } else nm.style.color='#fff';

        ul.appendChild(li);
        if(rv.replies){
          let child=li.querySelector('.replies');
          child.style.display='none';
          recurseReplies(rv.replies,child,`${base}/replies/${k}`);
        }
      });
    }

    // UI delegation
    document.body.addEventListener('click', e=>{
      let u=auth.currentUser;

      // toggleReplies
      if(e.target.matches('.toggleReplies')){
        let btn=e.target,
            UL=btn.parentNode.querySelector('.replies');
        if(!UL) return;
        UL.style.display = UL.style.display==='block'?'none':'block';
        btn.textContent = UL.style.display==='block'?'Hide Replies':'Show Replies';
        return;
      }

      // like
      if(e.target.closest('.likeBtn')){
        if(!u) return kcAlert('Log in to like.');
        let p=e.target.closest('li').dataset.path;
        db.ref(`${p}/likedBy/${u.uid}`)
          .transaction(cur=>cur===null?true:undefined,
            (err,ok)=> {
              if(err) kcAlert('Error liking.');
              else if(ok) db.ref(`${p}/likes`).transaction(c=> (c||0)+1);
              else kcAlert('You already liked.');
            });
        return;
      }

      // react
      if(e.target.closest('.reactBtn')){
        if(!u) return kcAlert('Log in to react.');
        let btn=e.target.closest('.reactBtn'),
            p=btn.dataset.path;
        db.ref(p+`/${u.uid}`)
          .transaction(cur=>cur===null?true:undefined,
            (err,ok)=> { if(err) kcAlert('Error reacting.'); else if(!ok) kcAlert('Already reacted.'); });
        return;
      }

      // add reaction
      if(e.target.matches('.addBtn')){
        if(!u) return kcAlert('Log in to react.');
        let li=e.target.closest('li'),
            p=li.dataset.path,
            bar=li.querySelector('.reactions'),
            exist=Array.from(bar.querySelectorAll('.reactBtn')).map(x=>x.dataset.emo),
            picker=document.createElement('div');
        picker.className='addPicker';
        ['üòÄ','üòé','üòÇ','üòç','üëç','üôå','üòâ','üòÅ','üò¢','üòÆ','üò°','üéâ']
          .filter(emo=>!exist.includes(emo))
          .forEach(emo=>{
            let s=document.createElement('span');
            s.className='emoji'; s.textContent=emo;
            s.onclick=()=>{
              db.ref(`${p}/reactions/${emo}/${u.uid}`)
                .set(true, err=>{ if(err) kcAlert('Error adding reaction.') });
              picker.remove();
            };
            picker.appendChild(s);
          });
        bar.appendChild(picker);
        return;
      }

      // reply (opens inline form)
      if(e.target.closest('.replyBtn')){
        if(!u) return kcAlert('Log in to reply.');
        let li=e.target.closest('li'),
            p=li.dataset.path+'/replies';
        if(li.nextElementSibling?.classList.contains('reply-row')) return;
        let row=document.createElement('li'); row.className='reply-row';
        let f=document.createElement('div'); f.className='reply-form';
        f.innerHTML=`<input placeholder="Reply..." maxlength="200"/><button>Send</button>`;
        row.appendChild(f);
        li.after(row);
        f.querySelector('button').onclick=()=>{
          let txt=f.querySelector('input').value.trim();
          if(!selectedEmoji) return kcAlert('Pick an emoji.');
          if(!txt) return kcAlert('Enter reply.');
          if(containsBadWord(txt)) return kcAlert('That word‚Äôs not allowed.');
          db.ref(p).push({
            user:u.displayName, uid:u.uid,
            text:txt, emoji:selectedEmoji,
            time:firebase.database.ServerValue.TIMESTAMP,
            likes:0, gradient:selectedGradient
          });
        };
        return;
      }

      // delete own
      if(e.target.closest('.deleteBtn')){
        let p=e.target.closest('li').dataset.path;
        if(confirm('Delete this message and its replies?'))
          db.ref(p).remove();
        return;
      }
    });

    // post new message
    postBtn.onclick = ()=>{
      let u=auth.currentUser, txt=messageInput.value.trim();
      if(!u) return kcAlert('Log in to post.');
      if(!selectedEmoji) return kcAlert('Pick an emoji.');
      if(!selectedGradient) return kcAlert('Pick a gradient.');
      if(!txt) return kcAlert('Enter a message.');
      if(containsBadWord(txt)||containsBadWord(u.displayName))
        return kcAlert('That word‚Äôs not allowed.');

      let ref=msgs.push();
      ref.set({
        user:u.displayName, uid:u.uid,
        text:txt, emoji:selectedEmoji,
        time:firebase.database.ServerValue.TIMESTAMP,
        likes:0, gradient:selectedGradient
      });
      messageInput.value=''; validatePost();
    };

    // listen for new messages
    msgs.on('value',snap=>{
      lastSnap=snap; render();
    });

    // sorting
    sortSelect.onchange = ()=>{
      sortMode=sortSelect.value; render();
    };

    // auth state UI
    auth.onAuthStateChanged(u=>{
      if(u){
        registerForm.style.display='none';
        loginForm.style.display='none';
        logoutBtn.style.display='block';
      } else {
        registerForm.style.display='block';
        loginForm.style.display='none';
        logoutBtn.style.display='none';
      }
      validatePost();
    });
  </script>
</body>
</html>
