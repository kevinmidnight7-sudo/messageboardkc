<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Board w/ Sort & Reactions</title>

  <!-- Poppins + Firebase SDKs -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body {
      margin:0; padding:0;
      width:100vw; height:100vh;
      font-family:'Poppins',sans-serif;
      color:#fff;
      background:transparent;
      display:flex; overflow:hidden;
    }
    #msgBoard { display:flex; flex:1; gap:2em; padding:1em; }

    /* LEFT PANEL */
    #authContainer {
      flex:1;
      background:rgba(0,0,0,0.4);
      border-radius:12px;
      padding:1em;
      display:flex; flex-direction:column;
    }
    #authContainer h2 { text-align:center; margin-bottom:.5em; }
    #authContainer button,input {
      width:100%; margin:.5em 0; padding:.5em;
      border:none; border-radius:6px;
      font-family:'Poppins',sans-serif;
    }
    #logoutBtn {
      background:#dc3545; color:#fff;
      font-weight:600; cursor:pointer;
    }
    #logoutBtn:hover { background:#c82333; }

    #postSection {
      margin-top:1em;
      background:rgba(255,255,255,0.1);
      padding:1em;
      border-radius:8px;
      flex-shrink:0;
    }
    #postSection p { margin:0 0 .5em; font-weight:600; text-align:center; }
    #emojiPicker, #gradientPicker {
      display:flex; justify-content:center; gap:.5em; flex-wrap:wrap; margin-bottom:.75em;
    }
    .emoji, .gradient {
      font-size:1.5em; cursor:pointer; opacity:.7;
      border:1px solid #fff; border-radius:6px;
      padding:4px; transition:.2s;
    }
    .emoji.selected, .gradient.selected { opacity:1; transform:scale(1.2); }
    #postSection input {
      width:100%; padding:.75em; margin:.5em 0;
      border-radius:8px; border:none;
      background:rgba(255,255,255,0.9); color:#000;
    }
    #postSection button#postBtn {
      background:#28a745; color:#fff; font-weight:600;
      cursor:pointer; width:100%; padding:.75em;
    }
    #postSection button#postBtn:hover { background:#218838; }

    /* RIGHT PANEL */
    #messageContainer {
      flex:2;
      display:flex; flex-direction:column;
      background:rgba(0,0,0,0.4);
      border-radius:12px;
      padding:.5em;
      overflow-y:auto;
    }
    #sortControls { text-align:right; margin-bottom:.5em; }
    #sortControls label { color:#fff; font-size:.9em; }
    #sortSelect {
      background:rgba(255,255,255,0.1);
      color:#fff; border:1px solid #fff;
      border-radius:4px; padding:2px 6px;
    }

    #msgList { list-style:none; padding:0; margin:0; flex:1; }
    .message {
      display:flex; align-items:flex-start; gap:.5em;
      padding:.5em; border-bottom:1px solid rgba(255,255,255,0.2);
      position:relative;
    }
    .emojiCell { width:1.5em; text-align:center; }
    .content { flex:1; }
    .username {
      cursor:pointer; font-weight:600;
      background-clip:text; -webkit-background-clip:text;
      color:transparent;
    }
    .timestamp {
      display:block; font-size:.75em;
      color:rgba(255,255,255,0.7); margin-top:.2em;
    }
    .actions {
      display:flex; flex-direction:column; gap:.3em;
    }
    .likeBtn, .replyBtn, .deleteBtn {
      background:transparent; color:#fff;
      border:1px solid #fff; border-radius:6px;
      padding:2px 6px; cursor:pointer;
      font-size:.9em; display:flex; align-items:center; gap:.3em;
    }
    .likeBtn:hover, .replyBtn:hover, .deleteBtn:hover {
      background:rgba(255,255,255,0.1);
    }
    .replies { margin:0 0 0 2em; padding:0; list-style:none; }

    /* ALERT MODAL */
    #alertModal {
      display:none; position:fixed; top:0; left:0;
      width:100%; height:100%; background:rgba(0,0,0,0.5);
      align-items:center; justify-content:center; z-index:1000;
    }
    #alertContent {
      background:#fff; color:#000; padding:1rem;
      border-radius:8px; text-align:center; max-width:300px; width:90%;
    }
    #alertContent strong { display:block; margin-bottom:.5rem; }
    #alertContent button {
      margin-top:.5rem; padding:.5em 1em;
      background:#28a745; color:#fff; border:none; border-radius:4px; cursor:pointer;
    }
  </style>
</head>
<body>

  <!-- ALERT -->
  <div id="alertModal">
    <div id="alertContent">
      <strong>Notification</strong>
      <p id="alertMsg"></p>
      <button id="alertOK">OK</button>
    </div>
  </div>

  <div id="msgBoard">
    <!-- LEFT PANEL -->
    <div id="authContainer">
      <h2>KC Events Account</h2>
      <button id="logoutBtn">Sign Out</button>

      <!-- Post Section -->
      <div id="postSection">
        <p>Pick an emoji!</p>
        <div id="emojiPicker">
          <span class="emoji" data-emoji="üòÄ">üòÄ</span>
          <span class="emoji" data-emoji="üòé">üòé</span>
          <span class="emoji" data-emoji="üòÇ">üòÇ</span>
          <span class="emoji" data-emoji="üòç">üòç</span>
          <span class="emoji" data-emoji="üëç">üëç</span>
          <span class="emoji" data-emoji="üôå">üôå</span>
          <span class="emoji" data-emoji="üòâ">üòâ</span>
          <span class="emoji" data-emoji="üòÅ">üòÅ</span>
          <span class="emoji" data-emoji="üò¢">üò¢</span>
          <span class="emoji" data-emoji="üòÆ">üòÆ</span>
          <span class="emoji" data-emoji="üò°">üò°</span>
          <span class="emoji" data-emoji="üéâ">üéâ</span>
        </div>

        <p>Pick a gradient!</p>
        <div id="gradientPicker">
          <span class="gradient" data-color="linear-gradient(45deg,#ff6b6b,#f06595)" style="background:linear-gradient(45deg,#ff6b6b,#f06595)"></span>
          <span class="gradient" data-color="linear-gradient(45deg,#74c0fc,#4dabf7)" style="background:linear-gradient(45deg,#74c0fc,#4dabf7)"></span>
          <span class="gradient" data-color="linear-gradient(45deg,#51cf66,#2f9e44)" style="background:linear-gradient(45deg,#51cf66,#2f9e44)"></span>
          <span class="gradient" data-color="linear-gradient(45deg,#f9c74f,#f9844a)" style="background:linear-gradient(45deg,#f9c74f,#f9844a)"></span>
          <span class="gradient" data-color="linear-gradient(45deg,#845ef7,#5c7cfa)" style="background:linear-gradient(45deg,#845ef7,#5c7cfa)"></span>
        </div>

        <input id="message" placeholder="Your message" maxlength="200"/>
        <button id="postBtn">Send</button>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div id="messageContainer">
      <div id="sortControls">
        <label for="sortSelect">Sort by:</label>
        <select id="sortSelect">
          <option value="recent">Most Recent</option>
          <option value="liked">Most Liked</option>
        </select>
      </div>
      <ul id="msgList">
        <li style="font-style:italic;color:rgba(255,255,255,0.7)">Loading‚Ä¶</li>
      </ul>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ Alert helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const alertModal = document.getElementById('alertModal'),
          alertMsg   = document.getElementById('alertMsg'),
          alertOK    = document.getElementById('alertOK');
    function kcAlert(txt){
      alertMsg.textContent = txt;
      alertModal.style.display = 'flex';
    }
    alertOK.onclick = ()=> alertModal.style.display='none';

    // ‚îÄ‚îÄ‚îÄ Firebase init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    firebase.initializeApp({
      apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
      authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
      databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kckillerscompany-ab1ec",
      storageBucket: "kckillerscompany-ab1ec.firebasestorage.app",
      messagingSenderId: "198711213988",
      appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
      measurementId: "G-4LKP2M3JXE"
    });
    const auth = firebase.auth(), db = firebase.database();

    // ‚îÄ‚îÄ‚îÄ UI refs & state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const logoutBtn     = document.getElementById('logoutBtn'),
          postBtn       = document.getElementById('postBtn'),
          sortSelect    = document.getElementById('sortSelect'),
          msgList       = document.getElementById('msgList'),
          emojiEls      = document.querySelectorAll('.emoji'),
          gradientEls   = document.querySelectorAll('.gradient'),
          messageInput  = document.getElementById('message');

    let selectedEmoji   = null,
        selectedColor   = null,
        lastSnap        = null,
        sortMode        = 'recent';

    // ‚îÄ‚îÄ‚îÄ Auth & logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    logoutBtn.onclick = ()=> auth.signOut();
    auth.onAuthStateChanged(user=>{
      if(!user) kcAlert('Please log in to post.');
    });

    // ‚îÄ‚îÄ‚îÄ Pickers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    emojiEls.forEach(el=>{
      el.onclick = ()=>{
        emojiEls.forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        selectedEmoji = el.dataset.emoji;
      };
    });
    gradientEls.forEach(el=>{
      el.onclick = ()=>{
        gradientEls.forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        selectedColor = el.dataset.color;
      };
    });

    // ‚îÄ‚îÄ‚îÄ Post new message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    postBtn.onclick = ()=>{
      const user = auth.currentUser;
      const txt  = messageInput.value.trim();
      if(!user)              return kcAlert('Log in to post.');
      if(!selectedEmoji)     return kcAlert('Pick an emoji.');
      if(!selectedColor)     return kcAlert('Pick a gradient.');
      if(!txt)               return kcAlert('Enter a message.');
      const mRef = db.ref('messages').push();
      mRef.set({
        user:  user.displayName,
        uid:   user.uid,
        text:  txt,
        emoji: selectedEmoji,
        color: selectedColor,
        time:  firebase.database.ServerValue.TIMESTAMP,
        likes: 0
      })
      .then(()=> {
        messageInput.value = '';
        emojiEls.forEach(x=>x.classList.remove('selected'));
        gradientEls.forEach(x=>x.classList.remove('selected'));
        selectedEmoji = selectedColor = null;
      })
      .catch(e=> kcAlert('Error posting: '+e.message));
    };

    // ‚îÄ‚îÄ‚îÄ Listen & render messages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    db.ref('messages').on('value', snap=>{
      lastSnap = snap;
      renderMessages();
    });
    sortSelect.onchange = ()=> {
      sortMode = sortSelect.value;
      renderMessages();
    };

    function renderMessages(){
      if(!lastSnap) return;
      msgList.innerHTML = '';
      const arr = [];
      lastSnap.forEach(c=> { let v=c.val(); v.key=c.key; arr.push(v); });
      if(sortMode==='liked') arr.sort((a,b)=>(b.likes||0)-(a.likes||0)); 
      else arr.sort((a,b)=>b.time - a.time);

      if(!arr.length){
        return msgList.innerHTML = `<li style="font-style:italic;color:rgba(255,255,255,0.7)">No messages yet.</li>`;
      }

      arr.forEach(v=>{
        const d= new Date(v.time),
              ts=`${d.getUTCDate()}/${d.getUTCMonth()+1}/${String(d.getUTCFullYear()).slice(-2)} `+
                 `${d.getUTCHours()}:${String(d.getUTCMinutes()).padStart(2,'0')} GMT`;

        const li = document.createElement('li');
        li.className    = 'message';
        li.dataset.path = `messages/${v.key}`;
        li.innerHTML    = `
          <div class="emojiCell">${v.emoji}</div>
          <div class="content">
            <span class="username">${v.user}</span>
            : ${v.text}
            <span class="timestamp">${ts}</span>
          </div>
          <div class="actions">
            <button class="likeBtn">‚ù§Ô∏è ${v.likes||0}</button>
            <button class="replyBtn">‚Ü©Ô∏è Reply</button>
            ${auth.currentUser && auth.currentUser.uid===v.uid
              ? `<button class="deleteBtn">üóëÔ∏è Delete</button>` : ''}
          </div>`;

        // apply gradient
        const uname = li.querySelector('.username');
        if(v.color){
          uname.style.backgroundImage = v.color;
          uname.style.webkitBackgroundClip = uname.style.backgroundClip = 'text';
        } else {
          uname.style.color = '#fff';
        }

        msgList.appendChild(li);
      });
    }

    // ‚îÄ‚îÄ‚îÄ Delegated click handler for like, react, reply, delete ‚îÄ‚îÄ‚îÄ
    document.body.addEventListener('click', e=>{
      const user = auth.currentUser;
      // Like
      if(e.target.closest('.likeBtn')){
        if(!user) return kcAlert('Log in to like.');
        const path = e.target.closest('li').dataset.path,
              uid  = user.uid;
        db.ref(`${path}/likedBy/${uid}`)
          .transaction(cur=> cur===null ? true : undefined,
            (err,comm)=>{
              if(err) kcAlert('Error liking.');
              else if(comm) db.ref(`${path}/likes`).transaction(c=> (c||0)+1 );
              else kcAlert('You already liked this.');
            });
        return;
      }

      // Reply
      if(e.target.closest('.replyBtn')){
        if(!user) return kcAlert('Log in to reply.');
        const parentLi = e.target.closest('li'),
              replyPath = parentLi.dataset.path + '/replies';
        const replyText = prompt('Your reply:');
        if(!replyText) return;
        db.ref(replyPath).push({
          user:  user.displayName,
          uid:   user.uid,
          text:  replyText,
          emoji: 'üí¨',
          color: 'linear-gradient(45deg,#74c0fc,#4dabf7)',
          time:  firebase.database.ServerValue.TIMESTAMP,
          likes: 0
        }).catch(_=> kcAlert('Error replying.'));
        return;
      }

      // Delete
      if(e.target.closest('.deleteBtn')){
        if(!confirm('Delete this message?')) return;
        const path = e.target.closest('li').dataset.path;
        db.ref(path).remove().catch(_=> kcAlert('Error deleting.'));
        return;
      }
    });
  </script>
</body>
</html>
