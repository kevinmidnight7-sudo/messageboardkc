<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KC Event Board w/ Glassmorphism UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      transition: background 0.5s ease, color 0.5s ease;
      overflow-x: hidden;
    }
    
    .light-theme {
      background-image: transparent;
      color: #1a202c;
    }
    
    .dark-theme {
      background-image: transparent;
      color: #e2e8f0;
    }
    
    .glass {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .glass-dark {
      background: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .brand-gradient {
      background: linear-gradient(90deg, #1ee57c, #50b2fa);
    }
    
    .brand-text {
      background-image: linear-gradient(90deg, #1ee57c, #50b2fa);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    
    .member-diamond {
      background-image: linear-gradient(45deg, #A4C5FF, #717DFF);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .member-emerald {
      background-image: linear-gradient(45deg, #A7FFC9, #00FF9D);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .message-text a {
      color: #3b82f6;
      text-decoration: underline;
    }
    
    /* Popover styles */
    .popover {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      padding: 1rem;
      pointer-events: auto; /* Re-enable clicks on the popover */
      transform: translateY(10px);
      position: absolute;
      z-index: 10003; /* Increased z-index to be sure it's on top */
    }
    
    .popover h4 {
        color: white;
    }

    .popover .grad {
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .popover .grad:hover {
      transform: scale(1.1);
    }

    .popover .grad.selected {
      border-color: #007bff;
    }

    .theme-icon {
      color: #fff;
    }
    body.dark-theme .icon-sun { display: none; }
    body.light-theme .icon-moon { display: none; }

    /* Fix for pointer-events on the reactBtn */
    .reactBtn {
        pointer-events: all;
    }
    
  </style>
</head>
<body class="h-full light-theme">
  <!-- Alert modal -->
  <div id="alertModal" class="hidden fixed inset-0 flex items-center justify-center z-[1000] bg-black bg-opacity-50">
    <div id="alertContent" class="bg-gray-800 text-white p-6 rounded-2xl shadow-2xl text-center max-w-sm w-11/12 glass-dark">
      <strong class="text-xl">Notification</strong>
      <p id="alertMsg" class="mt-4 mb-6 text-gray-200"></p>
      <div id="alertBtnRow" class="flex justify-center gap-4">
        <button id="alertCancel" class="hidden px-6 py-2 rounded-xl text-white font-semibold transition-all hover:scale-105 bg-gray-600">Cancel</button>
        <button id="alertOK" class="px-8 py-2 rounded-xl text-white font-bold transition-all hover:scale-105 brand-gradient">OK</button>
      </div>
    </div>
  </div>

  <!-- Reaction Tooltip -->
  <div id="reactionTooltip" class="hidden fixed bg-black text-white p-3 rounded-lg shadow-lg text-sm font-semibold z-[10001] pointer-events-none"></div>
  
  <!-- Gemini Loading Indicator -->
  <div id="geminiLoading" class="hidden fixed top-6 left-1/2 -translate-x-1/2 px-4 py-2 bg-gray-800 text-white rounded-lg shadow-xl z-[10002] flex items-center gap-2 glass-dark">
    <div class="animate-spin h-4 w-4 rounded-full border-2 border-white border-t-transparent"></div>
    <span>AI is Thinking...</span>
  </div>

  <div class="container mx-auto p-4 md:p-6 lg:p-8 flex flex-col items-center min-h-full">
    <div id="loginBar" class="w-full max-w-2xl mt-8 p-6 md:p-8 rounded-2xl glass mb-8">
      <h2 class="text-3xl font-bold text-center mb-6 brand-text">KC Events Account</h2>
      <div class="flex justify-center mb-6 gap-2">
        <button id="showLoginBtn" class="px-4 py-2 text-white font-semibold relative transition-all hover:scale-105 active:scale-95">Log In<span class="absolute bottom-0 left-0 w-full h-[2px] brand-gradient rounded-full opacity-0 scale-x-0 transition-all duration-300"></span></button>
        <button id="showRegisterBtn" class="px-4 py-2 text-white font-semibold relative transition-all hover:scale-105 active:scale-95">Create Account<span class="absolute bottom-0 left-0 w-full h-[2px] brand-gradient rounded-full opacity-0 scale-x-0 transition-all duration-300"></span></button>
      </div>
      <form id="loginForm" class="flex flex-col gap-4">
        <input id="loginEmail" type="email" placeholder="Email" required class="p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-300"/>
        <input id="loginPass" type="password" placeholder="Password" required class="p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-300"/>
        <button id="loginBtn" type="submit" class="p-4 rounded-xl text-white font-bold brand-gradient transition-all hover:scale-105 active:scale-95 shadow-lg shadow-brand-gradient/30">Log In</button>
      </form>
      <form id="registerForm" class="hidden flex-col gap-4">
        <input id="regName" placeholder="Display Name" required class="p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-300"/>
        <input id="regEmail" type="email" placeholder="Email" required class="p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-300"/>
        <input id="regPass" type="password" placeholder="Password" required class="p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-300"/>
        <button id="registerBtn" type="submit" class="p-4 rounded-xl text-white font-bold brand-gradient transition-all hover:scale-105 active:scale-95 shadow-lg shadow-brand-gradient/30">Create Account</button>
      </form>
    </div>

    <div id="composerContainer" class="hidden w-full max-w-2xl mt-8 p-6 md:p-8 rounded-2xl glass mb-8">
      <textarea id="messageInput" placeholder="Add a comment..." rows="3" class="w-full p-4 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/10 text-white placeholder-gray-300 resize-y min-h-[60px]"></textarea>
      <div class="flex justify-between items-center flex-wrap gap-4 mt-4">
        <div class="flex items-center gap-4">
          <!-- The gradient picker button is now correctly displayed based on user profile -->
          <div id="gradientPickerBtn" class="p-3 rounded-full cursor-pointer transition-all hover:scale-110 active:scale-95 glass-dark" title="Pick a gradient">
            <span class="text-xl">🎨</span>
          </div>
          <div id="logoutBtn" class="p-3 rounded-full cursor-pointer transition-all hover:scale-110 active:scale-95 glass-dark" title="Sign Out">
            <span class="text-xl">🚪</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="magicComposeBtn" title="Magic Compose" class="p-3 rounded-full cursor-pointer transition-all hover:scale-110 active:scale-95 glass-dark">
            <span class="text-xl">✨</span>
          </button>
          <button id="postBtn" disabled class="px-6 py-3 rounded-xl text-white font-semibold transition-all hover:scale-105 active:scale-95 brand-gradient disabled:opacity-50 disabled:cursor-not-allowed">
            Submit
          </button>
        </div>
      </div>
      <!-- The popover for the gradient picker is now located in the body, but triggered from here -->
    </div>

    <div id="messageContainer" class="w-full max-w-2xl p-6 md:p-8 rounded-2xl glass">
      <div class="flex justify-between items-center mb-4">
        <strong class="text-xl font-bold">Comments</strong>
        <div class="flex items-center gap-2">
          <label for="sortSelect" class="text-white text-opacity-80">Sort by:</label>
          <select id="sortSelect" class="bg-white/10 text-white rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="recent" class="bg-gray-800">Most Recent</option>
            <option value="liked" class="bg-gray-800">Most Liked</option>
          </select>
        </div>
      </div>
      <ul id="msgList" class="space-y-4">
        <li class="italic opacity-70">Loading…</li>
      </ul>
    </div>
  </div>

  <!-- Theme Switcher -->
  <div id="themeSwitcher" title="Toggle Theme" class="fixed bottom-6 right-6 p-3 rounded-full glass cursor-pointer transition-all hover:scale-110 active:scale-95">
    <svg class="theme-icon icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    <svg class="theme-icon icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
  </div>

  <!-- User Profile Popup -->
  <div id="userPopup" class="hidden fixed inset-0 flex items-center justify-center z-[10000] p-4 bg-black bg-opacity-70 backdrop-blur-sm">
      <div id="userPopupCard" class="w-full max-w-lg rounded-2xl glass overflow-hidden relative">
          <div id="membershipTooltip" class="hidden absolute p-2 rounded-lg bg-gray-800 text-white text-sm font-semibold whitespace-nowrap"></div>
          <div id="popupBanner" class="h-32 bg-gray-600 bg-cover bg-center"></div>
          <div class="p-4 -mt-16">
              <img id="popupAvatar" src="" class="w-28 h-28 rounded-full border-4 border-gray-800 object-cover shadow-lg">
              <button id="closeUserPopup" class="absolute top-4 right-4 text-white text-2xl font-bold bg-black/30 rounded-full w-8 h-8 flex items-center justify-center transition-all hover:bg-black/50">&times;</button>
          </div>
          <div class="p-4 pt-0 text-white">
              <div class="flex items-center gap-2 mb-4">
                  <span id="popupUserName" class="text-3xl font-bold"></span>
                  <span id="popupMemberIcon" class="hidden text-xl"></span>
              </div>
              <div class="bg-white/10 p-4 rounded-xl mb-4">
                  <h4 class="text-sm font-bold text-gray-300 uppercase tracking-wider mb-2">ABOUT ME</h4>
                  <p id="popupAboutMe" class="text-base"></p>
              </div>
              <div class="bg-white/10 p-4 rounded-xl mb-4">
                  <h4 class="text-sm font-bold text-gray-300 uppercase tracking-wider mb-2">BADGES</h4>
                  <div id="popupBadges" class="flex flex-wrap gap-2"></div>
              </div>
              <div id="streakSection" class="bg-white/10 p-4 rounded-xl hidden">
                  <h4 class="text-sm font-bold text-gray-300 uppercase tracking-wider mb-2">STREAK</h4>
                  <div id="popupStreak" class="text-xl font-bold text-orange-400"></div>
              </div>
          </div>
      </div>
  </div>

  <!-- The Popover is now a direct child of the body to fix z-index issues -->
  <div id="gradientPicker" class="popover hidden absolute top-0 left-0 z-[10003] mt-4 p-4 rounded-2xl glass">
    <h4 class="text-center font-bold mb-4">Pick a gradient</h4>
    <div class="grid grid-cols-5 gap-2">
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#ff6b6b,#f06595)" style="background:linear-gradient(45deg,#ff6b6b,#f06595)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#74c0fc,#4dabf7)" style="background:linear-gradient(45deg,#74c0fc,#4dabf7)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#51cf66,#2f9e44)" style="background:linear-gradient(45deg,#51cf66,#2f9e44)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#f9c74f,#f9844a)" style="background:linear-gradient(45deg,#f9c74f,#f9844a)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#845ef7,#5c7cfa)" style="background:linear-gradient(45deg,#845ef7,#5c7cfa)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#f857a6,#ff5858)" style="background:linear-gradient(45deg,#f857a6,#ff5858)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#2dd4bf,#06b6d4)" style="background:linear-gradient(45deg,#2dd4bf,#06b6d4)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#ee9ca7,#ffdde1)" style="background:linear-gradient(45deg,#ee9ca7,#ffdde1)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#43cea2,#185a9d)" style="background:linear-gradient(45deg,#43cea2,#185a9d)"></span>
      <span class="grad w-10 h-10 rounded-lg cursor-pointer transition-all" data-grad="linear-gradient(45deg,#ffaf7b,#d76d77)" style="background:linear-gradient(45deg,#ffaf7b,#d76d77)"></span>
    </div>
  </div>


  <script>
  // overlay alert
  const alertModal = document.getElementById('alertModal'),
        alertMsg   = document.getElementById('alertMsg'),
        alertOK    = document.getElementById('alertOK'),
        alertCancel = document.getElementById('alertCancel');
  function kcAlert(txt){
    alertMsg.textContent = txt;
    alertModal.classList.remove('hidden');
    alertCancel.classList.add('hidden');
    alertOK.textContent = 'OK';
    alertOK.onclick = function() { alertModal.classList.add('hidden'); };
  }
  function kcConfirm(msg, callback) {
    alertMsg.textContent = msg;
    alertModal.classList.remove('hidden');
    alertCancel.classList.remove('hidden');
    alertOK.textContent = 'OK';
    alertOK.onclick = function() {
      alertModal.classList.add('hidden');
      callback(true);
    };
    alertCancel.onclick = function() {
      alertModal.classList.add('hidden');
      callback(false);
    };
  }

  // Firebase init
  const cfg = {
    apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
    authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
    databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kckillerscompany-ab1ec",
    storageBucket: "kckillerscompany-ab1ec.appspot.com",
    messagingSenderId: "198711213988",
    appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
    measurementId: "G-4LKP2M3JXE"
  };
  firebase.initializeApp(cfg);
  const auth = firebase.auth(),
        db   = firebase.database(),
        msgs = db.ref('messages');

  const actionCodeSettings = {
    url: window.location.origin + '/?mode=verifyEmail',
    handleCodeInApp: true
  };

  // verify-email link
  window.addEventListener('load', () => {
    const p = new URLSearchParams(window.location.search),
          mode   = p.get('mode'),
          oobCode= p.get('oobCode');
    if (mode==='verifyEmail' && oobCode) {
      auth.applyActionCode(oobCode)
        .then(() => auth.signInWithEmailLink ? auth.signInWithEmailLink(p.get('email')) : null)
        .then(() => auth.currentUser?.reload())
        .then(() => {
          if (auth.currentUser) {
            return db.ref(`users/${auth.currentUser.uid}/verified`).set(true);
          }
        })
        .then(() => kcAlert('Email verified! You can now log in.'))
        .catch(err => kcAlert('Verification error: ' + err.message));
    }
  });

  // profanity filter
  let badWords = [];
  fetch('https://raw.githubusercontent.com/zacanger/profane-words/master/words.json')
    .then(r=>r.json()).then(list=>badWords=list)
    .catch(_=> console.error('Failed loading bad-words.'));
  function containsBadWord(s){
    return badWords.some(w=>new RegExp('\\b'+w+'\\b','i').test(s));
  }

  // UI refs
  const loginBar = document.getElementById('loginBar');
  const composerContainer = document.getElementById('composerContainer');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const showLoginBtn = document.getElementById('showLoginBtn');
  const showRegisterBtn = document.getElementById('showRegisterBtn');
  
  const regName = document.getElementById('regName');
  const regEmail = document.getElementById('regEmail');
  const regPass = document.getElementById('regPass');
  const registerBtn = document.getElementById('registerBtn');
  
  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');
  const loginBtn = document.getElementById('loginBtn');
  
  const logoutBtn = document.getElementById('logoutBtn');
  const messageInput = document.getElementById('messageInput');
  const postBtn = document.getElementById('postBtn');
  const magicComposeBtn = document.getElementById('magicComposeBtn');
  
  const sortSelect = document.getElementById('sortSelect');
  const msgList = document.getElementById('msgList');
  const reactionTooltip = document.getElementById('reactionTooltip');

  // New composer elements
  const gradientPickerBtn = document.getElementById('gradientPickerBtn');
  const gradientPicker = document.getElementById('gradientPicker');
  const gradEls = Array.from(document.querySelectorAll('.grad'));
  const themeSwitcher = document.getElementById('themeSwitcher');
  const geminiLoading = document.getElementById('geminiLoading');

  let selectedGradient = null;
  let lastSnap = null;
  let sortMode = 'recent';
  let currentUserProfile = null;

  // --- Gemini API Logic ---
  const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
  const GEMINI_API_KEY = ""; // This will be handled by the environment

  async function callGemini(prompt, jsonSchema = null) {
      geminiLoading.classList.remove('hidden');
      try {
          const payload = {
              contents: [{ parts: [{ text: prompt }] }],
          };

          if (jsonSchema) {
              payload.generationConfig = {
                  responseMimeType: "application/json",
                  responseSchema: jsonSchema,
              };
          }

          const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
          });

          if (!response.ok) {
              throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();
          const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
          if (text) {
              return text;
          } else {
              throw new Error("Invalid response structure from API.");
          }
      } catch (error) {
          console.error("Gemini API call error:", error);
          kcAlert("Sorry, the AI feature is currently unavailable.");
          return null;
      } finally {
          geminiLoading.classList.add('hidden');
      }
  }

  // --- Theme Logic ---
  function applyTheme(theme) {
    document.body.classList.remove('light-theme', 'dark-theme');
    document.body.classList.add(theme === 'dark' ? 'dark-theme' : 'light-theme');
  }

  themeSwitcher.onclick = () => {
    const isDarkMode = document.body.classList.contains('dark-theme');
    const newTheme = isDarkMode ? 'light' : 'dark';
    applyTheme(newTheme);
    if (auth.currentUser) {
      db.ref(`users/${auth.currentUser.uid}/theme`).set(newTheme);
    }
  };

  // --- Layout & Auth Logic ---
  showLoginBtn.onclick = () => {
    loginForm.classList.remove('hidden');
    loginForm.classList.add('flex');
    registerForm.classList.add('hidden');
    showLoginBtn.querySelector('span').classList.add('scale-x-100', 'opacity-100');
    showRegisterBtn.querySelector('span').classList.remove('scale-x-100', 'opacity-100');
  };
  showRegisterBtn.onclick = () => {
    loginForm.classList.add('hidden');
    registerForm.classList.remove('hidden');
    registerForm.classList.add('flex');
    showRegisterBtn.querySelector('span').classList.add('scale-x-100', 'opacity-100');
    showLoginBtn.querySelector('span').classList.remove('scale-x-100', 'opacity-100');
  };
  showLoginBtn.querySelector('span').classList.add('scale-x-100', 'opacity-100');

  function togglePopover(popover, button) {
    const popovers = [gradientPicker];
    popovers.forEach(p => {
      if (p !== popover) p.classList.add('hidden');
    });
    popover.classList.toggle('hidden');
    if (!popover.classList.contains('hidden')) {
      const btnRect = button.getBoundingClientRect();
      // Position the popover relative to the button
      popover.style.left = `${btnRect.left}px`;
      popover.style.top = `${btnRect.bottom + window.scrollY + 10}px`;
    }
  }

  gradientPickerBtn.onclick = (e) => { 
    e.stopPropagation(); 
    togglePopover(gradientPicker, gradientPickerBtn);
  };
  
  document.addEventListener('click', (e) => {
    if (!gradientPicker.contains(e.target) && !gradientPickerBtn.contains(e.target)) { 
      gradientPicker.classList.add('hidden'); 
    }
  });

  registerForm.onsubmit = (e) => {
    e.preventDefault();
    const name  = regName.value.trim(), email = regEmail.value.trim(), pass  = regPass.value;
    if (!name || !email || !pass) return kcAlert('Fill all fields.');
    auth.createUserWithEmailAndPassword(email, pass)
      .then(uCred => 
        uCred.user.updateProfile({ displayName: name })
          .then(() => db.ref(`users/${uCred.user.uid}`).set({ displayName: name, email: email, verified: uCred.user.emailVerified, theme: 'light' }))
          .then(() => uCred.user.sendEmailVerification(actionCodeSettings))
      )
      .then(() => kcAlert('Verification email sent! Check your inbox.'))
      .catch(err => kcAlert(err.message));
  };

  loginForm.onsubmit = (e) =>{
    e.preventDefault();
    const email=loginEmail.value.trim(), pass=loginPass.value;
    if(!email||!pass) return kcAlert('Fill both fields.');
    auth.signInWithEmailAndPassword(email,pass)
      .then(uCred => {
        if (!uCred.user.emailVerified) {
          return auth.signOut().then(()=>{ throw new Error('Please verify your email before logging in.'); });
        }
      })
      .catch(err => kcAlert(err.message));
  };

  logoutBtn.onclick = ()=> auth.signOut();

  gradEls.forEach(el=>{
    el.onclick = ()=>{
      gradEls.forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      selectedGradient = el.dataset.grad;
      gradientPickerBtn.style.background = selectedGradient;
      gradientPicker.classList.add('hidden');
      validatePost();
    };
  });

  messageInput.oninput = validatePost;
  function validatePost(){
    const hasDiamond = currentUserProfile?.codesUnlocked?.diamond;
    postBtn.disabled = !( auth.currentUser && auth.currentUser.emailVerified && (hasDiamond || selectedGradient) && messageInput.value.trim() );
  }

  const avatarCache = {};
  const userNameCache = {};
  function getUserName(uid) {
    if (userNameCache[uid]) return Promise.resolve(userNameCache[uid]);
    return db.ref(`users/${uid}/displayName`).once('value').then(snap => {
      const name = snap.val() || 'Anonymous';
      userNameCache[uid] = name;
      return name;
    });
  }
  function getAvatar(uid){
    if(avatarCache[uid]) return Promise.resolve(avatarCache[uid]);
    return db.ref(`users/${uid}/avatar`).once('value').then(snap=>{
      const url = snap.val() || 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
      avatarCache[uid] = url;
      return url;
    });
  }

  function showUserPopup(uid) {
    loadUserProfile(uid);
    document.getElementById('userPopup').classList.remove('hidden');
    document.getElementById('userPopup').classList.add('flex');
  }

  function loadUserProfile(uid) {
    const popupCard = document.getElementById('userPopupCard');
    const bannerEl = document.getElementById('popupBanner');
    const avatarEl = document.getElementById('popupAvatar');
    const usernameEl = document.getElementById('popupUserName');
    const aboutEl = document.getElementById('popupAboutMe');
    const badgesContainer = document.getElementById('popupBadges');
    const streakEl = document.getElementById('popupStreak');
    const streakSection = document.getElementById('streakSection');

    // Resetting UI
    popupCard.style.background = '';
    popupCard.classList.remove('glass');
    popupCard.classList.add('bg-white/10'); // Default translucent background
    bannerEl.style.backgroundImage = 'none';
    bannerEl.style.backgroundColor = '#6b7280';
    avatarEl.src = 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
    usernameEl.textContent = 'Loading...';
    aboutEl.textContent = 'Loading...';
    badgesContainer.innerHTML = 'Loading...';
    streakSection.classList.add('hidden');

    db.ref(`users/${uid}`).once('value').then(snap => {
      const userData = snap.val() || {};
      usernameEl.textContent = userData.displayName || 'Anonymous User';
      avatarEl.src = userData.avatar || 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
      aboutEl.textContent = userData.aboutMe || 'No "About Me" has been set.';

      if (userData.loginStreak > 0) {
        streakEl.textContent = `🔥 ${userData.loginStreak} Day Streak`;
        streakSection.classList.remove('hidden');
      }

      const custom = userData.profileCustomization || {};
      const cardBg = custom.gradient || 'bg-white/10';
      popupCard.classList.add('glass');
      popupCard.classList.remove('bg-white/10');
      popupCard.style.background = cardBg;

      // To show a banner, the 'banner' property must exist in the database, e.g.,
      // db.ref(`users/${uid}/profileCustomization/banner`).set('https://url-to-your-image.png');
      if (custom.banner) {
          bannerEl.style.backgroundImage = `url('${custom.banner}')`;
          bannerEl.style.backgroundColor = 'transparent'; // Use transparent if a banner image is set
      }

      const codes = userData.codesUnlocked || {};
      if (codes.diamond) {
          usernameEl.classList.add('member-diamond');
          usernameEl.dataset.memberType = 'diamond';
      } else if (codes.emerald) {
          usernameEl.classList.add('member-emerald');
          usernameEl.dataset.memberType = 'emerald';
      } else {
          usernameEl.classList.remove('member-diamond', 'member-emerald');
          usernameEl.dataset.memberType = '';
          usernameEl.style.color = '#fff';
      }

      Promise.all([
          db.ref(`badges/${uid}`).once('value'),
          db.ref(`users/${uid}/customBadges`).once('value')
      ]).then(([bsnap, csnap]) => {
          badgesContainer.innerHTML = '';
          let hasAnyBadge = false;
          const badgeSpecs = {
              verified: { label: 'Verified', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/verified.png', bg: 'linear-gradient(45deg, #2dd4bf, #1a9a8a)' },
              offence: { label: 'Best Offence', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/red.png', bg: 'linear-gradient(45deg, #ff6b6b, #d9480f)' },
              defence: { label: 'Best Defence', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png', bg: 'linear-gradient(45deg, #74c0fc, #364fc7)' },
              overall: { label: 'Overall Winner', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png', bg: 'linear-gradient(45deg, #f9c74f, #f08c00)' }
          };
          const addBadge = (spec, text) => {
            hasAnyBadge = true;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 rounded-lg text-white font-medium glass';
            div.style.background = spec.bg;
            div.innerHTML = `<img src="${spec.icon}" class="w-5 h-5"><span>${text}</span>`;
            badgesContainer.appendChild(div);
          };
          if (userData.verified) addBadge(badgeSpecs.verified, 'Verified');
          const baseBadges = bsnap.val() || {};
          ['offence', 'defence', 'overall'].forEach(key => {
              if (baseBadges[key] > 0) addBadge(badgeSpecs[key], `${badgeSpecs[key].label} x${baseBadges[key]}`);
          });
          const customBadges = csnap.val() || {};
          Object.values(customBadges).forEach(badge => {
              hasAnyBadge = true;
              const div = document.createElement('div');
              div.className = 'flex items-center gap-2 p-2 rounded-lg text-white font-medium glass';
              div.style.background = badge.grad1 || '#495057';
              div.innerHTML = `<span class="text-xl">${badge.icon}</span><span>${badge.name}</span>`;
              badgesContainer.appendChild(div);
          });
          if (!hasAnyBadge) badgesContainer.textContent = 'No badges to display.';
      });
    });
  }

  function renderMessage(msgData, isReply = false) {
    const u = auth.currentUser;
    const d = new Date(msgData.time);
    const ts = `${d.toLocaleDateString()} at ${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    
    const hasReplies = msgData.replies && Object.keys(msgData.replies).length > 0;
    const repliesCount = hasReplies ? Object.keys(msgData.replies).length : 0;
    
    const li = document.createElement('li');
    li.className = `flex gap-4 items-start ${isReply ? 'ml-8' : 'border-b border-white/20 pb-4'}`;
    li.dataset.path = msgData.path;
    li.dataset.key = msgData.key;
    
    li.innerHTML = `
      <img class="w-10 h-10 rounded-full object-cover cursor-pointer flex-shrink-0" data-uid="${msgData.uid}">
      <div class="flex-1 min-w-0">
        <div class="flex items-center justify-between mb-1">
          <div class="flex items-center gap-2">
            <span class="username font-semibold cursor-pointer text-base" data-uid="${msgData.uid}">${msgData.user}</span>
            <span class="text-xs text-white/50">${ts}</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="likeBtn text-white/50 hover:text-red-400 transition-all text-lg" title="Like">❤️ <span>${msgData.likes || 0}</span></button>
            <button class="replyBtn text-white/50 hover:text-blue-400 transition-all text-lg" title="Reply">↩️</button>
            ${u && u.uid === msgData.uid ? '<button class="deleteBtn text-white/50 hover:text-red-600 transition-all text-lg" title="Delete">🗑️</button>' : ''}
          </div>
        </div>
        <p class="message-text text-white text-opacity-90 leading-relaxed mb-2">${msgData.text}</p>
        <div class="flex flex-wrap items-center gap-2">
          <div class="reactions flex flex-wrap gap-2"></div>
        </div>
        <div class="flex items-center gap-2 mt-2">
          ${hasReplies ? `<button class="reply-toggle-btn text-white/50 hover:text-white transition-colors"><span class="icon">▼</span> ${repliesCount} repl${repliesCount > 1 ? 'ies' : 'y'}</button>` : ''}
        </div>
        <div class="replies hidden mt-4 space-y-4"></div>
        <div class="reply-form-container mt-4"></div>
      </div>`;

    if (msgData.uid) getAvatar(msgData.uid).then(url => li.querySelector('img').src = url);

    const nm = li.querySelector('.username');
    if (msgData.diamondProfile && msgData.diamondProfile.nameColor) {
        nm.style.color = msgData.diamondProfile.nameColor;
        nm.style.backgroundImage = 'none';
    } else if (msgData.gradient) {
        nm.style.backgroundImage = msgData.gradient;
        nm.style.webkitBackgroundClip = 'text';
        nm.style.backgroundClip = 'text';
        nm.style.color = 'transparent';
    } else {
        nm.style.color = 'white';
        nm.style.backgroundImage = 'none';
    }
    
    const reactionsContainer = li.querySelector('.reactions');
    if (msgData.reactions) {
        Object.entries(msgData.reactions).forEach(([emo, reactors]) => {
            const reactorUIDs = Object.keys(reactors);
            const btn = document.createElement('button');
            // Fix for pointer-events: The reaction button must be clickable and hoverable
            btn.className = `reactBtn flex items-center gap-1 px-2 py-1 rounded-full text-sm glass-dark transition-all hover:scale-105 active:scale-95`;
            btn.dataset.emo = emo;
            if (u && reactorUIDs.includes(u.uid)) {
                btn.classList.add('bg-white/20');
            }
            btn.innerHTML = `${emo} <span>${reactorUIDs.length}</span>`;
            reactionsContainer.appendChild(btn);
        });
    }
    const addBtn = document.createElement('button');
    addBtn.className = `addBtn flex items-center justify-center w-8 h-8 rounded-full text-lg glass-dark transition-all hover:scale-110 active:scale-95`;
    addBtn.innerHTML = '➕';
    addBtn.title = 'Add Reaction';
    reactionsContainer.appendChild(addBtn);

    if (u && msgData.likedBy && msgData.likedBy[u.uid]) {
        li.querySelector('.likeBtn').classList.add('text-red-400');
    }

    if (msgData.replies) {
        const repliesContainer = li.querySelector('.replies');
        Object.entries(msgData.replies).forEach(([key, replyData]) => {
            replyData.key = key;
            replyData.path = `${msgData.path}/replies/${key}`;
            repliesContainer.appendChild(renderMessage(replyData, true));
        });
    }
    return li;
  }

  function render() {
    if(!lastSnap) return;
    msgList.innerHTML = '';
    let arr = [];
    lastSnap.forEach(c => {
      const v = c.val(); 
      v.key = c.key;
      v.path = `messages/${c.key}`;
      arr.push(v); 
    });
    if(sortMode==='liked') arr.sort((a,b)=>(b.likes||0)-(a.likes||0));
    else arr.sort((a,b)=>b.time - a.time);
    if(!arr.length){
      msgList.innerHTML = '<li class="italic opacity-70">No messages yet.</li>';
      return;
    }
    arr.forEach(msgData => {
      if(containsBadWord(msgData.user)||containsBadWord(msgData.text)) return;
      msgList.appendChild(renderMessage(msgData));
    });
  }

  // Event Listeners (using delegation)
  msgList.addEventListener('click', e => {
    const u = auth.currentUser;
    const target = e.target;
    
    // Check if user is logged in for interactions
    if (!u || !u.emailVerified) {
        const allowed = ['img', '.username'];
        if (!allowed.some(selector => target.closest(selector))) {
            return kcAlert('Log in and verify your email to interact.');
        }
    }

    const messageLi = target.closest('[data-path]');
    if (!messageLi) return;

    const path = messageLi.dataset.path;

    if (target.closest('img, .username')) {
      const uid = target.closest('[data-uid]').dataset.uid;
      showUserPopup(uid);
    } else if (target.closest('.likeBtn')) {
      db.ref(`${path}/likedBy/${u.uid}`).transaction(current => current ? null : true);
      db.ref(`${path}/likes`).transaction(current => {
        const liked = messageLi.querySelector('.likeBtn').classList.contains('text-red-400');
        return (current || 0) + (liked ? -1 : 1);
      });
    } else if (target.closest('.reactBtn')) {
      const emo = target.closest('.reactBtn').dataset.emo;
      db.ref(`${path}/reactions/${emo}/${u.uid}`).transaction(current => current ? null : true);
    } else if (target.closest('.addBtn')) {
        const addBtn = target.closest('.addBtn');
        const existingPicker = document.querySelector('.reaction-picker-popover');
        if (existingPicker) existingPicker.remove();

        const pickerPopover = document.createElement('div');
        pickerPopover.className = 'popover reaction-picker-popover absolute z-50';
        pickerPopover.style.display = 'block';
        
        const emojiGrid = document.createElement('div');
        emojiGrid.className = 'grid grid-cols-6 gap-2';
        
        const availableEmojis = ['😀','😎','😂','😍','👍','🙌','😉','😁','😢','😮','😡','🎉','🤣','😭','🥹','🥰','👀','🫶','🔥','🙏'];
        
        availableEmojis.forEach(emo => {
            const emojiSpan = document.createElement('span');
            emojiSpan.className = 'text-2xl p-2 rounded-lg cursor-pointer transition-all hover:scale-110 hover:bg-white/20';
            emojiSpan.textContent = emo;
            emojiSpan.onclick = (event) => {
                event.stopPropagation();
                db.ref(`${path}/reactions/${emo}/${u.uid}`).set(true);
                pickerPopover.remove();
            };
            emojiGrid.appendChild(emojiSpan);
        });

        pickerPopover.appendChild(emojiGrid);
        document.body.appendChild(pickerPopover);

        const btnRect = addBtn.getBoundingClientRect();
        pickerPopover.style.left = `${btnRect.left}px`;
        pickerPopover.style.top = `${btnRect.bottom + window.scrollY + 10}px`;

        const closePicker = (event) => {
            if (!pickerPopover.contains(event.target) && event.target !== addBtn) {
                pickerPopover.remove();
                document.removeEventListener('click', closePicker, true);
            }
        };
        setTimeout(() => document.addEventListener('click', closePicker, true), 0);
    } else if (target.closest('.replyBtn')) {
        const replyContainer = messageLi.querySelector('.reply-form-container');
        if (replyContainer.innerHTML !== '') {
            replyContainer.innerHTML = '';
        } else {
            const form = document.createElement('div');
            form.className = 'flex flex-col gap-2 p-3 rounded-xl glass-dark';
            form.innerHTML = `
              <div class="flex gap-2">
                <input type="text" placeholder="Write a reply..." class="flex-1 p-2 rounded-lg bg-white/10 text-white placeholder-gray-300 focus:outline-none"/>
                <button class="px-4 py-2 rounded-lg text-white font-semibold brand-gradient transition-all hover:scale-105 active:scale-95">Reply</button>
              </div>
              <div class="suggested-replies-container flex items-center gap-2">
                <button class="suggest-reply-btn px-3 py-1 rounded-full text-sm text-white glass-dark hover:scale-105">✨ Suggest Replies</button>
                <div class="suggested-replies flex flex-wrap gap-2"></div>
              </div>
            `;
            replyContainer.appendChild(form);
            const replyInput = form.querySelector('input');
            replyInput.focus();

            form.querySelector('.suggest-reply-btn').onclick = async () => {
                const parentMessageText = messageLi.querySelector('.message-text').textContent;
                const prompt = `Based on this message: "${parentMessageText}", suggest three short, distinct, and relevant replies.`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        "replies": {
                            "type": "ARRAY",
                            "items": { "type": "STRING" }
                        }
                    }
                };
                const result = await callGemini(prompt, schema);
                if (result) {
                    try {
                        const parsed = JSON.parse(result);
                        const suggestionsContainer = form.querySelector('.suggested-replies');
                        suggestionsContainer.innerHTML = '';
                        parsed.replies.slice(0, 3).forEach(suggestion => {
                            const btn = document.createElement('button');
                            btn.className = 'px-3 py-1 rounded-full text-xs text-white glass-dark hover:scale-105';
                            btn.textContent = suggestion;
                            btn.onclick = () => {
                                replyInput.value = suggestion;
                                replyInput.focus();
                            };
                            suggestionsContainer.appendChild(btn);
                        });
                    } catch (e) { console.error("Failed to parse suggestions:", e); }
                }
            };
            
            form.querySelector('button').onclick = () => {
                const text = replyInput.value.trim();
                if (!text) return;
                let replyData = { user: u.displayName, uid: u.uid, text: text, time: firebase.database.ServerValue.TIMESTAMP };
                const hasDiamond = currentUserProfile?.codesUnlocked?.diamond;
                if (hasDiamond && currentUserProfile.profileCustomization) {
                    replyData.diamondProfile = currentUserProfile.profileCustomization;
                } else {
                    replyData.gradient = selectedGradient || 'linear-gradient(45deg,#74c0fc,#4dabf7)';
                }
                db.ref(`${path}/replies`).push(replyData);
                replyContainer.innerHTML = '';
            };
        }
    } else if (target.closest('.deleteBtn')) {
      kcConfirm('Delete this message and all its replies?', confirmed => {
        if (confirmed) db.ref(path).remove();
      });
    } else if (target.closest('.reply-toggle-btn')) {
        const repliesContainer = messageLi.querySelector('.replies');
        const icon = target.closest('.reply-toggle-btn').querySelector('.icon');
        const isHidden = repliesContainer.classList.contains('hidden');
        if (isHidden) {
            repliesContainer.classList.remove('hidden');
            icon.textContent = '▲';
        } else {
            repliesContainer.classList.add('hidden');
            icon.textContent = '▼';
        }
    }
  });

  // Re-factored mouseover/mouseout listeners for reaction tooltip to be more reliable
  let tooltipTimeout;

  msgList.addEventListener('mouseover', e => {
    const reactBtn = e.target.closest('.reactBtn');
    if (!reactBtn) { 
        return; 
    }
    
    // Clear any existing timeout to prevent the tooltip from being hidden
    clearTimeout(tooltipTimeout);

    const path = reactBtn.closest('[data-path]').dataset.path + '/reactions/' + reactBtn.dataset.emo;
    const rect = reactBtn.getBoundingClientRect();
    
    // Show and position the tooltip
    reactionTooltip.classList.remove('hidden');
    reactionTooltip.style.left = `${rect.left + rect.width / 2}px`;
    reactionTooltip.style.top = `${rect.top}px`;
    reactionTooltip.style.transform = 'translate(-50%, -110%)';
    reactionTooltip.textContent = 'Loading...';
    
    // Fetch user names for the tooltip
    db.ref(path).once('value').then(snap => {
      const reactors = snap.val();
      if (!reactors) { reactionTooltip.textContent = 'No one yet!'; return; }
      const uids = Object.keys(reactors);
      Promise.all(uids.map(uid => getUserName(uid))).then(names => {
        reactionTooltip.textContent = `Reacted by:\n${names.join(', ')}`;
      });
    });
  });
  
  msgList.addEventListener('mouseout', e => {
    const reactBtn = e.target.closest('.reactBtn');
    // If we're leaving a reaction button, start a timer to hide the tooltip
    if (reactBtn) {
        tooltipTimeout = setTimeout(() => {
            reactionTooltip.classList.add('hidden');
        }, 100); // Small delay to allow for cursor movement
    }
  });

  magicComposeBtn.onclick = async () => {
    const currentText = messageInput.value.trim();
    if (!currentText) return kcAlert("Please write a short idea to expand upon.");
    const prompt = `Expand this short message into a friendly and engaging comment for a message board. Keep it concise (1-2 sentences): "${currentText}"`;
    const schema = {
        type: "STRING"
    };
    const result = await callGemini(prompt, schema);
    if (result) {
        messageInput.value = result.replace(/"/g, ''); // Remove quotes from response
    }
  };

  postBtn.onclick = ()=>{
    let u=auth.currentUser, txt=messageInput.value.trim();
    if(!u || !u.emailVerified) return kcAlert('Log in and verify to post.');
    if(!txt) return kcAlert('Enter a message.');
    if(containsBadWord(txt)||containsBadWord(u.displayName)) return kcAlert('That word’s not allowed.');
    
    let messageData = { user: u.displayName, uid: u.uid, text: txt, time: firebase.database.ServerValue.TIMESTAMP, likes: 0 };
    const hasDiamond = currentUserProfile?.codesUnlocked?.diamond;
    if (hasDiamond && currentUserProfile.profileCustomization) {
        messageData.diamondProfile = currentUserProfile.profileCustomization;
    } else {
        if(!selectedGradient) return kcAlert('Pick a gradient.');
        messageData.gradient = selectedGradient;
    }
    msgs.push(messageData);
    messageInput.value='';
    validatePost();
  };

  msgs.on('value',snap=>{ lastSnap=snap; render(); });
  sortSelect.onchange = ()=>{ sortMode=sortSelect.value; render(); };

  auth.onAuthStateChanged(u => {
    if (u) {
      db.ref(`users/${u.uid}`).on('value', snap => {
        currentUserProfile = snap.val() || {};
        
        applyTheme(currentUserProfile.theme || 'light');

        const hasDiamond = currentUserProfile?.codesUnlocked?.diamond;
        loginBar.classList.add('hidden');
        composerContainer.classList.remove('hidden');
        // Correctly toggle the hidden class based on the diamond status
        gradientPickerBtn.classList.toggle('hidden', !!hasDiamond);

        // Update button active state
        showLoginBtn.querySelector('span').classList.add('scale-x-100', 'opacity-100');
        showRegisterBtn.querySelector('span').classList.remove('scale-x-100', 'opacity-100');
        
        if (!u.emailVerified) return;
        validatePost();
      });
    } else {
      currentUserProfile = null; 
      applyTheme('light');
      loginBar.classList.remove('hidden');
      composerContainer.classList.add('hidden');
      // Ensure the button is visible for non-logged-in users if needed
      gradientPickerBtn.classList.remove('hidden');
      validatePost();
    }
  });

  document.getElementById('closeUserPopup').addEventListener('click', () => {
    document.getElementById('userPopup').classList.add('hidden');
  });
  
  const usernameEl = document.getElementById('popupUserName');
  const membershipTooltip = document.getElementById('membershipTooltip');
  usernameEl.addEventListener('mouseenter', () => {
    const memberType = usernameEl.dataset.memberType;
    if (!memberType) return;
    let icon = '', text = '';
    if (memberType === 'diamond') {
        icon = 'https://cdn.discordapp.com/emojis/1381097369474695178.webp?size=128';
        text = 'Diamond Member';
    } else if (memberType === 'emerald') {
        icon = 'https://cdn.discordapp.com/emojis/1381097372930543776.webp?size=128';
        text = 'Emerald Member';
    } else { return; }
    membershipTooltip.innerHTML = `<img src="${icon}" alt="${text} icon" class="w-6 h-6"><span>${text}</span>`;
    const nameRect = usernameEl.getBoundingClientRect();
    const cardRect = document.getElementById('userPopupCard').getBoundingClientRect();
    membershipTooltip.style.top = `${nameRect.top - cardRect.top - membershipTooltip.offsetHeight - 8}px`;
    membershipTooltip.style.left = `${nameRect.left - cardRect.left + (nameRect.width / 2) - (membershipTooltip.offsetWidth / 2)}px`;
    membershipTooltip.classList.remove('hidden');
  });
  usernameEl.addEventListener('mouseleave', () => {
      membershipTooltip.classList.add('hidden');
  });
  
  </script>
</body>
</html>
