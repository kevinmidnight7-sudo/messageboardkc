<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>KC Event Board w/ Discord UI</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    /* === Global & Left Panel Styles === */
    body {
      margin: 0; padding: 0;
      width: 100vw; height: 100vh;
      font-family: 'Poppins', sans-serif;
      color: #21242c;
      background:transparent;
    }
    #msgBoard {
      display: flex;
      flex-direction: row;
      gap: 2.4rem;
      justify-content: center;
      align-items: flex-start;
      padding: 2.5rem 0;
      width: 100vw;
      min-height: 90vh;
    }
    #authContainer, #messageContainer {
      background: rgba(255,255,255,0.68);
      border-radius: 22px;
      box-shadow: 0 8px 48px #b2b9cf34, 0 1.5px 8px #8492b21a;
      backdrop-filter: blur(20px) brightness(1.10);
      -webkit-backdrop-filter: blur(20px) brightness(1.10);
      margin: 0 0.8rem;
      transition: box-shadow 0.16s;
    }
    #authContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 320px;
      max-width: 350px;
      padding: 1.7rem 1.3rem 1.2rem 1.3rem;
      text-align: center;
      box-sizing: border-box;
    }
    .auth-card {
      width: 100%;
      background: rgba(255,255,255,0.42);
      border-radius: 18px;
      box-shadow: 0 2px 16px #bdc9dd2c;
      margin: 0.8em 0;
      padding: 1.1rem 0.7rem 1.0rem 0.7rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #authContainer h2 {
      margin: 0 0 1.3rem 0;
      font-size: 1.55rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #2d3444;
    }
    #emojiPicker p, #gradientPicker p {
      margin: 0 0 1.0em 0;
      font-weight: 600;
      font-size: 1.09em;
      color: #25304c;
      letter-spacing: 0.01em;
      text-align: center;
    }
    #emojiPicker .emoji-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: .50rem .60rem;
      justify-items: center;
      margin-top: 0.2em;
    }
    #emojiPicker .emoji {
      font-size: 1.85rem;
      width: 46px; height: 46px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 11px;
      background: #fff;
      box-shadow: 0 2px 12px #b3bbe933;
      border: 2.5px solid transparent;
      cursor: pointer;
      margin: 0;
      transition: box-shadow .15s, transform .13s, background .13s;
    }
    #emojiPicker .emoji.selected {
      box-shadow: 0 6px 18px #7bd7fd67;
      background: #e3f5ff;
      border: 2.5px solid #64c2fc;
      transform: scale(1.09);
    }
    #emojiPicker .emoji:hover:not(.selected) {
      background: #f2faff;
      box-shadow: 0 6px 24px #b4e6fd53;
      transform: scale(1.05);
    }
    #gradientPicker .grad-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: .8rem 1.1rem;
      justify-items: center;
      margin-top: 0.2em;
      max-height: 170px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    #gradientPicker .grad {
      width: 44px; height: 44px;
      border-radius: 11px;
      box-shadow: 0 2px 11px #c8e0f87c;
      border: 2.5px solid transparent;
      cursor: pointer;
      margin: 0;
      transition: box-shadow .15s, transform .13s;
    }
    #gradientPicker .grad.selected {
      box-shadow: 0 4px 17px #65efc177;
      border: 2.5px solid #64c2fc;
      transform: scale(1.09);
    }
    #gradientPicker .grad:hover:not(.selected) {
      box-shadow: 0 8px 22px #e1fadc55;
      transform: scale(1.05);
    }
    #messageInput {
      width: 100%;
      border-radius: 12px;
      background: #f5f8fc;
      border: none;
      box-shadow: 0 2px 7px #e2eefb33;
      padding: 0.95em 1.1em;
      font-size: 1.07em;
      margin-bottom: 0.8em;
      margin-top: 0.4em;
      min-height: 2.7em;
      transition: box-shadow .12s, background .12s;
      resize: vertical;
    }
    #messageInput:focus {
      background: #eaf5ff;
      box-shadow: 0 3px 12px #aed8ff33;
    }
    #postBtn {
      width: 100%;
      background: linear-gradient(90deg,#1ee57c,#50b2fa);
      color: #fff;
      border: none;
      border-radius: 11px;
      padding: .8em 1.3em;
      font-size: 1.09em;
      font-weight: 700;
      box-shadow: 0 2px 8px #b6efe244;
      transition: background .13s, box-shadow .13s, transform .13s;
      cursor: pointer;
      margin-bottom: .9em;
      margin-top: -.5em;
      letter-spacing: .01em;
    }
    #postBtn:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }
    #postBtn:hover:not(:disabled) {
      background: linear-gradient(90deg,#19df7e,#30a9f8);
      box-shadow: 0 4px 16px #8adfdc55;
      transform: translateY(-2px) scale(1.03);
    }
    #logoutBtn {
      background: #ff4957;
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      padding: .7em 1.7em;
      font-size: 1.07em;
      margin-top: 1.2em;
      box-shadow: 0 2px 8px #faadc033;
      cursor: pointer;
      transition: background .13s, box-shadow .13s, transform .13s;
    }
    #logoutBtn:hover {
      background: #d63141;
      box-shadow: 0 2px 12px #f89ca666;
      transform: translateY(-2px) scale(1.04);
    }
    #registerForm, #loginForm {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(255,255,255,0.28);
      border-radius: 15px;
      box-shadow: 0 2px 15px #b2b8d940;
      padding: 1.2rem 1.2rem 0.9rem 1.2rem;
      margin-bottom: 1.2rem;
      gap: 0.7em;
      width: 100%;
      transition: box-shadow .14s;
    }
    #registerForm input, #loginForm input {
      width: 92%;
      padding: .83em 1.1em;
      border-radius: 10px;
      border: none;
      font-size: 1.07em;
      background: #f7faff;
      margin-bottom: .15em;
      box-shadow: 0 1.5px 7px #e0e7fd40;
      transition: box-shadow .12s, background .13s;
      outline: none;
    }
    #registerForm input:focus, #loginForm input:focus {
      background: #eef6ff;
      box-shadow: 0 2px 13px #d6e4ff40;
    }

    /* --- Message Container --- */
    #messageContainer {
      flex: 2.3;
      min-width: 420px;
      max-width: 920px;
      padding: 2.1rem 1.1rem 2.1rem 1.5rem;
      border-radius: 22px;
      background: rgba(255,255,255,0.69);
      box-shadow: 0 8px 44px #b2b9cf3b, 0 1.5px 8px #8492b21a;
      position: relative;
      overflow-y: auto;
    }
    .avatarImg {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      object-fit: cover;
      cursor: pointer;
    }
    .message {
      align-items: center;
    }
    #sortControls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 0.6rem;
      font-size: 1.07rem;
      color: #57698a;
    }
    #sortControls select {
      margin-left: .3rem;
      padding: 3px 9px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      background: #f3f6fd;
      color: #369aff;
      outline: none;
      transition: box-shadow .14s;
      box-shadow: 0 2px 6px #dee4f599;
    }
    #sortControls select:focus {
      box-shadow: 0 2px 10px #aad8ff50;
    }
    #msgList {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }
    .message, .reply {
      display: flex;
      gap: 0.78rem;
      align-items: flex-start;
      padding: 1.2rem 1.1rem 0.8rem 1.1rem;
      margin-bottom: 1.25rem;
      border-radius: 18px;
      background: rgba(255,255,255,0.93);
      box-shadow: 0 2.5px 18px #dde4f430;
      border: 1.7px solid #e9eefb;
      transition: box-shadow 0.19s, transform .13s;
      position: relative;
    }
    .message:hover {
      box-shadow: 0 12px 36px #8bc2fb44, 0 4px 32px #a6b8d144;
      transform: translateY(-2px) scale(1.016);
      z-index: 2;
    }
    .emojiCell {
      font-size: 1.6em;
      min-width: 2.1em;
      text-align: center;
      align-self: flex-start;
      user-select: none;
    }
    .content {
      flex: 1;
      min-width: 0;
    }
    .username {
      font-weight: 700;
      cursor: pointer;
      font-size: 1.09em;
      transition: text-shadow .11s, color .11s;
      letter-spacing: 0.01em;
    }
    .timestamp {
      display: block;
      font-size: .83rem;
      color: #acb2cc;
      margin-top: 0.2rem;
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: .4rem;
      align-items: flex-end;
      min-width: 75px;
    }
    .likeBtn, .replyBtn, .deleteBtn {
      background: rgba(0,170,140,0.07);
      color: #3da49d;
      border: none;
      border-radius: 9px;
      padding: 7px 17px;
      font-size: 1.04em;
      font-weight: 600;
      cursor: pointer;
      transition: background .12s, box-shadow .11s, transform .11s;
      box-shadow: 0 1px 6px #d6f6e915;
      display: flex; align-items: center; gap: .4em;
      outline: none;
    }
    .likeBtn { color: #ff416c; background: rgba(255,65,108,0.08); }
    .replyBtn { color: #1f9fff; background: rgba(65,108,255,0.07);} 
    .deleteBtn { color: #ff3d4a; background: rgba(255,0,0,0.05);} 
    .likeBtn:hover, .replyBtn:hover, .deleteBtn:hover {
      background: #f7fafc;
      box-shadow: 0 2px 10px #e7ebfb44;
      transform: translateY(-2px) scale(1.06);
    }
    .reactions {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: .5rem;
    }
    .reactBtn, .addBtn {
      display: flex; align-items: center; gap: .22rem;
      background: #f5f8fd;
      border-radius: 7px;
      padding: 5px 13px;
      font-size: .97rem;
      font-weight: 500;
      cursor: pointer;
      transition: background .13s, box-shadow .13s, transform .13s;
      border: none;
      outline: none;
    }
    .reactBtn:hover, .addBtn:hover {
      background: #e4f2ff;
      box-shadow: 0 1px 7px #e6f5ff90;
      transform: scale(1.05);
    }
    .addBtn {
      background: #f2f7fa;
      color: #8d8aa7;
      font-weight: 600;
    }
    .addBtn:active {
      background: #d5eafd;
      color: #38a1db;
    }
    .reply-row {
      width: 94%; margin: .8rem auto 0.5rem auto;
      display: flex; align-items: center; justify-content: flex-start;
    }
    .reply-form {
      background: rgba(255,255,255,0.72);
      border-radius: 13px;
      box-shadow: 0 3px 13px #c9d9f320;
      padding: .7rem 1.1rem;
      display: flex; align-items: center; gap: 0.6rem;
      width: 100%;
    }
    .reply-form input[type="text"], .reply-form input[type="text"]:focus {
      border: none;
      border-radius: 8px;
      background: #f5f7fa;
      font-size: 1.08em;
      padding: .68em .98em;
      outline: none;
      margin-right: .5em;
      box-shadow: 0 2px 7px #e2eefb25;
      transition: box-shadow .11s, background .11s;
      width: 65%;
    }
    .reply-form input[type="text"]:focus {
      background: #e8f2fe;
      box-shadow: 0 2px 13px #d6e4ff55;
    }
    .reply-form button {
      background: linear-gradient(90deg,#1ee57c,#50b2fa);
      color: #fff;
      font-weight: 700;
      border: none;
      border-radius: 8px;
      padding: .6em 1.3em;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 7px #e2f8eb99;
      transition: background .13s, box-shadow .13s, transform .13s;
    }
    .reply-form button:hover {
      background: linear-gradient(90deg,#19df7e,#30a9f8);
      box-shadow: 0 4px 18px #8adfdc55;
      transform: translateY(-2px) scale(1.05);
    }
    .replies {
      list-style: none;
      padding: 0 0 0 1.7em;
      margin: 0;
    }
    .toggleReplies {
      margin-top: .7rem;
      background: none;
      border: none;
      color: #18bfae;
      font-weight: 600;
      cursor: pointer;
      font-size: 1.01em;
      transition: color .13s;
    }
    .toggleReplies:hover { color: #1c81fc; }

    /* === RESPONSIVE === */
    @media (max-width: 1000px) {
      #msgBoard {
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
        padding: 1.2rem 0;
      }
      #authContainer, #messageContainer {
        max-width: 97vw;
        min-width: 0;
      }
    }
    @media (max-width: 700px) {
      #msgBoard { padding: 0.5rem 0.3rem; }
      #authContainer { padding: 1.2rem 0.6rem 1rem 0.6rem; }
      #messageContainer { padding: 1.1rem 0.3rem; }
      .message, .reply { padding: 0.85rem 0.5rem; }
      #gradientPicker .grad-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* === ALERT MODAL === */
    #alertModal {
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,0.45);
      align-items:center; justify-content:center; z-index:1000;
    }
    #alertContent {
      background:#fff; color:#233046; padding:1.5rem 1rem 1.2rem 1rem;
      border-radius:18px; text-align:center;
      box-shadow: 0 3px 34px #c9defb65;
      max-width: 320px; width:90%;
      font-size: 1.13em;
    }
    #alertContent button {
      margin-top:.6rem; padding:.7rem 1.7rem;
      background: linear-gradient(90deg,#1ee57c,#50b2fa);
      border:none; color:#fff; border-radius:10px;
      cursor:pointer; font-size: 1.07em;
      box-shadow: 0 2px 8px #98f0e045;
      font-weight: 700;
      transition: background .12s, box-shadow .13s;
    }
    #alertContent button:hover {
      background: linear-gradient(90deg,#19df7e,#30a9f8);
      box-shadow: 0 2px 18px #8adfdc44;
    }

    /* ===== NEW DISCORD-INSPIRED USER POPUP STYLES ===== */
    #userPopup {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      font-family: 'Poppins', sans-serif;
      animation: fadeInBg 0.3s ease;
    }
    @keyframes fadeInBg { from { opacity: 0; } to { opacity: 1; } }

    .user-popup-card {
      width: 360px;
      max-width: 95vw;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: zoomIn 0.3s cubic-bezier(0.25, 1, 0.5, 1);
      position: relative;
      background: #f1f3f5; /* Default background */
    }
    @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .popup-banner {
      height: 120px;
      background-color: #ced4da; /* Default banner color */
      background-size: cover;
      background-position: center;
    }

    .popup-header {
      padding: 0 16px;
      position: relative;
      height: 48px;
    }

    .popup-avatar {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      object-fit: cover;
      position: absolute;
      top: -48px; /* Pulls it up to overlap the banner */
      left: 16px;
      border: 6px solid; /* Border color will be set by JS to match card bg */
      background-color: #f1f3f5; /* Prevents transparent parts of avatar showing banner */
    }

    .popup-body {
      padding: 12px 16px 16px;
      margin-top: 48px; /* Space for the avatar */
    }

    .popup-username {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      text-align: left;
      margin-bottom: 16px;
      position: relative;
    }

    .popup-section {
      background: rgba(255,255,255,0.5);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .popup-section:last-child {
      margin-bottom: 0;
    }

    .popup-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0 0 8px 0;
      text-align: left;
    }

    .popup-about-me {
      font-size: 0.95rem;
      color: #374151;
      line-height: 1.5;
      word-break: break-word;
      text-align: left;
      white-space: pre-wrap; /* Respects newlines */
    }

    .popup-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .popup-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      color: white;
      background: #6b7280; /* Default badge color */
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .popup-badge:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .popup-badge img, .popup-badge .emoji-icon {
      width: 20px;
      height: 20px;
      font-size: 1.2rem;
    }
    /* Keyframes for random animations */
    @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }


    .user-streak {
      font-size: 1rem;
      font-weight: 600;
      color: #d9480f;
    }

    .popup-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0,0,0,0.3);
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 5;
    }
    .popup-close-btn:hover {
      background: rgba(0,0,0,0.5);
    }

    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      color: #ffffff;
      font-size: 1.6rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 2;
    }
    .nav-arrow:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    .prev-arrow { left: 10px; }
    .next-arrow { right: 10px; }

    /* Membership Tooltip Styles */
    .membership-tooltip {
        position: absolute;
        visibility: hidden; /* Start hidden */
        display: flex;
        align-items: center;
        gap: 8px;
        background: #111827;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        z-index: 10;
        opacity: 0;
        transform: translateY(10px) scale(0.95);
        transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        pointer-events: none;
        white-space: nowrap;
    }
    .membership-tooltip.visible {
        visibility: visible;
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    .membership-tooltip img {
        width: 24px;
        height: 24px;
    }

  </style>
</head>
<body>
<!-- Alert modal -->
<div id="alertModal" style="display:none;">
  <div id="alertContent">
    <strong>Notification</strong>
    <p id="alertMsg"></p>
    <div id="alertBtnRow">
      <button id="alertCancel" style="display:none;">Cancel</button>
      <button id="alertOK">OK</button>
    </div>
  </div>
</div>

  <div id="msgBoard">
    <!-- LEFT PANEL -->
    <div id="authContainer">
      <h2>KC Events Account</h2>
      <div id="registerForm">
        <input id="regName" placeholder="Display Name"/>
        <input id="regEmail" type="email" placeholder="Email"/>
        <input id="regPass" type="password" placeholder="Password"/>
        <button id="registerBtn">Create Account</button>
        <p style="text-align:center;color:#ccc">or <a href="#" id="showLogin" style="color:#4ade80">Log¬†In</a></p>
      </div>
      <div id="loginForm" style="display:none">
        <input id="loginEmail" type="email" placeholder="Email"/>
        <input id="loginPass" type="password" placeholder="Password"/>
        <button id="loginBtn">Log¬†In</button>
        <p style="text-align:center;color:#ccc">or <a href="#" id="showRegister" style="color:#4ade80">Create¬†Account</a></p>
      </div>
      <div class="auth-card">
        <div id="emojiPicker"><p>Pick an emoji!</p><div class="emoji-grid">
            <span class="emoji" data-emoji="üòÄ">üòÄ</span><span class="emoji" data-emoji="üòé">üòé</span><span class="emoji" data-emoji="üòÇ">üòÇ</span><span class="emoji" data-emoji="üòç">üòç</span><span class="emoji" data-emoji="üëç">üëç</span><span class="emoji" data-emoji="üôå">üôå</span><span class="emoji" data-emoji="üòâ">üòâ</span><span class="emoji" data-emoji="üòÅ">üòÅ</span><span class="emoji" data-emoji="üò¢">üò¢</span><span class="emoji" data-emoji="üòÆ">üòÆ</span><span class="emoji" data-emoji="üò°">üò°</span><span class="emoji" data-emoji="üéâ">üéâ</span><span class="emoji" data-emoji="ü§£">ü§£</span><span class="emoji" data-emoji="üò≠">üò≠</span><span class="emoji" data-emoji="ü•π">ü•π</span><span class="emoji" data-emoji="ü•∞">ü•∞</span><span class="emoji" data-emoji="üëÄ">üëÄ</span><span class="emoji" data-emoji="ü´∂">ü´∂</span><span class="emoji" data-emoji="üî•">üî•</span><span class="emoji" data-emoji="üôè">üôè</span>
        </div></div>
      </div>
      <div class="auth-card">
        <div id="gradientPicker"><p>Pick a gradient!</p><div class="grad-grid">
            <span class="grad" data-grad="linear-gradient(45deg,#ff6b6b,#f06595)" style="background:linear-gradient(45deg,#ff6b6b,#f06595)"></span><span class="grad" data-grad="linear-gradient(45deg,#74c0fc,#4dabf7)" style="background:linear-gradient(45deg,#74c0fc,#4dabf7)"></span><span class="grad" data-grad="linear-gradient(45deg,#51cf66,#2f9e44)" style="background:linear-gradient(45deg,#51cf66,#2f9e44)"></span><span class="grad" data-grad="linear-gradient(45deg,#f9c74f,#f9844a)" style="background:linear-gradient(45deg,#f9c74f,#f9844a)"></span><span class="grad" data-grad="linear-gradient(45deg,#845ef7,#5c7cfa)" style="background:linear-gradient(45deg,#845ef7,#5c7cfa)"></span><span class="grad" data-grad="linear-gradient(45deg,#f857a6,#ff5858)" style="background:linear-gradient(45deg,#f857a6,#ff5858)"></span><span class="grad" data-grad="linear-gradient(45deg,#2dd4bf,#06b6d4)" style="background:linear-gradient(45deg,#2dd4bf,#06b6d4)"></span><span class="grad" data-grad="linear-gradient(45deg,#ee9ca7,#ffdde1)" style="background:linear-gradient(45deg,#ee9ca7,#ffdde1)"></span><span class="grad" data-grad="linear-gradient(45deg,#43cea2,#185a9d)" style="background:linear-gradient(45deg,#43cea2,#185a9d)"></span><span class="grad" data-grad="linear-gradient(45deg,#ffaf7b,#d76d77)" style="background:linear-gradient(45deg,#ffaf7b,#d76d77)"></span><span class="grad" data-grad="linear-gradient(45deg,#ffe53b,#fd3838)" style="background:linear-gradient(45deg,#ffe53b,#fd3838)"></span><span class="grad" data-grad="linear-gradient(45deg,#7f53ac,#657ced)" style="background:linear-gradient(45deg,#7f53ac,#657ced)"></span>
        </div></div>
      </div>
      <textarea id="messageInput" placeholder="Your message" rows="3"></textarea>
      <button id="postBtn" disabled>Send</button>
      <button id="logoutBtn" style="display:none">Sign¬†Out</button>
    </div>
    <!-- RIGHT PANEL -->
    <div id="messageContainer">
      <div id="sortControls">
        Sort by:
        <select id="sortSelect">
          <option value="recent">Most Recent</option>
          <option value="liked">Most Liked</option>
        </select>
      </div>
      <ul id="msgList"><li style="font-style:italic; opacity:.7">Loading‚Ä¶</li></ul>
    </div>
  </div>

  <!-- NEW DISCORD-STYLE USER PROFILE OVERLAY -->
  <div id="userPopup">
    <button class="nav-arrow prev-arrow">&#8249;</button>
    <div class="user-popup-card" id="userPopupCard">
        <div id="membershipTooltip" class="membership-tooltip"></div>
        <div class="popup-banner" id="popupBanner"></div>
        <div class="popup-header">
            <img id="popupAvatar" src="" class="popup-avatar">
            <button id="closeUserPopup" class="popup-close-btn">&times;</button>
        </div>
        <div class="popup-body">
            <div id="popupUserName" class="popup-username"></div>
            <div class="popup-section">
                <h4 class="popup-section-title">ABOUT ME</h4>
                <div id="popupAboutMe" class="popup-about-me"></div>
            </div>
            <div class="popup-section">
                <h4 class="popup-section-title">BADGES</h4>
                <div id="popupBadges" class="popup-badges"></div>
            </div>
             <div class="popup-section">
                <h4 class="popup-section-title">STREAK</h4>
                 <div id="popupStreak" class="user-streak"></div>
            </div>
        </div>
    </div>
    <button class="nav-arrow next-arrow">&#8250;</button>
  </div>

  <script>
  // overlay alert
  const alertModal = document.getElementById('alertModal'),
        alertMsg   = document.getElementById('alertMsg'),
        alertOK    = document.getElementById('alertOK');
  function kcAlert(txt){
    alertMsg.textContent = txt;
    alertModal.style.display = 'flex';
    document.getElementById('alertCancel').style.display = 'none';
    document.getElementById('alertOK').textContent = 'OK';
    let okBtn = document.getElementById('alertOK');
    okBtn.onclick = function() { alertModal.style.display = 'none'; };
  }
  alertOK.onclick = ()=> alertModal.style.display='none';
  function kcConfirm(msg, callback) {
    alertMsg.textContent = msg;
    alertModal.style.display = 'flex';
    document.getElementById('alertCancel').style.display = 'inline-block';
    document.getElementById('alertOK').textContent = 'OK';
    let okBtn = document.getElementById('alertOK');
    let cancelBtn = document.getElementById('alertCancel');
    okBtn.onclick = function() {
      alertModal.style.display = 'none';
      callback(true);
    };
    cancelBtn.onclick = function() {
      alertModal.style.display = 'none';
      callback(false);
    };
  }

  // Firebase init
  const cfg = {
    apiKey: "AIzaSyBHKsULqmWPFaU7bNXDp6pBZHO4p9ZiUUo",
    authDomain: "kckillerscompany-ab1ec.firebaseapp.com",
    databaseURL: "https://kckillerscompany-ab1ec-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kckillerscompany-ab1ec",
    storageBucket: "kckillerscompany-ab1ec.appspot.com",
    messagingSenderId: "198711213988",
    appId: "1:198711213988:web:f3cacc413ac9e80dd8cb31",
    measurementId: "G-4LKP2M3JXE"
  };
  firebase.initializeApp(cfg);
  const auth = firebase.auth(),
        db   = firebase.database(),
        msgs = db.ref('messages');

  const actionCodeSettings = {
    url: window.location.origin + '/?mode=verifyEmail',
    handleCodeInApp: true
  };

  // verify-email link
  window.addEventListener('load', () => {
    const p = new URLSearchParams(window.location.search),
          mode   = p.get('mode'),
          oobCode= p.get('oobCode');
    if (mode==='verifyEmail' && oobCode) {
      auth.applyActionCode(oobCode)
        .then(() => auth.signInWithEmailLink ? auth.signInWithEmailLink(p.get('email')) : null)
        .then(() => auth.currentUser?.reload())
        .then(() => {
          if (auth.currentUser) {
            return db.ref(`users/${auth.currentUser.uid}/verified`).set(true);
          }
        })
        .then(() => kcAlert('Email verified! You can now log in.'))
        .catch(err => kcAlert('Verification error: ' + err.message));
    }
  });

  // profanity filter
  let badWords = [];
  fetch('https://raw.githubusercontent.com/zacanger/profane-words/master/words.json')
    .then(r=>r.json()).then(list=>badWords=list)
    .catch(_=> console.error('Failed loading bad-words.'));
  function containsBadWord(s){
    return badWords.some(w=>new RegExp('\\b'+w+'\\b','i').test(s));
  }

  // UI refs
  const registerForm  = document.getElementById('registerForm'),
        loginForm     = document.getElementById('loginForm'),
        showLogin     = document.getElementById('showLogin'),
        showRegister  = document.getElementById('showRegister'),
        regName       = document.getElementById('regName'),
        regEmail      = document.getElementById('regEmail'),
        regPass       = document.getElementById('regPass'),
        registerBtn   = document.getElementById('registerBtn'),
        loginEmail    = document.getElementById('loginEmail'),
        loginPass     = document.getElementById('loginPass'),
        loginBtn      = document.getElementById('loginBtn'),
        logoutBtn     = document.getElementById('logoutBtn'),
        emojiEls      = Array.from(document.querySelectorAll('.emoji')),
        gradEls       = Array.from(document.querySelectorAll('.grad')),
        messageInput  = document.getElementById('messageInput'),
        postBtn       = document.getElementById('postBtn'),
        sortSelect    = document.getElementById('sortSelect'),
        msgList       = document.getElementById('msgList');

  let selectedEmoji    = null,
      selectedGradient = null,
      lastSnap         = null,
      sortMode         = 'recent';

  // form toggle
  showLogin.onclick = e=>{ e.preventDefault(); registerForm.style.display='none'; loginForm.style.display='block'; };
  showRegister.onclick = e=>{ e.preventDefault(); loginForm.style.display='none'; registerForm.style.display='block'; };

  // register
  registerBtn.onclick = () => {
    const name  = regName.value.trim(),
          email = regEmail.value.trim(),
          pass  = regPass.value;
    if (!name || !email || !pass) return kcAlert('Fill all fields.');
    auth.createUserWithEmailAndPassword(email, pass)
      .then(uCred => 
        uCred.user.updateProfile({ displayName: name })
          .then(() => {
            return db.ref(`users/${uCred.user.uid}`).set({ 
              displayName: name, 
              email: email, 
              verified: uCred.user.emailVerified 
            }).then(() => uCred.user);
          })
      )
      .then(user => user.sendEmailVerification(actionCodeSettings))
      .then(() => kcAlert('Verification email sent! Check your inbox.'))
      .catch(err => kcAlert(err.message));
  };

  // login
  loginBtn.onclick = () =>{
    const e=loginEmail.value.trim(), p=loginPass.value;
    if(!e||!p) return kcAlert('Fill both fields.');
    auth.signInWithEmailAndPassword(e,p)
      .then(uCred => {
        if (!uCred.user.emailVerified) {
          return auth.signOut().then(()=>{ throw new Error('Please verify your email before logging in.'); });
        }
      })
      .catch(err => kcAlert(err.message));
  };

  // logout
  logoutBtn.onclick = ()=> auth.signOut();

  // emoji + gradient picker
  emojiEls.forEach(el=>{
    el.onclick = ()=>{
      emojiEls.forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      selectedEmoji = el.dataset.emoji;
      validatePost();
    };
  });
  gradEls.forEach(el=>{
    el.onclick = ()=>{
      gradEls.forEach(x=>x.classList.remove('selected'));
      el.classList.add('selected');
      selectedGradient = el.dataset.grad;
      validatePost();
    };
  });

  // post btn enable
  messageInput.oninput = validatePost;
  function validatePost(){
    postBtn.disabled = !(
      auth.currentUser &&
      auth.currentUser.emailVerified &&
      selectedEmoji &&
      selectedGradient &&
      messageInput.value.trim()
    );
  }

  // avatar cache
  const avatarCache = {};
  function getAvatar(uid){
    if(avatarCache[uid]) return Promise.resolve(avatarCache[uid]);
    return db.ref(`users/${uid}/avatar`).once('value').then(snap=>{
      const url = snap.val() || 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
      avatarCache[uid] = url;
      return url;
    });
  }

  // ===== VERIFIED USER NAVIGATION =====
  let verifiedUsers = [];
  let currentPopupIndex = -1;

  function fetchVerifiedUsers() {
    return db.ref('users').once('value').then(snap => {
      const arr = [];
      snap.forEach(child => {
        const val = child.val();
        if (val) { // show all users, not just verified
          arr.push({uid: child.key, displayName: val.displayName || ''});
        }
      });
      arr.sort((a,b) => (a.displayName||'').localeCompare(b.displayName||''));
      verifiedUsers = arr;
      return arr;
    }).catch(err => {
      console.error('Error fetching users', err);
      return [];
    });
  }

  function updateArrowVisibility() {
    const prevBtn = document.querySelector('#userPopup .prev-arrow');
    const nextBtn = document.querySelector('#userPopup .next-arrow');
    if (!prevBtn || !nextBtn) return;
    if (verifiedUsers.length > 1) {
      prevBtn.style.display = 'flex';
      nextBtn.style.display = 'flex';
    } else {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
    }
  }

  function showUserPopup(uid, skipFetch=false) {
    loadUserProfile(uid);
    document.getElementById('userPopup').style.display = 'flex';
    if (!skipFetch) {
      fetchVerifiedUsers().then(() => {
        currentPopupIndex = verifiedUsers.findIndex(u => u.uid === uid);
        if (currentPopupIndex < 0) currentPopupIndex = 0;
        updateArrowVisibility();
      });
    } else {
      updateArrowVisibility();
    }
  }

  function navigatePopup(dir) {
    if (verifiedUsers.length === 0 || currentPopupIndex === -1) return;
    currentPopupIndex = (currentPopupIndex + dir + verifiedUsers.length) % verifiedUsers.length;
    const {uid} = verifiedUsers[currentPopupIndex];
    showUserPopup(uid, true);
  }

  // Load user profile data into the new Discord-style popup
  function loadUserProfile(uid) {
      const popupCard = document.getElementById('userPopupCard');
      const bannerEl = document.getElementById('popupBanner');
      const avatarEl = document.getElementById('popupAvatar');
      const usernameEl = document.getElementById('popupUserName');
      const aboutEl = document.getElementById('popupAboutMe');
      const badgesContainer = document.getElementById('popupBadges');
      const streakEl = document.getElementById('popupStreak');
      const tooltip = document.getElementById('membershipTooltip');

      // Reset to loading state
      popupCard.style.background = '#f1f3f5';
      bannerEl.style.backgroundImage = 'none';
      bannerEl.style.backgroundColor = '#ced4da';
      avatarEl.src = 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
      usernameEl.textContent = 'Loading...';
      usernameEl.removeAttribute('data-member-type');
      aboutEl.textContent = 'Loading...';
      badgesContainer.innerHTML = 'Loading...';
      streakEl.style.display = 'none';

      // Fetch all user data
      db.ref(`users/${uid}`).once('value').then(snap => {
          const userData = snap.val() || {};
          
          usernameEl.textContent = userData.displayName || 'Anonymous User';
          avatarEl.src = userData.avatar || 'https://kevinmidnight7-sudo.github.io/messageboardkc/1.png';
          aboutEl.textContent = userData.aboutMe || 'No "About Me" has been set.';

          if (userData.loginStreak > 0) {
              streakEl.textContent = `üî• ${userData.loginStreak} Day Streak`;
              streakEl.style.display = 'block';
          } else {
              streakEl.style.display = 'none';
          }

          const custom = userData.profileCustomization || {};
          const defaultBg = '#f1f3f5';
          const cardBg = custom.gradient || defaultBg;
          
          popupCard.style.background = cardBg;
          avatarEl.style.borderColor = cardBg;
          usernameEl.style.color = custom.nameColor || '#111827';


          if (custom.banner) {
              bannerEl.style.backgroundImage = `url('${custom.banner}')`;
              bannerEl.style.backgroundColor = 'transparent';
          } else {
              bannerEl.style.backgroundImage = 'none';
              bannerEl.style.backgroundColor = '#ced4da';
          }
          
          // Check for membership codes
          const codes = userData.codesUnlocked || {};
          if (codes.diamond) {
              usernameEl.dataset.memberType = 'diamond';
          } else if (codes.emerald) {
              usernameEl.dataset.memberType = 'emerald';
          }


          // Fetch badge data
          Promise.all([
              db.ref(`badges/${uid}`).once('value'),
              db.ref(`users/${uid}/customBadges`).once('value')
          ]).then(([bsnap, csnap]) => {
              badgesContainer.innerHTML = '';
              let hasAnyBadge = false;
              const animations = ['wiggle', 'pulse', 'bounce'];

              const badgeSpecs = {
                  verified: { label: 'Verified', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/verified.png', bg: '#2dd4bf' },
                  offence: { label: 'Best Offence', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/red.png', bg: '#ff6b6b' },
                  defence: { label: 'Best Defence', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/blue.png', bg: '#74c0fc' },
                  overall: { label: 'Overall Winner', icon: 'https://kevinmidnight7-sudo.github.io/messageboardkc/kcevents.png', bg: '#f9c74f' }
              };

              const addBadge = (spec, text) => {
                hasAnyBadge = true;
                const div = document.createElement('div');
                div.className = 'popup-badge';
                div.style.background = spec.bg;
                div.innerHTML = `<img src="${spec.icon}"><span>${text}</span>`;
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                div.style.animation = `${randomAnimation} ${Math.random() * 2 + 1}s infinite`;
                badgesContainer.appendChild(div);
              }

              // Verified badge
              if (userData.verified) {
                  addBadge(badgeSpecs.verified, 'Verified');
              }

              // Core badges
              const baseBadges = bsnap.val() || {};
              ['offence', 'defence', 'overall'].forEach(key => {
                  if (baseBadges[key] > 0) {
                      addBadge(badgeSpecs[key], `${badgeSpecs[key].label} x${baseBadges[key]}`);
                  }
              });

              // Custom badges
              const customBadges = csnap.val() || {};
              Object.values(customBadges).forEach(badge => {
                  hasAnyBadge = true;
                  const div = document.createElement('div');
                  div.className = 'popup-badge';
                  div.style.background = badge.grad1 || '#6b7280';
                  div.style.color = badge.textColor || 'white';
                  div.innerHTML = `<span class="emoji-icon">${badge.icon}</span><span>${badge.name}</span>`;
                  const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                  div.style.animation = `${randomAnimation} ${Math.random() * 2 + 1}s infinite`;
                  badgesContainer.appendChild(div);
              });

              if (!hasAnyBadge) {
                  badgesContainer.textContent = 'No badges to display.';
              }
          });
      }).catch(error => {
          console.error("Error loading user profile:", error);
          usernameEl.textContent = 'Error loading profile';
      });
  }


  // Render and recurse functions
  function render(){
    if(!lastSnap) return;
    msgList.innerHTML = '';
    let arr = [];
    lastSnap.forEach(c=>{
      const v = c.val(); v.key=c.key;
      arr.push(v);
    });
    if(sortMode==='liked') arr.sort((a,b)=>(b.likes||0)-(a.likes||0));
    else arr.sort((a,b)=>b.time - a.time);
    if(!arr.length){
      const li=document.createElement('li');
      li.style.fontStyle='italic'; li.style.opacity='.7';
      li.textContent='No messages yet.'; 
      return msgList.appendChild(li);
    }
    arr.forEach(v=>{
      if(containsBadWord(v.user)||containsBadWord(v.text)) return;
      const d=new Date(v.time),
            ts=`${d.getUTCDate().toString().padStart(2,'0')}/`+
               `${(d.getUTCMonth()+1).toString().padStart(2,'0')}/`+
               `${d.getUTCFullYear().toString().slice(-2)} `+
               `${d.getUTCHours().toString().padStart(2,'0')}:`+
               `${d.getUTCMinutes().toString().padStart(2,'0')} GMT`;
      const li=document.createElement('li');
      li.className='message';
      li.dataset.path=`messages/${v.key}`;
      li.innerHTML=
        `<div class="emojiCell">${v.emoji}</div>
        <img class="avatarImg" data-uid="${v.uid}">
        <div class="content">
          <span class="username" data-uid="${v.uid}">${v.user}</span>
          : ${v.text}
          <span class="timestamp">${ts}</span>
          <button class="toggleReplies">${v.replies?'Show Replies':'No Replies'}</button>
          <ul class="replies"></ul>
          <div class="reactions"></div>
        </div>
        <div class="actions">
          <button class="likeBtn">‚ù§Ô∏è ${v.likes||0}</button>
          <button class="replyBtn">‚Ü©Ô∏è Reply</button>
          ${auth.currentUser&&auth.currentUser.uid===v.uid?'<button class="deleteBtn">üóëÔ∏è Delete</button>':''}
        </div>
      `;
      if (v.uid) getAvatar(v.uid).then(url => li.querySelector('.avatarImg').src = url);
      let nm=li.querySelector('.username');
       db.ref(`users/${v.uid}/profileCustomization/nameColor`).once('value').then(snap => {
          const color = snap.val();
          if (color) {
            nm.style.color = color;
          } else if(v.gradient){
            nm.style.backgroundImage=v.gradient;
            nm.style.webkitBackgroundClip='text';
            nm.style.backgroundClip='text';
            nm.style.color='transparent';
          } else { 
            nm.style.backgroundImage=''; 
            nm.style.color='#000'; 
          }
      });
      msgList.appendChild(li);
      let bar=li.querySelector('.reactions'), existing=v.reactions||{};
      Object.keys(existing).forEach(emo=>{
        let cnt=Object.keys(existing[emo]||{}).length,
            btn=document.createElement('div');
        btn.className='reactBtn';
        btn.dataset.path=`${li.dataset.path}/reactions/${emo}`;
        btn.dataset.emo=emo;
        btn.innerHTML=`${emo}<span>${cnt}</span>`;
        bar.appendChild(btn);
      });
      let add=document.createElement('div');
      add.className='addBtn'; add.textContent='‚ûï Add';
      bar.appendChild(add);
      if(v.replies){
        let replUL=li.querySelector('.replies');
        replUL.style.display='none';
        recurseReplies(v.replies,replUL,`messages/${v.key}`);
      }
    });
  }

  function recurseReplies(obj, ul, base){
    Object.entries(obj).forEach(([k,rv])=>{
      if(containsBadWord(rv.user)||containsBadWord(rv.text)) return;
      let d=new Date(rv.time),
          ts=`${d.getUTCDate().toString().padStart(2,'0')}/`+
             `${(d.getUTCMonth()+1).toString().padStart(2,'0')}/`+
             `${d.getUTCFullYear().toString().slice(-2)} `+
             `${d.getUTCHours().toString().padStart(2,'0')}:`+
             `${d.getUTCMinutes().toString().padStart(2,'0')} GMT`;
      let li=document.createElement('li');
      li.className='reply';
      li.dataset.path=`${base}/replies/${k}`;
      li.innerHTML=
        `<div class="emojiCell">${rv.emoji}</div>
        <img class="avatarImg" data-uid="${rv.uid}">
        <div class="content">
          <span class="username" data-uid="${rv.uid}">${rv.user}</span>
          : ${rv.text}
          <span class="timestamp">${ts}</span>
          <button class="toggleReplies">${rv.replies?'Show Replies':''}</button>
          <ul class="replies"></ul>
        </div>
      `;
      if (rv.uid) getAvatar(rv.uid).then(url => li.querySelector('.avatarImg').src = url);
      let nm=li.querySelector('.username');
       db.ref(`users/${rv.uid}/profileCustomization/nameColor`).once('value').then(snap => {
          const color = snap.val();
          if (color) {
            nm.style.color = color;
          } else if(rv.gradient){
            nm.style.backgroundImage=rv.gradient;
            nm.style.webkitBackgroundClip='text';
            nm.style.backgroundClip='text';
            nm.style.color='transparent';
          } else { 
            nm.style.backgroundImage=''; 
            nm.style.color='#000'; 
          }
      });
      ul.appendChild(li);
      if(rv.replies){
        let child=li.querySelector('.replies');
        child.style.display='none';
        recurseReplies(rv.replies,child,`${base}/replies/${k}`);
      }
    });
  }

  // click handlers
  document.body.addEventListener('click', e=>{
    const u=auth.currentUser;
    if(e.target.matches('.avatarImg, .username')) {
      const uid = e.target.dataset.uid;
      if(uid) showUserPopup(uid);
      return;
    }
    if(e.target.matches('.toggleReplies')){
      let btn=e.target,
          UL=btn.parentNode.querySelector('.replies');
      if(!UL) return;
      UL.style.display = UL.style.display==='block'?'none':'block';
      btn.textContent = UL.style.display==='block'?'Hide Replies':'Show Replies';
      return;
    }
    if (e.target.closest('.likeBtn')) {
      if (!u || !u.emailVerified) return kcAlert('Log in and verify to like.');
      const btn  = e.target.closest('.likeBtn');
      const path = btn.closest('li').dataset.path;
      db.ref(`${path}/likedBy/${u.uid}`)
        .transaction(cur => cur === null ? true : undefined,
          (err, committed) => {
            if (err) return kcAlert('Error liking.');
            if (!committed) return kcAlert('You already liked.');
            db.ref(`${path}/likes`).transaction(n => (n||0) + 1);
          }
        );
      return;
    }
    if(e.target.closest('.reactBtn')){
      if(!u || !u.emailVerified) return kcAlert('Log in and verify to react.');
      let btn=e.target.closest('.reactBtn'), p=btn.dataset.path;
      let lastClick = btn.dataset.lastClick ? parseInt(btn.dataset.lastClick) : 0;
      let now = Date.now();
      btn.dataset.lastClick = now;
      if (now - lastClick < 300) {
        db.ref(p+`/${u.uid}`).remove();
      } else {
        db.ref(p+`/${u.uid}`).set(true);
      }
      return;
    }
    if(e.target.matches('.addBtn')){
      if(!u || !u.emailVerified) return kcAlert('Log in and verify to react.');
      let li=e.target.closest('li'), p=li.dataset.path, bar=li.querySelector('.reactions'),
          exist=Array.from(bar.querySelectorAll('.reactBtn')).map(x=>x.dataset.emo), picker=document.createElement('div');
      picker.className='addPicker';
      ['üòÄ','üòé','üòÇ','üòç','üëç','üôå','üòâ','üòÅ','üò¢','üòÆ','üò°','üéâ','ü§£','üò≠','ü•π','ü•∞','üëÄ','ü´∂','üî•','üî•']
        .filter(emo=>!exist.includes(emo))
        .forEach(emo=>{
          let s=document.createElement('span');
          s.className='emoji'; s.textContent=emo;
          s.onclick=()=>{
            db.ref(`${p}/reactions/${emo}/${u.uid}`).set(true, err=>{ if(err) kcAlert('Error adding reaction.') });
            picker.remove();
          };
          picker.appendChild(s);
        });
      bar.appendChild(picker);
      return;
    }
    if(e.target.closest('.replyBtn')){
      if(!u || !u.emailVerified) return kcAlert('Log in and verify to reply.');
      let li=e.target.closest('li'), p=li.dataset.path+'/replies';
      if(li.nextElementSibling?.classList.contains('reply-row')) return;
      let row=document.createElement('li'); row.className='reply-row';
      let f=document.createElement('div'); f.className='reply-form';
      f.innerHTML=`<input placeholder="Reply..." maxlength="200"/><button>Send</button>`;
      row.appendChild(f);
      li.after(row);
      f.querySelector('button').onclick=()=>{
        let txt=f.querySelector('input').value.trim();
        if(!selectedEmoji) return kcAlert('Pick an emoji.');
        if(!txt) return kcAlert('Enter reply.');
        if(containsBadWord(txt)) return kcAlert('That word‚Äôs not allowed.');
        db.ref(p).push({
          user:u.displayName, uid:u.uid,
          text:txt, emoji:selectedEmoji,
          time:firebase.database.ServerValue.TIMESTAMP,
          likes:0, gradient:selectedGradient
        });
      };
      return;
    }
    if(e.target.closest('.deleteBtn')){
      let p=e.target.closest('li').dataset.path;
      kcConfirm('Delete this message and its replies?', function(confirmed){
        if(confirmed) db.ref(p).remove();
      });
      return;
    }
  });

  // unlike on double click
  document.body.addEventListener('dblclick', e => {
    const btn = e.target.closest('.likeBtn');
    const u   = auth.currentUser;
    if (!btn || !u || !u.emailVerified) return;
    const path = btn.closest('li').dataset.path;
    db.ref(`${path}/likedBy/${u.uid}`).remove()
      .then(() => db.ref(`${path}/likes`).transaction(current => Math.max(0, (current||0) - 1)))
      .catch(err => kcAlert('Error unliking: ' + err.message));
  });

  // posting
  postBtn.onclick = ()=>{
    let u=auth.currentUser, txt=messageInput.value.trim();
    if(!u || !u.emailVerified) return kcAlert('Log in and verify to post.');
    if(!selectedEmoji) return kcAlert('Pick an emoji.');
    if(!selectedGradient) return kcAlert('Pick a gradient.');
    if(!txt) return kcAlert('Enter a message.');
    if(containsBadWord(txt)||containsBadWord(u.displayName))
      return kcAlert('That word‚Äôs not allowed.');
    let ref=msgs.push();
    ref.set({
      user:u.displayName, uid:u.uid,
      text:txt, emoji:selectedEmoji,
      time:firebase.database.ServerValue.TIMESTAMP,
      likes:0, gradient:selectedGradient
    });
    messageInput.value=''; validatePost();
  };

  // real-time messages
  msgs.on('value',snap=>{
    lastSnap=snap; render();
  });

  sortSelect.onchange = ()=>{
    sortMode=sortSelect.value; render();
  };

  auth.onAuthStateChanged(u => {
    if (u) {
      u.reload().then(() => {
        db.ref(`users/${u.uid}/verified`).set(u.emailVerified);
        registerForm.style.display = 'none';
        loginForm.style.display = 'none';
        logoutBtn.style.display = 'block';
        validatePost();
      });
    } else {
      registerForm.style.display = 'block';
      loginForm.style.display = 'none';
      logoutBtn.style.display = 'none';
      validatePost();
    }
  });

  // attach nav arrow and close listeners
  document.querySelector('#userPopup .prev-arrow').addEventListener('click', () => navigatePopup(-1));
  document.querySelector('#userPopup .next-arrow').addEventListener('click', () => navigatePopup(1));
  document.getElementById('closeUserPopup').addEventListener('click', () => {
    document.getElementById('userPopup').style.display = 'none';
  });
  
  // Tooltip logic
  const usernameEl = document.getElementById('popupUserName');
  const tooltip = document.getElementById('membershipTooltip');
  
  usernameEl.addEventListener('mouseenter', () => {
    const memberType = usernameEl.dataset.memberType;
    if (!memberType) return;

    let icon = '';
    let text = '';

    if (memberType === 'diamond') {
        icon = 'https://cdn.discordapp.com/emojis/1381097369474695178.webp?size=128';
        text = 'Diamond Member';
    } else if (memberType === 'emerald') {
        icon = 'https://cdn.discordapp.com/emojis/1381097372930543776.webp?size=128';
        text = 'Emerald Member';
    } else {
        return;
    }

    tooltip.innerHTML = `<img src="${icon}" alt="${text} icon"><span>${text}</span>`;
    
    const nameRect = usernameEl.getBoundingClientRect();
    const cardRect = document.getElementById('userPopupCard').getBoundingClientRect();

    tooltip.style.top = `${nameRect.top - cardRect.top - tooltip.offsetHeight - 8}px`;
    tooltip.style.left = `${nameRect.left - cardRect.left + (nameRect.width / 2) - (tooltip.offsetWidth / 2)}px`;

    tooltip.classList.add('visible');
  });

  usernameEl.addEventListener('mouseleave', () => {
      tooltip.classList.remove('visible');
  });


  </script>
</body>
</html>
